<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Análisis de Rendimiento - GrapeIQ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Montserrat',sans-serif; background:#F8F7F4; }
    .wine-grad{ background-image:linear-gradient(to right,#5C1A33,#8C2B4F); }
    .kpi-value{ font-size:2.25rem; line-height:2.5rem; font-weight:700; }
    .kpi-trend-positive{ color:#16a34a; } .kpi-trend-negative{ color:#dc2626; }
    .tab-active{ border-color:#5C1A33; color:#5C1A33; font-weight:700; }
  </style>
</head>
<body class="text-stone-800">
  <div class="p-4 sm:p-8">
    <header class="flex justify-between items-center mb-6">
      <div class="flex items-center gap-4">
        <a href="performance.html" class="flex items-center gap-4">
          <img src="assets/GrapeIQ.png" alt="GrapeIQ Logo" class="h-10">
          <span class="text-3xl font-light text-stone-400">|</span>
          <h1 class="text-3xl font-semibold text-stone-700">Análisis de Rendimiento</h1>
        </a>
      </div>
      <button id="logout-btn" class="bg-stone-700 text-white px-6 py-2 rounded-full font-semibold hover:bg-stone-800">Cerrar Sesión</button>
    </header>

    <div class="mb-6 border-b border-stone-200">
      <nav class="flex space-x-8" aria-label="Tabs">
         <a href="performance.html" class="px-1 py-4 border-b-2 font-semibold text-lg border-transparent tab-active" data-tab="performance">Análisis de Rendimiento</a>
        <a href="forecast.html"   class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent" data-tab="forecast">Predicciones y Escenarios</a>
        <a href="catalog.html"     id="menu-catalogo" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent" data-tab="catalog">Catálogo y Stock</a>
        <a href="daily-log.html"   id="menu-registro-diario" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent" data-tab="daily-log">Registro Diario</a>
        <a href="financials.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Finanzas</a>
        <a href="field_log.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Cuaderno de Campo</a>
        <a href="traceability.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Trazabilidad</a>
        <a href="cellar_management.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Gestión de Bodega</a>
        <a href="parcels.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Parcelas</a>
        <a href="weather.html"     class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent" data-tab="weather">Clima</a>
        <a href="settings.html"    class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent" data-tab="settings">Configuración</a>
      </nav>
    </div>

    <main>
      <div class="space-y-10">

        <div>
          <h2 class="text-2xl font-bold text-stone-700 mb-4">Pulso del Negocio</h2>
          <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6">
            <div class="bg-white p-6 rounded-2xl shadow-lg">
              <h3 class="font-semibold text-stone-500 mb-2">Ingresos Totales</h3>
              <p id="kpi-total-sales" class="kpi-value text-stone-800">Cargando...</p>
              <p id="kpi-mom-change" class="font-semibold text-sm mt-1">Cargando...</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg">
              <h3 class="font-semibold text-stone-500 mb-2">Beneficio Bruto</h3>
              <p id="kpi-total-profit" class="kpi-value text-green-700">Cargando...</p>
              <p class="text-sm text-stone-400 mt-1">Ingresos - Costes</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg">
              <h3 class="font-semibold text-stone-500 mb-2">Margen Bruto</h3>
              <p id="kpi-gross-margin" class="kpi-value text-stone-800">Cargando...</p>
              <p class="text-sm text-stone-400 mt-1">Beneficio / Ingresos</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg">
              <h3 class="font-semibold text-stone-500 mb-2">Botellas Vendidas</h3>
              <p id="kpi-total-quantity" class="kpi-value text-stone-800">Cargando...</p>
              <p class="text-sm text-stone-400 mt-1">Total unidades</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg">
              <h3 class="font-semibold text-stone-500 mb-2">Clientes Únicos</h3>
               <p id="kpi-unique-customers" class="kpi-value text-stone-800">Cargando...</p>
              <p class="text-sm text-stone-400 mt-1">Este año</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg">
              <h3 class="font-semibold text-stone-500 mb-2">Venta Media</h3>
              <p id="kpi-avg-sale" class="kpi-value text-stone-800">Cargando...</p>
              <p class="text-sm text-stone-400 mt-1">Por transacción</p>
            </div>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-lg mt-6">
            <h3 class="text-xl font-bold text-stone-800 mb-4">Buscar Ventas por SKU</h3>
            <div class="flex flex-wrap items-center gap-4">
              <input type="text" id="sku-search-input" placeholder="Introduce un SKU..." class="flex-grow w-full sm:w-auto max-w-sm px-4 py-2 border border-stone-300 rounded-full focus:outline-none focus:ring-2 focus:ring-[#5C1A33]">
              <select id="month-filter-select" class="px-4 py-2 border border-stone-300 rounded-full bg-white focus:outline-none focus:ring-2 focus:ring-[#5C1A33]">
                </select>
            </div>
            <p id="sku-search-result" class="mt-4 text-lg font-semibold h-6"></p>
          </div>
        </div>

        <div>
          <h2 class="text-2xl font-bold text-stone-700 mb-4">Análisis Táctico y Operativo</h2>
          <div class="bg-white p-6 rounded-2xl shadow-lg mb-6">
            <div id="monthlySalesChartContainer" class="h-80 w-full"><canvas id="monthlySalesChart"></canvas></div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-2xl shadow-lg">
              <h3 class="text-xl font-bold text-stone-800 mb-4">Ventas por Día de la Semana</h3>
              <div id="weekday-heatmap" class="grid grid-cols-7 gap-2 text-center"></div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg">
               <div id="salesByChannelChartContainer" class="h-80 w-full"><canvas id="salesByChannelChart"></canvas></div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg">
              <div id="topProductsByUnitsChartContainer" class="h-80 w-full"><canvas id="topProductsByUnitsChart"></canvas></div>
            </div>
          </div>
        </div>

        <div>
          <h2 class="text-2xl font-bold text-stone-700 mb-4">Análisis Estratégico</h2>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white p-6 rounded-2xl shadow-lg">
              <h3 class="text-xl font-bold text-stone-800 mb-4">Matriz de Rendimiento de Producto</h3>
              <div id="productPerformanceMatrixContainer" class="h-96 w-full"><canvas id="productPerformanceMatrixChart"></canvas></div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg">
              <div id="topProfitableProductsChartContainer" class="h-96 w-full"><canvas id="topProfitableProductsChart"></canvas></div>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <script>
    // --- Configuración y Autenticación ---
    const API_BASE_URL = 'http://127.0.0.1:8000';
    const TOKEN_KEY = 'accessToken';
    const ROLE_KEY = 'userRole';

    function requireAuth(){ if(!localStorage.getItem(TOKEN_KEY)) window.location.href='login.html'; }
    function logout(){ 
        localStorage.removeItem(TOKEN_KEY); 
        localStorage.removeItem(ROLE_KEY);
        window.location.href='login.html'; 
    }
    document.getElementById('logout-btn').addEventListener('click', logout);

    async function apiFetch(endpoint, options = {}) {
        const headers = { 'Content-Type': 'application/json' };
        const token = localStorage.getItem(TOKEN_KEY);
        if (token) headers['Authorization'] = `Bearer ${token}`;
        
        const resp = await fetch(`${API_BASE_URL}${endpoint}`, { ...options, headers });
        
        if (resp.status === 401) { logout(); throw new Error('Sesión expirada.'); }
        if (!resp.ok) {
            const errData = await resp.json().catch(() => ({ detail: 'Error desconocido en la API.' }));
            throw new Error(errData.detail);
        }
        return resp.json();
    }
    
    // --- Utils & Renderizado de Gráficos ---
    const charts = {};
    function formatCurrency(v){ return `€${(v || 0).toLocaleString('es-ES',{minimumFractionDigits:2, maximumFractionDigits:2})}`; }
    function formatNumber(v){ return (v || 0).toLocaleString('es-ES'); }

    function renderChart(chartId, existingChart, type, data, options){
      const container = document.getElementById(chartId+'Container');
      if (!container) return null;
      if (!data || !data.datasets || data.datasets.some(ds => !ds.data || ds.data.length === 0)) {
        if (existingChart) existingChart.destroy();
        container.innerHTML = `<div class="flex items-center justify-center h-full text-stone-500 font-semibold"><p>No hay datos disponibles.</p></div>`;
        return null;
      }
      container.innerHTML = `<canvas id="${chartId}"></canvas>`;
      const ctx = document.getElementById(chartId).getContext('2d');
      if (existingChart) existingChart.destroy();
      return new Chart(ctx, { type, data, options });
    }

    // --- Referencias al DOM ---
    const DOM = {
      kpiSales: document.getElementById('kpi-total-sales'),
      kpiProfit: document.getElementById('kpi-total-profit'),
      kpiGrossMargin: document.getElementById('kpi-gross-margin'),
      kpiQuantity: document.getElementById('kpi-total-quantity'),
      kpiUniqueCustomers: document.getElementById('kpi-unique-customers'),
      kpiAvgSale: document.getElementById('kpi-avg-sale'),
      kpiMomChange: document.getElementById('kpi-mom-change'),
      skuSearchInput: document.getElementById('sku-search-input'),
      skuSearchResult: document.getElementById('sku-search-result'),
      weekdayHeatmap: document.getElementById('weekday-heatmap'),
      monthFilterSelect: document.getElementById('month-filter-select'), // NUEVO
    };

    function updateMomChange(change){
      const el = DOM.kpiMomChange;
      if (change === null || isNaN(change)) { el.innerHTML = '<span class="text-stone-400">Datos insuficientes</span>'; return; }
      const pos = change >= 0; const cls = pos ? 'kpi-trend-positive':'kpi-trend-negative'; const icon= pos?'▲':'▼';
      el.innerHTML = `<span class="${cls}">${icon} ${Math.abs(change).toFixed(1)}%</span> vs. mes anterior`;
    }

    // --- Carga y Renderizado de Datos ---
    async function loadPerformanceData(){
      try {
        const kpis = await apiFetch('/api/analytics/kpis-summary');
        DOM.kpiSales.textContent = formatCurrency(kpis.TotalSale);
        DOM.kpiProfit.textContent = formatCurrency(kpis.Profit);
        DOM.kpiGrossMargin.textContent = `${((kpis.Profit / kpis.TotalSale) * 100 || 0).toFixed(1)}%`;
        DOM.kpiQuantity.textContent = formatNumber(kpis.Quantity);
        DOM.kpiUniqueCustomers.textContent = formatNumber(kpis.UniqueCustomers);
        DOM.kpiAvgSale.textContent = formatCurrency(kpis.AverageSaleValue);
        updateMomChange(kpis.MonthOverMonthChange);

        const [monthlySales, topProfit, topUnits, byWeekday, matrixData] = await Promise.all([
          apiFetch('/api/analytics/monthly-sales'),
          apiFetch('/api/analytics/top-profitable-products'),
          apiFetch('/api/analytics/top-units-products'),
          apiFetch('/api/analytics/sales-by-weekday'),
          apiFetch('/api/analytics/product-performance-matrix'),
        ]);

        renderMonthlySalesChart(monthlySales);
        renderTopProfitableProductsChart(topProfit);
        renderTopProductsByUnitsChart(topUnits);
        renderWeekdayHeatmap(byWeekday);
        renderSalesByChannelChart(null);
        renderProductPerformanceMatrixChart(matrixData);

      } catch(e) { 
        console.error('Error al cargar datos de rendimiento:', e);
        alert(`Error al cargar los datos del panel: ${e.message}`);
      }
    }
    
    // --- NUEVA FUNCIÓN para poblar el filtro de meses ---
    async function populateMonthFilter() {
        try {
            const months = await apiFetch('/api/analytics/available-months');
            const select = DOM.monthFilterSelect;
            select.innerHTML = '<option value="all">Total Histórico</option>'; // Opción por defecto
            months.forEach(month => {
                // Formateamos la fecha para mostrarla en español
                const date = new Date(month + '-02');
                const formattedMonth = date.toLocaleString('es-ES', { month: 'long', year: 'numeric' });
                select.innerHTML += `<option value="${month}">${formattedMonth.charAt(0).toUpperCase() + formattedMonth.slice(1)}</option>`;
            });
        } catch (e) {
            console.error('Error al cargar los meses para el filtro:', e);
            DOM.monthFilterSelect.innerHTML = '<option value="all">Error al cargar meses</option>';
        }
    }

    // --- FUNCIÓN MODIFICADA para la búsqueda de SKU ---
    let skuSearchTimeout;
    async function handleSkuSearch(){
      const sku = DOM.skuSearchInput.value.trim();
      const selectedMonth = DOM.monthFilterSelect.value;
      DOM.skuSearchResult.innerHTML = ''; // Limpiar resultado anterior
      if (!sku) return;

      let endpoint = `/api/analytics/sales/by_sku/${sku}`;
      if (selectedMonth !== 'all') {
          endpoint += `?month=${selectedMonth}`;
      }

      try{
        const data = await apiFetch(endpoint);
        const periodText = selectedMonth === 'all' 
            ? ' (Total)' 
            : ` (${DOM.monthFilterSelect.options[DOM.monthFilterSelect.selectedIndex].text})`;
            
        DOM.skuSearchResult.innerHTML = `<span class="text-stone-600">${data.product_name}${periodText}:</span> <span class="text-green-700 font-bold">${formatCurrency(data.total_sales)}</span>`;
      } catch(err) {
        DOM.skuSearchResult.innerHTML = `<span class="text-red-600">SKU no encontrado o sin ventas en este periodo.</span>`;
      }
    }
    
    // --- Event Listeners para la búsqueda ---
    DOM.skuSearchInput.addEventListener('input', () => {
      clearTimeout(skuSearchTimeout);
      skuSearchTimeout = setTimeout(handleSkuSearch, 300);
    });
    DOM.monthFilterSelect.addEventListener('change', handleSkuSearch);

    // --- Funciones de renderizado de gráficos (sin cambios) ---
    function renderMonthlySalesChart(data){
        const chartData = {
            labels: data.map(d => new Date(d.Month + '-02').toLocaleString('es-ES', { month: 'short', year: '2-digit' })),
            datasets: [{ label: 'Ingresos Mensuales', data: data.map(d => d.TotalSale),
            borderColor: '#5C1A33', backgroundColor: 'rgba(92,26,51,0.1)', fill: true, tension: 0.4 }]
        };
        charts.monthlySales = renderChart('monthlySalesChart', charts.monthlySales, 'line', chartData, { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: 'Evolución de Ingresos Mensuales (€)', font: { size: 18, weight: 'bold' } } }, scales: { y: { beginAtZero: true } } });
    }
    function renderTopProfitableProductsChart(data){
        const chartData = {
            labels: data.map(p => p.ProductName),
            datasets: [{ axis: 'y', label: 'Beneficio Total (€)', data: data.map(p => p.Profit),
            backgroundColor: 'rgba(22,163,74,0.7)', borderColor: 'rgba(22,163,74,1)', borderWidth: 1, borderRadius: 6 }]
        };
        charts.topProfit = renderChart('topProfitableProductsChart', charts.topProfit, 'bar', chartData, { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: 'Top Productos Más Rentables', font: { size: 18, weight: 'bold' } } } });
    }
    function renderTopProductsByUnitsChart(data){
        const chartData = {
            labels: data.map(p => p.SKU),
            datasets: [{ label: 'Unidades Vendidas', data: data.map(p => p.Quantity),
            backgroundColor: 'rgba(59,130,246,0.7)', borderColor: 'rgba(59,130,246,1)', borderWidth: 1, borderRadius: 6 }]
        };
        charts.topUnits = renderChart('topProductsByUnitsChart', charts.topUnits, 'bar', chartData, { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: 'Top Productos por Unidades Vendidas', font: { size: 18, weight: 'bold' } } }, scales: { y: { beginAtZero: true } } });
    }
    function renderWeekdayHeatmap(data){
        const container = DOM.weekdayHeatmap; container.innerHTML='';
        const weekdays = ['Lunes','Martes','Miércoles','Jueves','Viernes','Sábado','Domingo'];
        const salesByDay = new Array(7).fill(0);
        if (Array.isArray(data)) data.forEach(d => { salesByDay[d.weekday_num - 1] = d.total_sales; });
        const maxSales = Math.max(...salesByDay, 1);
        weekdays.forEach((day,i)=>{
            const sales = salesByDay[i]; const intensity = sales / maxSales; const light = 90 - (intensity * 50);
            const bg = `hsl(340, 65%, ${light}%)`;
            container.innerHTML += `<div class="p-2 rounded-lg" style="background-color:${bg};"><p class="font-bold text-sm">${day.substring(0,3)}</p><p class="text-xs font-semibold text-stone-700">${formatCurrency(sales)}</p></div>`;
        });
    }
    function renderSalesByChannelChart(data){
        const dummyData = [{channel:'Distribuidor', total_sales: 85000},{channel:'Venta Directa', total_sales: 62000},{channel:'HORECA', total_sales: 38430}];
        const chartData = {
            labels: dummyData.map(i=>i.channel),
            datasets:[{ data: dummyData.map(i=>i.total_sales), backgroundColor:['rgba(92,26,51,0.8)','rgba(140,43,79,0.8)','rgba(180,80,110,0.8)'], borderColor:'#FFFFFF', borderWidth:4 }]
        };
        charts.channel = renderChart('salesByChannelChart', charts.channel,'doughnut', chartData, { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'top', labels:{ font:{ weight:'bold'}} }, title:{ display:true, text:'Ventas por Canal (Simulado)', font:{ weight:'bold', size:18 }}}});
    }
    function renderProductPerformanceMatrixChart(data){
        const chartData = {
            labels: data.map(p => p.ProductName),
            datasets: [
            { label:'Beneficio Total (€)', data: data.map(p => p.Profit), backgroundColor:'rgba(92,26,51,0.7)', yAxisID: 'y' },
            { label:'Unidades Vendidas', data: data.map(p => p.Quantity), backgroundColor:'rgba(59,130,246,0.7)', yAxisID: 'y1' }
            ]
        };
        charts.productMatrix = renderChart('productPerformanceMatrixChart', charts.productMatrix, 'bar', chartData, { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'top' }, title:{ display:true, text:'Rendimiento por Producto (Beneficio vs Unidades)', font:{ size:18, weight:'bold'} }, tooltip:{ mode:'index', intersect:false }}, scales: { y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Beneficio (€)' } }, y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'Unidades' } }, }});
    }


    // --- Ejecución al Cargar la Página ---
    document.addEventListener('DOMContentLoaded', () => {
        requireAuth();
        // Carga los datos principales y, en paralelo, llena el desplegable de meses
        loadPerformanceData(); 
        populateMonthFilter();
    });
  </script>
</body>
</html>