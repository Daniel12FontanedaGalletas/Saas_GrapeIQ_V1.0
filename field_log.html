<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Cuaderno de Campo - GrapeIQ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Paleta de Colores Otoñales */
        :root {
            --naranja-calabaza: #D96C06;
            --rojo-arcilla: #A23E48;
            --ocre-dorado: #C98C32;
            --verde-olivo: #6B705C;
            --marron-castana: #5C4033;
            --beige-calido: #F2E2C4;
        }
        body { font-family:'Montserrat',sans-serif; background-color: var(--beige-calido); }
        .header-title { color: var(--marron-castana); }
        .section-card { background-color: rgba(255,255,255,0.6); border: 1px solid rgba(0,0,0,0.05); }
        .tab-active{ border-color: var(--marron-castana); color: var(--marron-castana); font-weight:700; }
        
        /* Estilos de FullCalendar */
        .fc-event { cursor: pointer; background-color: var(--naranja-calabaza); border-color: var(--naranja-calabaza); }
        .fc-daygrid-day.fc-day-today { background-color: rgba(201, 140, 50, 0.15); }
        .fc .fc-button-primary { background-color: var(--marron-castana); border-color: var(--marron-castana); }
        .fc .fc-button-primary:hover { background-color: #4a1529; border-color: #4a1529; }
        
        .modal { display: none; }
        .modal-active { display: flex; }
        .time-input-hidden { display: none; }
    </style>
</head>
<body class="text-stone-800">
    <div class="p-4 sm:p-8">
        <header class="flex justify-between items-center mb-6">
            <a href="performance.html" class="flex items-center gap-4">
                <img src="assets/GrapeIQ.png" alt="GrapeIQ Logo" class="h-10">
                <span class="text-3xl font-light text-stone-400">|</span>
                <h1 class="text-3xl font-semibold header-title">Cuaderno de Campo</h1>
            </a>
            <button id="logout-btn" style="background-color: var(--marron-castana);" class="text-white px-6 py-2 rounded-full font-semibold hover:opacity-90">Cerrar Sesión</button>
        </header>

        <div class="mb-6 border-b border-stone-300">
            <nav class="flex space-x-8 overflow-x-auto pb-2" aria-label="Tabs">
                <a href="performance.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Análisis de Rendimiento</a>
                <a href="forecast.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Predicciones</a>
                <a href="catalog.html" id="menu-catalogo" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Catálogo y Stock</a>
                <a href="daily-log.html" id="menu-registro-diario" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Registro Diario</a>
                <a href="financials.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Finanzas</a>
                <a href="field_log.html" class="px-1 py-4 border-b-2 font-semibold text-lg tab-active">Cuaderno de Campo</a>
                <a href="traceability.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Trazabilidad</a>
                <a href="cellar_management.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Gestión de Bodega</a>
                <a href="parcels.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Parcelas</a>
                <a href="weather.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Clima</a>
                <a href="settings.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Configuración</a>
            </nav>
        </div>

        <main class="space-y-8">
            <div class="section-card p-6 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold header-title">Registro de Actividades</h2>
                    <button id="add-log-btn" style="background-color: var(--marron-castana);" class="text-white px-5 py-2 rounded-full font-semibold hover:opacity-90">Añadir Nueva Entrada</button>
                </div>
                <div id='calendar'></div>
            </div>
            
            <div class="section-card p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold header-title mb-4">Generar Informe</h2>
                <div class="flex flex-col sm:flex-row items-center gap-4">
                    <div>
                        <label for="start-date" class="block text-sm font-medium text-stone-600 mb-1">Fecha de Inicio</label>
                        <input type="date" id="start-date" class="px-4 py-2 border border-stone-300 rounded-lg">
                    </div>
                    <div>
                        <label for="end-date" class="block text-sm font-medium text-stone-600 mb-1">Fecha de Fin</label>
                        <input type="date" id="end-date" class="px-4 py-2 border border-stone-300 rounded-lg">
                    </div>
                    <div class="flex gap-2 mt-auto">
                        <button id="export-csv-btn" style="background-color: var(--verde-olivo);" class="text-white px-5 py-2 rounded-full font-semibold hover:opacity-90">Exportar a CSV</button>
                        <button id="export-pdf-btn" style="background-color: var(--rojo-arcilla);" class="text-white px-5 py-2 rounded-full font-semibold hover:opacity-90">Exportar a PDF</button>
                    </div>
                </div>
                <p id="export-error" class="text-red-500 text-sm mt-2 h-4"></p>
            </div>
        </main>
    </div>

    <div id="log-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md m-4">
            <h3 id="modal-title" class="text-2xl font-bold header-title mb-6">Nueva Entrada</h3>
            <form id="log-form">
                <input type="hidden" id="log-id">
                <div class="space-y-4">
                    <div>
                        <label for="log_date" class="block text-sm font-medium text-stone-600 mb-1">Fecha</label>
                        <input type="date" id="log_date" name="log_date" required class="w-full px-4 py-2 border border-stone-300 rounded-lg">
                    </div>
                    <div>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="specify-time-checkbox" class="rounded" style="border-color: var(--ocre-dorado); color: var(--marron-castana);">
                            Especificar hora (si no, se considera todo el día)
                        </label>
                    </div>
                    <div id="time-input-container" class="time-input-hidden grid grid-cols-2 gap-4">
                        <div>
                            <label for="start_time" class="block text-sm font-medium text-stone-600 mb-1">Hora Inicio</label>
                            <input type="time" id="start_time" name="start_time" class="w-full px-4 py-2 border border-stone-300 rounded-lg">
                        </div>
                        <div>
                            <label for="end_time" class="block text-sm font-medium text-stone-600 mb-1">Hora Fin</label>
                            <input type="time" id="end_time" name="end_time" class="w-full px-4 py-2 border border-stone-300 rounded-lg">
                        </div>
                    </div>
                    <div>
                        <label for="activity_type" class="block text-sm font-medium text-stone-600 mb-1">Tipo de Actividad</label>
                        <select id="activity_type" name="activity_type" required class="w-full px-4 py-2 border border-stone-300 rounded-lg">
                            <option value="Poda">Poda</option>
                            <option value="Riego">Riego</option>
                            <option value="Tratamiento Fitosanitario">Tratamiento Fitosanitario</option>
                            <option value="Abonado">Abonado</option>
                            <option value="Vendimia">Vendimia</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    <div>
                        <label for="parcel_id" class="block text-sm font-medium text-stone-600 mb-1">Parcela (Opcional)</label>
                        <select id="parcel_id" name="parcel_id" class="w-full px-4 py-2 border border-stone-300 rounded-lg"></select>
                    </div>
                    <div>
                        <label for="description" class="block text-sm font-medium text-stone-600 mb-1">Descripción</label>
                        <textarea id="description" name="description" rows="3" class="w-full px-4 py-2 border border-stone-300 rounded-lg"></textarea>
                    </div>
                </div>
                <div class="flex justify-between items-center mt-8">
                    <button type="button" id="delete-log-btn" style="background-color: var(--rojo-arcilla);" class="text-white px-5 py-2 rounded-full font-semibold hover:opacity-90 hidden">Eliminar</button>
                    <div class="flex gap-4 ml-auto">
                        <button type="button" id="close-modal-btn" class="bg-stone-200 text-stone-800 px-5 py-2 rounded-full font-semibold">Cancelar</button>
                        <button type="submit" style="background-color: var(--marron-castana);" class="text-white px-5 py-2 rounded-full font-semibold">Guardar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000';
        const TOKEN_KEY = 'accessToken';

        async function apiFetch(endpoint, options = {}, expectJson = true) {
            if (!endpoint.endsWith('/')) { endpoint += '/'; }
            const headers = { ...options.headers };
            const token = localStorage.getItem(TOKEN_KEY);
            if (token) headers['Authorization'] = `Bearer ${token}`;
            if (options.body && typeof options.body !== 'string' && !(options.body instanceof FormData)) {
                headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(options.body);
            }
            
            try {
                const resp = await fetch(`${API_BASE_URL}${endpoint}`, { ...options, headers });
                if (resp.status === 401) { logout(); throw new Error('Sesión expirada.'); }
                if (resp.status === 204) return;
                if (!resp.ok) {
                    const data = await resp.json().catch(() => ({ detail: 'Error en la petición.' }));
                    throw new Error(data.detail);
                }
                return expectJson ? resp.json() : resp.blob();
            } catch (error) {
                console.error(`Error en apiFetch a ${endpoint}:`, error);
                throw error;
            }
        }
        
        function requireAuth() { if (!localStorage.getItem(TOKEN_KEY)) window.location.href = 'login.html'; }
        function logout() { localStorage.removeItem(TOKEN_KEY); window.location.href = 'login.html'; }
        document.getElementById('logout-btn').addEventListener('click', logout);

        document.addEventListener('DOMContentLoaded', () => {
            requireAuth();
            
            const modal = document.getElementById('log-modal');
            const addLogBtn = document.getElementById('add-log-btn');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const logForm = document.getElementById('log-form');
            const modalTitle = document.getElementById('modal-title');
            const specifyTimeCheckbox = document.getElementById('specify-time-checkbox');
            const timeInputContainer = document.getElementById('time-input-container');
            const deleteLogBtn = document.getElementById('delete-log-btn');
            const parcelSelect = document.getElementById('parcel_id');
            let calendar;
            let parcelsCache = [];
            let selectedEventInfo = null;

            specifyTimeCheckbox.addEventListener('change', () => {
                timeInputContainer.classList.toggle('time-input-hidden', !specifyTimeCheckbox.checked);
                document.getElementById('start_time').required = specifyTimeCheckbox.checked;
            });

            async function populateParcelsDropdown() {
                if (parcelsCache.length === 0) {
                    try {
                        parcelsCache = await apiFetch('/api/parcels');
                    } catch (e) {
                        console.error("Error al cargar parcelas:", e);
                        parcelSelect.innerHTML = `<option value="">Error al cargar parcelas</option>`;
                        return;
                    }
                }
                parcelSelect.innerHTML = '<option value="">Ninguna</option>' + parcelsCache.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            }
            
            async function openModal(info) {
                logForm.reset();
                specifyTimeCheckbox.checked = false;
                timeInputContainer.classList.add('time-input-hidden');
                deleteLogBtn.style.display = 'none';
                selectedEventInfo = info;

                await populateParcelsDropdown();

                if (info.event) {
                    modalTitle.textContent = 'Editar Entrada';
                    deleteLogBtn.style.display = 'block';
                    const log = info.event;
                    const startDateTime = new Date(log.start);

                    document.getElementById('log-id').value = log.id;
                    document.getElementById('log_date').value = startDateTime.toISOString().split('T')[0];

                    if (!log.allDay) {
                        specifyTimeCheckbox.checked = true;
                        timeInputContainer.classList.remove('time-input-hidden');
                        document.getElementById('start_time').value = startDateTime.toTimeString().slice(0, 5);
                        if (log.end) {
                            document.getElementById('end_time').value = new Date(log.end).toTimeString().slice(0, 5);
                        }
                    }
                    
                    document.getElementById('activity_type').value = log.title;
                    document.getElementById('description').value = log.extendedProps.description || '';
                    parcelSelect.value = log.extendedProps.parcel_id || '';

                } else {
                    modalTitle.textContent = 'Nueva Entrada';
                    document.getElementById('log-id').value = '';
                    document.getElementById('log_date').value = info.dateStr || new Date().toISOString().split('T')[0];
                }
                modal.classList.add('modal-active');
            }
            
            function closeModal() { modal.classList.remove('modal-active'); }
            addLogBtn.addEventListener('click', () => openModal({ dateStr: new Date().toISOString().split('T')[0] }));
            closeModalBtn.addEventListener('click', closeModal);

            async function loadEventsAndParcels() {
                try {
                    const [logs, parcels] = await Promise.all([
                        apiFetch('/api/field-logs/'),
                        apiFetch('/api/parcels/')
                    ]);
                    parcelsCache = parcels;

                    const parcelIdToNameMap = parcels.reduce((map, p) => {
                        map[p.id] = p.name;
                        return map;
                    }, {});

                    const events = logs.map(log => ({
                        id: log.id,
                        title: log.activity_type,
                        start: log.start_datetime,
                        end: log.end_datetime,
                        allDay: log.all_day,
                        extendedProps: {
                            description: log.description,
                            parcel_id: log.parcel_id,
                            parcel_name: log.parcel_id ? parcelIdToNameMap[log.parcel_id] : null
                        }
                    }));
                    
                    if (calendar.getEventSourceById('logs')) calendar.getEventSourceById('logs').remove();
                    calendar.addEventSource({ id: 'logs', events });

                } catch (error) {
                    console.error("Error al cargar eventos y parcelas:", error);
                    alert(error.message);
                }
            }

            logForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const logId = document.getElementById('log-id').value;
                const logData = {
                    log_date: document.getElementById('log_date').value,
                    activity_type: document.getElementById('activity_type').value,
                    description: document.getElementById('description').value,
                    parcel_id: document.getElementById('parcel_id').value || null,
                    start_time: specifyTimeCheckbox.checked ? document.getElementById('start_time').value : null,
                    end_time: specifyTimeCheckbox.checked ? document.getElementById('end_time').value : null
                };
                const endpoint = logId ? `/api/field-logs/${logId}` : '/api/field-logs/';
                const method = logId ? 'PUT' : 'POST';
                try {
                    await apiFetch(endpoint, { method, body: logData });
                    closeModal();
                    loadEventsAndParcels();
                } catch (error) { alert(`Error: ${error.message}`); }
            });

            deleteLogBtn.addEventListener('click', async () => {
                const logId = document.getElementById('log-id').value;
                if (!logId || !confirm('¿Estás seguro?')) return;
                try {
                    await apiFetch(`/api/field-logs/${logId}`, { method: 'DELETE' });
                    closeModal();
                    loadEventsAndParcels();
                } catch (error) { alert(`Error: ${error.message}`); }
            });

            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth', locale: 'es', height: 'auto',
                slotLabelFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
                eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek' },
                eventClick: (info) => openModal({ event: info.event }),
                dateClick: (info) => openModal({ dateStr: info.dateStr }),
                eventContent: function(arg) {
                    let titleEl = document.createElement('div');
                    titleEl.className = 'font-bold';
                    titleEl.innerHTML = arg.event.title;

                    let arrayOfDomNodes = [ titleEl ];

                    if (arg.event.extendedProps.parcel_name) {
                        let plotEl = document.createElement('i');
                        plotEl.className = 'text-sm';
                        plotEl.innerHTML = ` - ${arg.event.extendedProps.parcel_name}`;
                        arrayOfDomNodes.push(plotEl);
                    }
                    
                    return { domNodes: arrayOfDomNodes };
                }
            });
            calendar.render();
            loadEventsAndParcels();

            const exportCsvBtn = document.getElementById('export-csv-btn');
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            const exportError = document.getElementById('export-error');

            function handleExport(format) {
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                exportError.textContent = '';

                if (!startDate || !endDate) {
                    exportError.textContent = 'Por favor, selecciona una fecha de inicio y de fin.';
                    return;
                }
                if (new Date(startDate) > new Date(endDate)) {
                    exportError.textContent = 'La fecha de inicio no puede ser posterior a la fecha de fin.';
                    return;
                }

                const token = localStorage.getItem(TOKEN_KEY);
                const url = `${API_BASE_URL}/api/field-logs/export/?start_date=${startDate}&end_date=${endDate}&format=${format}`;
                
                fetch(url, { headers: { 'Authorization': `Bearer ${token}` } })
                    .then(res => {
                        if (!res.ok) throw new Error('No se pudo generar el informe.');
                        return res.blob();
                    })
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = `cuaderno_de_campo_${startDate}_a_${endDate}.${format}`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        a.remove();
                    })
                    .catch(err => {
                        exportError.textContent = err.message;
                    });
            }

            exportCsvBtn.addEventListener('click', () => handleExport('csv'));
            exportPdfBtn.addEventListener('click', () => handleExport('pdf'));
        });
    </script>
</body>
</html>