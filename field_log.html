<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Cuaderno de Campo - GrapeIQ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* ============================
         * SISTEMA DE TEMAS UNIFICADO
         * ============================ */
        :root { /* Tema Claro (Por Defecto) */
            --bg-color: #F8F7F4;
            --text-color: #1c1917;
            --text-secondary-color: #57534e;
            --header-bg-color: #292524;
            --tab-active-color: #5C1A33;
            --border-color: #e5e7eb;
            --card-bg: rgba(255, 255, 255, .92);
            --modal-input-bg: #FFFFFF;
            --cta-button-bg: #5C1A33;
            --secondary-button-bg: #A23E48;
            --contrast-button-bg: #6B705C;
            --highlight-color: #C98C32;
            --today-bg-color: rgba(92, 26, 51, 0.1);
        }

        body.theme-warm { /* üçÇ Tema Oto√±al C√°lido */
            --bg-color: #F2E2C4;
            --text-color: #5C4033;
            --text-secondary-color: #8C8C88;
            --header-bg-color: #5C4033;
            --tab-active-color: #C98C32;
            --border-color: rgba(92, 64, 51, 0.2);
            --card-bg: rgba(255, 255, 255, 0.6);
            --modal-input-bg: rgba(92, 64, 51, 0.05);
            --cta-button-bg: #D96C06;
            --secondary-button-bg: #A23E48;
            --contrast-button-bg: #6B705C;
            --highlight-color: #C98C32;
            --today-bg-color: rgba(201, 140, 50, 0.15);
        }

        /* --- Estilos Generales con Variables --- */
        body { font-family: 'Montserrat', sans-serif; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
        .tab-active { border-color: var(--tab-active-color) !important; color: var(--tab-active-color) !important; font-weight: 700; }
        .text-secondary { color: var(--text-secondary-color); }
        .bg-dark { background-color: var(--header-bg-color); }
        .border-accent { border-color: var(--border-color); }
        .card { background: var(--card-bg); backdrop-filter: saturate(115%) blur(4px); border-radius: 1rem; box-shadow: 0 10px 24px rgba(0,0,0,.06); }
        .modal-input { background-color: var(--modal-input-bg); border-color: var(--border-color); }
        .modal-content-bg { background-color: var(--bg-color); }

        /* Estilos FullCalendar */
        .fc-event { cursor: pointer; background-color: var(--cta-button-bg); border-color: var(--cta-button-bg); }
        .fc-daygrid-day.fc-day-today { background-color: var(--today-bg-color); }
        .fc .fc-button-primary { background-color: var(--header-bg-color); border-color: var(--header-bg-color); }
        .fc .fc-button-primary:hover { background-color: var(--header-bg-color); opacity: 0.9; }

        .modal { display: none; }
        .modal-active { display: flex; }
        .time-input-hidden { display: none; }
        .checkbox-custom { border-color: var(--highlight-color); color: var(--cta-button-bg); }

        /* --- CSS DE LA ANTORCHA --- */
        .torch-container { position: absolute; right: 220px; top: -35px; display: flex; align-items: center; cursor: pointer; user-select: none; transform: scale(0.45); }
        .torch-container input { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
        .torch { display: flex; justify-content: center; height: 150px; }
        .head, .stick { position: absolute; width: 30px; transform-style: preserve-3d; transform: rotateX(-30deg) rotateY(45deg); }
        .stick { position: relative; height: 120px; }
        .face { position: absolute; transform-style: preserve-3d; width: 30px; height: 30px; display: grid; grid-template-columns: 50% 50%; grid-template-rows: 50% 50%; background-color: #000; }
        .top { transform: rotateX(90deg) translateZ(15px); } .left { transform: rotateY(-90deg) translateZ(15px); } .right { transform: rotateY(0deg) translateZ(15px); }
        .top div, .left div, .right div { width: 102%; height: 102%; }
        .top div:nth-child(1), .left div:nth-child(3), .right div:nth-child(3) { background-color: #ffff9760; } .top div:nth-child(2), .left div:nth-child(1), .right div:nth-child(1) { background-color: #ffd80060; } .top div:nth-child(3), .left div:nth-child(4), .right div:nth-child(4) { background-color: #ffffff60; } .top div:nth-child(4), .left div:nth-child(2), .right div:nth-child(2) { background-color: #ff8f0060; }
        .side { position: absolute; width: 30px; height: 120px; display: grid; grid-template-columns: 50% 50%; grid-template-rows: repeat(8, 12.5%); cursor: pointer; translate: 0 12px; }
        .side-left { transform: rotateY(-90deg) translateZ(15px) translateY(8px); } .side-right { transform: rotateY(0deg) translateZ(15px) translateY(8px); }
        .side-left div, .side-right div { width: 103%; height: 103%; }
        .side div:nth-child(1) { background-color: #443622; } .side div:nth-child(2) { background-color: #2e2517; } .side div:nth-child(3), .side div:nth-child(5) { background-color: #4b3b23; } .side div:nth-child(4), .side div:nth-child(10) { background-color: #251e12; } .side div:nth-child(6) { background-color: #292115; } .side div:nth-child(7) { background-color: #4b3c26; } .side div:nth-child(8) { background-color: #292115; } .side div:nth-child(9) { background-color: #4b3a21; } .side div:nth-child(11), .side div:nth-child(15) { background-color: #3d311d; } .side div:nth-child(12) { background-color: #2c2315; } .side div:nth-child(13) { background-color: #493a22; } .side div:nth-child(14) { background-color: #2b2114; } .side div:nth-child(16) { background-color: #271e10; }
        .torch-container input:checked ~ .torch .face { filter: drop-shadow(0px 0px 2px #fff) drop-shadow(0px 0px 10px rgba(255, 237, 156, 0.7)) drop-shadow(0px 0px 25px rgba(255, 227, 101, 0.4)); }
        .torch-container input:checked ~ .torch .top div:nth-child(1), .torch-container input:checked ~ .torch .left div:nth-child(3), .torch-container input:checked ~ .torch .right div:nth-child(3) { background-color: #ffff97; } .torch-container input:checked ~ .torch .top div:nth-child(2), .torch-container input:checked ~ .torch .left div:nth-child(1), .torch-container input:checked ~ .torch .right div:nth-child(1) { background-color: #ffd800; } .torch-container input:checked ~ .torch .top div:nth-child(3), .torch-container input:checked ~ .torch .left div:nth-child(4), .torch-container input:checked ~ .torch .right div:nth-child(4) { background-color: #fff; } .torch-container input:checked ~ .torch .top div:nth-child(4), .torch-container input:checked ~ .torch .left div:nth-child(2), .torch-container input:checked ~ .torch .right div:nth-child(2) { background-color: #ff8f00; } .torch-container input:checked ~ .torch .side div:nth-child(1) { background-color: #7c623e; } .torch-container input:checked ~ .torch .side div:nth-child(2) { background-color: #4c3d26; } .torch-container input:checked ~ .torch .side div:nth-child(3), .torch-container input:checked ~ .torch .side div:nth-child(5) { background-color: #937344; } .torch-container input:checked ~ .torch .side div:nth-child(4), .torch-container input:checked ~ .torch .side div:nth-child(10) { background-color: #3c2f1c; } .torch-container input:checked ~ .torch .side div:nth-child(6) { background-color: #423522; } .torch-container input:checked ~ .torch .side div:nth-child(7) { background-color: #9f7f50; } .torch-container input:checked ~ .torch .side div:nth-child(8) { background-color: #403320; } .torch-container input:checked ~ .torch .side div:nth-child(9) { background-color: #977748; } .torch-container input:checked ~ .torch .side div:nth-child(11), .torch-container input:checked ~ .torch .side div:nth-child(15) { background-color: #675231; } .torch-container input:checked ~ .torch .side div:nth-child(12) { background-color: #3d301d; } .torch-container input:checked ~ .torch .side div:nth-child(13) { background-color: #987849; } .torch-container input:checked ~ .torch .side div:nth-child(14) { background-color: #3b2e1b; } .torch-container input:checked ~ .torch .side div:nth-child(16) { background-color: #372a17; }
    </style>
</head>
<body>
    <div class="p-4 sm:p-8">
        <header class="flex justify-between items-center mb-6 relative">
            <a href="performance.html" class="flex items-center gap-4">
                <img src="assets/GrapeIQ.png" alt="GrapeIQ Logo" class="h-10">
                <span class="text-3xl font-light text-secondary">|</span>
                <h1 class="text-3xl font-semibold">Cuaderno de Campo</h1>
            </a>
            <div class="flex items-center gap-4">
                <label class="torch-container">
                  <input id="theme-toggle" type="checkbox" />
                  <div class="torch">
                    <div class="head">
                      <div class="face top"> <div></div><div></div><div></div><div></div> </div>
                      <div class="face left"> <div></div><div></div><div></div><div></div> </div>
                      <div class="face right"> <div></div><div></div><div></div><div></div> </div>
                    </div>
                    <div class="stick">
                      <div class="side side-left"> <div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div> </div>
                      <div class="side side-right"> <div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div> </div>
                    </div>
                  </div>
                </label>
                <button id="logout-btn" class="bg-dark text-white px-6 py-2 rounded-full font-semibold hover:opacity-90">Cerrar Sesi√≥n</button>
            </div>
        </header>

        <div class="mb-6 border-b border-accent">
            <nav class="flex space-x-8 overflow-x-auto pb-2" aria-label="Tabs">
                <a href="performance.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-stone-800 border-transparent">An√°lisis de Rendimiento</a>
                <a href="forecast.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-stone-800 border-transparent">Predicciones</a>
                <a href="catalog.html" id="menu-catalogo" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-stone-800 border-transparent">Cat√°logo y Stock</a>
                <a href="daily-log.html" id="menu-registro-diario" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-stone-800 border-transparent">Registro Diario</a>
                <a href="financials.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-stone-800 border-transparent">Finanzas</a>
                <a href="field_log.html" class="px-1 py-4 border-b-2 font-semibold text-lg tab-active">Cuaderno de Campo</a>
                <a href="traceability.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-stone-800 border-transparent">Trazabilidad</a>
                <a href="cellar_management.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-stone-800 border-transparent">Gesti√≥n de Bodega</a>
                <a href="parcels.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-stone-800 border-transparent">Parcelas</a>
                <a href="weather.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-stone-800 border-transparent">Clima</a>
                <a href="settings.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-stone-800 border-transparent">Configuraci√≥n</a>
            </nav>
        </div>

        <main class="space-y-8">
            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Registro de Actividades</h2>
                    <button id="add-log-btn" class="text-white px-5 py-2 rounded-full font-semibold hover:opacity-90" style="background-color: var(--cta-button-bg);">A√±adir Nueva Entrada</button>
                </div>
                <div id='calendar'></div>
            </div>
            
            <div class="card p-6">
                <h2 class="text-2xl font-bold mb-4">Generar Informe</h2>
                <div class="flex flex-col sm:flex-row items-center gap-4">
                    <div>
                        <label for="start-date" class="block text-sm font-medium text-secondary mb-1">Fecha de Inicio</label>
                        <input type="date" id="start-date" class="w-full p-2 rounded-lg modal-input">
                    </div>
                    <div>
                        <label for="end-date" class="block text-sm font-medium text-secondary mb-1">Fecha de Fin</label>
                        <input type="date" id="end-date" class="w-full p-2 rounded-lg modal-input">
                    </div>
                    <div class="flex gap-2 mt-auto">
                        <button id="export-csv-btn" class="text-white px-5 py-2 rounded-full font-semibold hover:opacity-90" style="background-color: var(--contrast-button-bg);">Exportar a CSV</button>
                        <button id="export-pdf-btn" class="text-white px-5 py-2 rounded-full font-semibold hover:opacity-90" style="background-color: var(--secondary-button-bg);">Exportar a PDF</button>
                    </div>
                </div>
                <p id="export-error" class="text-red-500 text-sm mt-2 h-4"></p>
            </div>
        </main>
    </div>

    <div id="log-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center z-50">
        <div class="modal-content-bg rounded-2xl shadow-xl p-8 w-full max-w-md m-4">
            <h3 id="modal-title" class="text-2xl font-bold mb-6">Nueva Entrada</h3>
            <form id="log-form">
                <input type="hidden" id="log-id">
                <div class="space-y-4">
                    <div>
                        <label for="log_date" class="block text-sm font-medium text-secondary mb-1">Fecha</label>
                        <input type="date" id="log_date" name="log_date" required class="w-full p-2 rounded-lg modal-input">
                    </div>
                    <div>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="specify-time-checkbox" class="rounded checkbox-custom">
                            Especificar hora (si no, se considera todo el d√≠a)
                        </label>
                    </div>
                    <div id="time-input-container" class="time-input-hidden grid grid-cols-2 gap-4">
                        <div>
                            <label for="start_time" class="block text-sm font-medium text-secondary mb-1">Hora Inicio</label>
                            <input type="time" id="start_time" name="start_time" class="w-full p-2 rounded-lg modal-input">
                        </div>
                        <div>
                            <label for="end_time" class="block text-sm font-medium text-secondary mb-1">Hora Fin</label>
                            <input type="time" id="end_time" name="end_time" class="w-full p-2 rounded-lg modal-input">
                        </div>
                    </div>
                    <div>
                        <label for="activity_type" class="block text-sm font-medium text-secondary mb-1">Tipo de Actividad</label>
                        <select id="activity_type" name="activity_type" required class="w-full p-2 rounded-lg modal-input">
                            <option value="Poda">Poda</option>
                            <option value="Riego">Riego</option>
                            <option value="Tratamiento Fitosanitario">Tratamiento Fitosanitario</option>
                            <option value="Abonado">Abonado</option>
                            <option value="Vendimia">Vendimia</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    <div>
                        <label for="parcel_id" class="block text-sm font-medium text-secondary mb-1">Parcela (Opcional)</label>
                        <select id="parcel_id" name="parcel_id" class="w-full p-2 rounded-lg modal-input"></select>
                    </div>
                    <div>
                        <label for="description" class="block text-sm font-medium text-secondary mb-1">Descripci√≥n</label>
                        <textarea id="description" name="description" rows="3" class="w-full p-2 rounded-lg modal-input"></textarea>
                    </div>
                </div>
                <div class="flex justify-between items-center mt-8">
                    <button type="button" id="delete-log-btn" class="text-white px-5 py-2 rounded-full font-semibold hover:opacity-90 hidden" style="background-color: var(--secondary-button-bg);">Eliminar</button>
                    <div class="flex gap-4 ml-auto">
                        <button type="button" id="close-modal-btn" class="bg-stone-200 px-5 py-2 rounded-full font-semibold" style="color: var(--text-color);">Cancelar</button>
                        <button type="submit" class="text-white px-5 py-2 rounded-full font-semibold" style="background-color: var(--cta-button-bg);">Guardar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000';
        const TOKEN_KEY = 'accessToken';
        
        function requireAuth() { if (!localStorage.getItem(TOKEN_KEY)) window.location.href = 'login.html'; }
        function logout() { 
            localStorage.removeItem(TOKEN_KEY); 
            localStorage.removeItem('theme'); // Limpiar el tema al salir
            window.location.href = 'login.html'; 
        }

        async function apiFetch(endpoint, options = {}, expectJson = true) {
            if (!endpoint.endsWith('/')) { endpoint += '/'; }
            const headers = { ...options.headers };
            const token = localStorage.getItem(TOKEN_KEY);
            if (token) headers['Authorization'] = `Bearer ${token}`;
            if (options.body && typeof options.body !== 'string' && !(options.body instanceof FormData)) {
                headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(options.body);
            }
            
            try {
                const resp = await fetch(`${API_BASE_URL}${endpoint}`, { ...options, headers });
                if (resp.status === 401) { logout(); throw new Error('Sesi√≥n expirada.'); }
                if (resp.status === 204) return;
                if (!resp.ok) {
                    const data = await resp.json().catch(() => ({ detail: 'Error del servidor. Por favor, int√©ntelo de nuevo m√°s tarde.' }));
                    throw new Error(data.detail);
                }
                return expectJson ? resp.json() : resp.blob();
            } catch (error) {
                console.error(`Error en apiFetch a ${endpoint}:`, error);
                throw error;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            requireAuth();
            document.getElementById('logout-btn').addEventListener('click', logout);

            // --- L√ìGICA DEL TEMA (UNIFICADA Y PERSISTENTE) ---
            const themeToggle = document.getElementById('theme-toggle');
            const body = document.body;

            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'warm') {
                body.classList.add('theme-warm');
                themeToggle.checked = true;
            } else {
                themeToggle.checked = false;
            }
            
            themeToggle.addEventListener('change', () => {
                if (themeToggle.checked) {
                    body.classList.add('theme-warm');
                    localStorage.setItem('theme', 'warm');
                } else {
                    body.classList.remove('theme-warm');
                    localStorage.setItem('theme', 'light');
                }
            });

            // --- L√ìGICA ORIGINAL DE FIELD_LOG.HTML (SIN CAMBIOS) ---
            const modal = document.getElementById('log-modal');
            const addLogBtn = document.getElementById('add-log-btn');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const logForm = document.getElementById('log-form');
            const modalTitle = document.getElementById('modal-title');
            const specifyTimeCheckbox = document.getElementById('specify-time-checkbox');
            const timeInputContainer = document.getElementById('time-input-container');
            const deleteLogBtn = document.getElementById('delete-log-btn');
            const parcelSelect = document.getElementById('parcel_id');
            let calendar;
            let parcelsCache = [];

            specifyTimeCheckbox.addEventListener('change', () => {
                timeInputContainer.classList.toggle('time-input-hidden', !specifyTimeCheckbox.checked);
                document.getElementById('start_time').required = specifyTimeCheckbox.checked;
            });

            async function populateParcelsDropdown() {
                if (parcelsCache.length > 0) {
                     parcelSelect.innerHTML = '<option value="">Ninguna</option>' + parcelsCache.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                     return;
                }
                try {
                    parcelsCache = await apiFetch('/api/parcels/');
                    parcelSelect.innerHTML = '<option value="">Ninguna</option>' + parcelsCache.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                } catch (e) {
                    console.error("Error al cargar parcelas:", e);
                    parcelSelect.innerHTML = `<option value="">Error al cargar</option>`;
                }
            }
            
            async function openModal(info) {
                logForm.reset();
                specifyTimeCheckbox.checked = false;
                timeInputContainer.classList.add('time-input-hidden');
                deleteLogBtn.style.display = 'none';

                await populateParcelsDropdown();

                if (info.event) {
                    modalTitle.textContent = 'Editar Entrada';
                    deleteLogBtn.style.display = 'block';
                    const log = info.event;
                    const startDateTime = new Date(log.start);

                    document.getElementById('log-id').value = log.id;
                    document.getElementById('log_date').value = startDateTime.toISOString().split('T')[0];

                    if (!log.allDay) {
                        specifyTimeCheckbox.checked = true;
                        timeInputContainer.classList.remove('time-input-hidden');
                        document.getElementById('start_time').value = startDateTime.toTimeString().slice(0, 5);
                        if (log.end) {
                            document.getElementById('end_time').value = new Date(log.end).toTimeString().slice(0, 5);
                        }
                    }
                    
                    document.getElementById('activity_type').value = log.title;
                    document.getElementById('description').value = log.extendedProps.description || '';
                    parcelSelect.value = log.extendedProps.parcel_id || '';

                } else {
                    modalTitle.textContent = 'Nueva Entrada';
                    document.getElementById('log-id').value = '';
                    document.getElementById('log_date').value = info.dateStr || new Date().toISOString().split('T')[0];
                }
                modal.classList.add('modal-active');
            }
            
            function closeModal() { modal.classList.remove('modal-active'); }
            addLogBtn.addEventListener('click', () => openModal({ dateStr: new Date().toISOString().split('T')[0] }));
            closeModalBtn.addEventListener('click', closeModal);

            async function loadEventsAndParcels() {
                try {
                    const [logs, parcels] = await Promise.all([
                        apiFetch('/api/field-logs/'),
                        apiFetch('/api/parcels/')
                    ]);
                    parcelsCache = parcels;

                    const parcelIdToNameMap = parcels.reduce((map, p) => {
                        map[p.id] = p.name;
                        return map;
                    }, {});

                    const events = logs.map(log => ({
                        id: log.id,
                        title: log.activity_type,
                        start: log.start_datetime,
                        end: log.end_datetime,
                        allDay: log.all_day,
                        extendedProps: {
                            description: log.description,
                            parcel_id: log.parcel_id,
                            parcel_name: log.parcel_id ? parcelIdToNameMap[log.parcel_id] : null
                        }
                    }));
                    
                    if (calendar.getEventSourceById('logs')) calendar.getEventSourceById('logs').remove();
                    calendar.addEventSource({ id: 'logs', events });

                } catch (error) {
                    console.error("Error al cargar datos del calendario:", error);
                    alert(`No se pudieron cargar los datos del calendario: ${error.message}`);
                }
            }

            logForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const logId = document.getElementById('log-id').value;
                const logData = {
                    log_date: document.getElementById('log_date').value,
                    activity_type: document.getElementById('activity_type').value,
                    description: document.getElementById('description').value,
                    parcel_id: document.getElementById('parcel_id').value || null,
                    start_time: specifyTimeCheckbox.checked ? document.getElementById('start_time').value : null,
                    end_time: specifyTimeCheckbox.checked ? document.getElementById('end_time').value : null
                };
                const endpoint = logId ? `/api/field-logs/${logId}` : '/api/field-logs/';
                const method = logId ? 'PUT' : 'POST';
                try {
                    await apiFetch(endpoint, { method, body: logData });
                    closeModal();
                    await loadEventsAndParcels();
                } catch (error) { alert(`Error al guardar: ${error.message}`); }
            });

            deleteLogBtn.addEventListener('click', async () => {
                const logId = document.getElementById('log-id').value;
                if (!logId || !confirm('¬øEst√°s seguro de que deseas eliminar esta entrada?')) return;
                try {
                    await apiFetch(`/api/field-logs/${logId}`, { method: 'DELETE' });
                    closeModal();
                    await loadEventsAndParcels();
                } catch (error) { alert(`Error al eliminar: ${error.message}`); }
            });

            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth', locale: 'es', height: 'auto',
                slotLabelFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
                eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek' },
                eventClick: (info) => openModal({ event: info.event }),
                dateClick: (info) => openModal({ dateStr: info.dateStr }),
                eventContent: function(arg) {
                    let titleEl = document.createElement('div');
                    titleEl.className = 'font-bold';
                    titleEl.innerHTML = arg.event.title;
                    let arrayOfDomNodes = [ titleEl ];
                    if (arg.event.extendedProps.parcel_name) {
                        let plotEl = document.createElement('i');
                        plotEl.className = 'text-sm';
                        plotEl.innerHTML = ` - ${arg.event.extendedProps.parcel_name}`;
                        arrayOfDomNodes.push(plotEl);
                    }
                    return { domNodes: arrayOfDomNodes };
                }
            });
            calendar.render();
            loadEventsAndParcels();

            const exportCsvBtn = document.getElementById('export-csv-btn');
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            const exportError = document.getElementById('export-error');

            function handleExport(format) {
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                exportError.textContent = '';

                if (!startDate || !endDate) {
                    exportError.textContent = 'Por favor, selecciona una fecha de inicio y de fin.';
                    return;
                }
                if (new Date(startDate) > new Date(endDate)) {
                    exportError.textContent = 'La fecha de inicio no puede ser posterior a la fecha de fin.';
                    return;
                }

                const token = localStorage.getItem(TOKEN_KEY);
                const url = `${API_BASE_URL}/api/field-logs/export/?start_date=${startDate}&end_date=${endDate}&format=${format}`;
                
                fetch(url, { headers: { 'Authorization': `Bearer ${token}` } })
                    .then(res => {
                        if (!res.ok) {
                            return res.json().then(err => { throw new Error(err.detail || 'No se pudo generar el informe.') });
                        }
                        return res.blob();
                    })
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = `cuaderno_de_campo_${startDate}_a_${endDate}.${format}`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        a.remove();
                    })
                    .catch(err => {
                        exportError.textContent = `Error: ${err.message}`;
                    });
            }

            exportCsvBtn.addEventListener('click', () => handleExport('csv'));
            exportPdfBtn.addEventListener('click', () => handleExport('pdf'));
        });
    </script>
</body>
</html>