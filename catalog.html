<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GrapeIQ · Catálogo y Stock</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    body{font-family:'Montserrat',sans-serif;background-color:#F8F7F4}
    .wine-grad{background-image:linear-gradient(to right,#5C1A33,#8C2B4F)}
    .tab-active{border-color:#5C1A33;color:#5C1A33;font-weight:700}
  </style>
</head>
<body class="text-stone-800">
  <div class="p-4 sm:p-8">
    <header class="flex justify-between items-center mb-6">
        <div class="flex items-center gap-4">
          <a href="performance.html" class="flex items-center gap-4">
            <img src="assets/GrapeIQ.png" alt="GrapeIQ Logo" class="h-10">
            <span class="text-3xl font-light text-stone-400">|</span>
            <h1 class="text-3xl font-semibold text-stone-700">Catálogo y Stock</h1>
          </a>
        </div>
        <button id="logout-btn" class="bg-stone-700 text-white px-6 py-2 rounded-full font-semibold hover:bg-stone-800">Cerrar Sesión</button>
    </header>

    <div class="mb-6 border-b border-stone-200">
      <nav class="flex space-x-8" aria-label="Tabs">
        <a href="performance.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Análisis de Rendimiento</a>
        <a href="forecast.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Predicciones y Escenarios</a>
        <a href="catalog.html" id="menu-catalogo" class="px-1 py-4 border-b-2 font-semibold text-lg border-transparent tab-active">Catálogo y Stock</a>
        <a href="daily-log.html" id="menu-registro-diario" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Registro Diario</a>
        <a href="financials.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Finanzas</a>
        <a href="field_log.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Cuaderno de Campo</a>
        <a href="traceability.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Trazabilidad</a>
        <a href="cellar_management.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Gestión de Bodega</a>
        <a href="parcels.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Parcelas</a>
        <a href="weather.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Clima</a>
        <a href="settings.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Configuración</a>
      </nav>
    </div>

    <main class="space-y-6">
      <section class="flex justify-between items-center">
        <div class="relative">
          <input type="text" id="sku-filter-input" placeholder="Buscar por SKU..." class="w-full max-w-xs pl-10 pr-4 py-2 border border-stone-300 rounded-full">
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-stone-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </div>
        <button id="add-product-btn" class="wine-grad text-white px-5 py-2 rounded-full font-semibold hover:opacity-90 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
          Añadir Vino Manualmente
        </button>
      </section>

      <section class="bg-white p-6 rounded-2xl shadow-lg">
        <div class="max-h-[60vh] overflow-y-auto">
          <table class="w-full text-left">
            <thead class="border-b border-stone-200 sticky top-0 bg-white">
              <tr>
                <th class="p-4 font-bold">Nombre del Vino</th>
                <th class="p-4 font-bold">SKU</th>
                <th class="p-4 font-bold">Precio</th>
                <th class="p-4 font-bold">Coste</th>
                <th class="p-4 font-bold">Stock</th>
              </tr>
            </thead>
            <tbody id="product-table-body"></tbody>
          </table>
        </div>
        <p id="catalog-placeholder" class="hidden text-center py-8 text-stone-500">No se encontraron productos.</p>
        <div id="catalog-pagination" class="flex justify-center items-center gap-4 mt-4"></div>
      </section>
    </main>

    <div id="add-product-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white text-stone-800 w-full max-w-4xl p-8 rounded-3xl shadow-2xl grid grid-cols-1 md:grid-cols-2 gap-8 relative">
            <div>
                <h2 class="text-2xl font-bold">Añadir Nuevo Vino al Catálogo</h2>
                <p class="text-stone-500 text-sm mb-6">Completa los campos para añadir un nuevo producto a la base de datos.</p>
                <form id="add-product-form" class="space-y-4">
                    <h3 class="font-bold text-lg border-b border-stone-200 pb-2">Datos del vino</h3>
                    <div><label class="block mb-1 text-sm font-semibold">Nombre del Vino <span class="text-red-500">*</span></label><input type="text" id="product-name" required class="w-full bg-stone-50 p-3 rounded-lg border border-stone-300"></div>
                    <div><label class="block mb-1 text-sm font-semibold">SKU / Código <span class="text-red-500">*</span></label><input type="text" id="product-sku" required class="w-full bg-stone-50 p-3 rounded-lg border border-stone-300"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block mb-1 text-sm font-semibold">Precio (€) <span class="text-red-500">*</span></label><input type="number" step="0.01" id="product-price" required class="w-full bg-stone-50 p-3 rounded-lg border border-stone-300"></div>
                        <div>
                            <label class="block mb-1 text-sm font-semibold">Lote de Origen (Opcional)</label>
                            <select id="wine-lot-origin" class="w-full bg-stone-50 p-3 rounded-lg border border-stone-300">
                                <option value="">Seleccionar lote...</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block mb-1 text-sm font-semibold">Coste (€)</label><input type="number" step="0.01" id="product-cost" class="w-full bg-stone-50 p-3 rounded-lg border border-stone-300"></div>
                        <div><label class="block mb-1 text-sm font-semibold">Stock inicial</label><input type="number" id="product-quantity" class="w-full bg-stone-50 p-3 rounded-lg border border-stone-300"></div>
                    </div>
                </form>
            </div>
            <div class="bg-stone-50 p-6 rounded-2xl border border-stone-200">
                <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg">Métricas en Tiempo Real</h3><button id="clear-metrics-btn" class="text-sm text-stone-500 hover:text-stone-800">Borrar</button></div>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="bg-white p-3 rounded-lg border"><p class="text-stone-500 text-sm">Precio</p><p id="metric-price" class="font-bold text-xl">-</p></div>
                    <div class="bg-white p-3 rounded-lg border"><p class="text-stone-500 text-sm">Coste</p><p id="metric-cost" class="font-bold text-xl">-</p></div>
                    <div class="bg-white p-3 rounded-lg border"><p class="text-stone-500 text-sm">Margen</p><p id="metric-margin-abs" class="font-bold text-xl">-</p></div>
                    <div class="bg-white p-3 rounded-lg border"><p class="text-stone-500 text-sm">Margen %</p><p id="metric-margin-perc" class="font-bold text-xl">-</p></div>
                    <div class="bg-white p-3 rounded-lg border col-span-2"><p class="text-stone-500 text-sm">Ingresos (estim.)</p><p id="metric-total-revenue" class="font-bold text-3xl text-green-600">-</p></div>
                </div>
                <p class="text-xs text-stone-500 mt-4 text-center">Las métricas se actualizan al escribir.</p>
            </div>
            <div class="md:col-span-2 flex justify-end gap-4 mt-6">
                <button id="cancel-product-btn" type="button" class="bg-stone-200 px-6 py-3 rounded-full font-bold hover:bg-stone-300">Cancelar</button>
                <button id="save-product-btn" form="add-product-form" type="submit" class="wine-grad text-white px-6 py-3 rounded-full font-bold hover:opacity-90">Guardar Vino</button>
            </div>
        </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'http://127.0.0.1:8000';
    const TOKEN_KEY = 'accessToken';
    const ROLE_KEY = 'userRole';

    function requireAuth() { if (!localStorage.getItem(TOKEN_KEY)) window.location.href = 'login.html'; }
    function logout() {
        localStorage.removeItem(TOKEN_KEY);
        localStorage.removeItem(ROLE_KEY);
        window.location.href = 'login.html';
    }
    
    async function apiFetch(endpoint, options = {}) {
        const headers = { 'Content-Type': 'application/json' };
        const token = localStorage.getItem(TOKEN_KEY);
        if (token) headers['Authorization'] = `Bearer ${token}`;
        if (options.body && options.body instanceof FormData) delete headers['Content-Type'];
        
        const resp = await fetch(`${API_BASE_URL}${endpoint}`, { ...options, headers });
        
        if (resp.status === 401) { logout(); throw new Error('Sesión expirada.'); }
        if (resp.status === 204) return null;
        if (!resp.ok) {
            const errData = await resp.json().catch(() => ({ detail: 'Error en la API.' }));
            throw new Error(errData.detail);
        }
        return resp.json();
    }

    function updateUIVisibility() {
        const role = localStorage.getItem(ROLE_KEY);
        if (role === 'lector') {
            const addProductBtn = document.getElementById('add-product-btn');
            if(addProductBtn) addProductBtn.style.display = 'none';
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        const logoutBtn = document.getElementById('logout-btn');
        if(logoutBtn) logoutBtn.addEventListener('click', logout);
        requireAuth();
        updateUIVisibility();

        // --- LÓGICA DE LA PÁGINA DE CATÁLOGO ---
        const catalog = {
            tableBody: document.getElementById('product-table-body'),
            placeholder: document.getElementById('catalog-placeholder'),
            pagination: document.getElementById('catalog-pagination'),
            filterInput: document.getElementById('sku-filter-input'),
            addProductBtn: document.getElementById('add-product-btn'),
            modal: {
                container: document.getElementById('add-product-modal'),
                form: document.getElementById('add-product-form'),
                cancelBtn: document.getElementById('cancel-product-btn'),
                clearMetricsBtn: document.getElementById('clear-metrics-btn'),
                wineLotSelect: document.getElementById('wine-lot-origin'),
                inputs: { name: document.getElementById('product-name'), sku: document.getElementById('product-sku'), price: document.getElementById('product-price'), cost: document.getElementById('product-cost'), quantity: document.getElementById('product-quantity') },
                metrics: { price: document.getElementById('metric-price'), cost: document.getElementById('metric-cost'), marginAbs: document.getElementById('metric-margin-abs'), marginPerc: document.getElementById('metric-margin-perc'), totalRevenue: document.getElementById('metric-total-revenue') }
            }
        };
        
        let currentPage = 1; 
        const pageSize = 10; 
        let skuFilterTimeout;

        async function loadProducts(page = 1) {
            currentPage = page;
            const offset = (page - 1) * pageSize;
            const sku = catalog.filterInput.value || '';
            
            try {
                // APUNTAMOS AL ENDPOINT HÍBRIDO
                const products = await apiFetch(`/api/analytics/product-catalog?limit=${pageSize}&offset=${offset}&sku=${encodeURIComponent(sku)}`);
                
                catalog.tableBody.innerHTML = '';
                
                if (Array.isArray(products) && products.length > 0) {
                    catalog.placeholder.classList.add('hidden');
                    products.forEach(p => {
                        const stockColor = p.Stock < 50 ? 'text-red-600' : (p.Stock < 200 ? 'text-yellow-600' : 'text-green-700');
                        catalog.tableBody.insertAdjacentHTML('beforeend', 
                           `<tr class="border-b border-stone-100">
                                <td class="p-4 font-semibold">${p.ProductName}</td>
                                <td class="p-4 text-stone-500">${p.SKU}</td>
                                <td class="p-4">€${(p.UnitPrice || 0).toFixed(2)}</td>
                                <td class="p-4 text-stone-500">€${(p.UnitCost || 0).toFixed(2)}</td>
                                <td class="p-4 font-bold ${stockColor}">${p.Stock != null ? p.Stock : '-'}</td>
                            </tr>`
                        );
                    });
                } else {
                    if (page === 1) catalog.placeholder.classList.remove('hidden');
                }
                renderPaginationControls(page, Array.isArray(products) && products.length === pageSize);
            } catch (err) {
                alert(`Error al cargar los productos: ${err.message}`);
            }
        }

        function renderPaginationControls(page, hasNext) {
            catalog.pagination.innerHTML = `<button id="prev-page-btn" class="px-4 py-2 rounded-full bg-stone-200 hover:bg-stone-300 font-semibold disabled:opacity-50" ${page === 1 ? 'disabled' : ''}>Anterior</button><span class="font-bold">Página ${page}</span><button id="next-page-btn" class="px-4 py-2 rounded-full bg-stone-200 hover:bg-stone-300 font-semibold disabled:opacity-50" ${!hasNext ? 'disabled' : ''}>Siguiente</button>`;
            document.getElementById('prev-page-btn').onclick = () => { if (page > 1) loadProducts(page - 1); };
            document.getElementById('next-page-btn').onclick = () => { if (hasNext) loadProducts(page + 1); };
        }
        
        catalog.filterInput.addEventListener('input', () => { 
            clearTimeout(skuFilterTimeout); 
            skuFilterTimeout = setTimeout(() => loadProducts(1), 500); 
        });

        // --- LÓGICA DEL MODAL PARA AÑADIR MANUALMENTE ---
        catalog.addProductBtn.addEventListener('click', async () => {
            catalog.modal.form.reset();
            updateMetrics();
            try {
                const wineLots = await apiFetch('/api/traceability/wine-lots');
                const select = catalog.modal.wineLotSelect;
                select.innerHTML = '<option value="">(Ninguno)</option>';
                wineLots.forEach(lot => {
                    select.innerHTML += `<option value="${lot.id}">${lot.name}</option>`;
                });
            } catch (error) {
                console.error("Error al cargar lotes para el modal:", error);
            }
            catalog.modal.container.classList.remove('hidden');
        });

        catalog.modal.cancelBtn.addEventListener('click', () => catalog.modal.container.classList.add('hidden'));
        catalog.modal.clearMetricsBtn.addEventListener('click', () => {
            catalog.modal.form.reset();
            updateMetrics();
        });
        Object.values(catalog.modal.inputs).forEach(i => i.addEventListener('input', updateMetrics));
        
        function updateMetrics() {
            const {inputs, metrics} = catalog.modal;
            const price = parseFloat(inputs.price.value) || 0;
            const cost = parseFloat(inputs.cost.value) || 0;
            const qty = parseInt(inputs.quantity.value) || 0;
            
            metrics.price.textContent = price > 0 ? `€${price.toFixed(2)}` : '-';
            metrics.cost.textContent  = cost > 0 ?  `€${cost.toFixed(2)}` : '-';
            
            if(price > 0 && cost > 0 && price >= cost) {
                const m = price - cost;
                metrics.marginAbs.textContent = `€${m.toFixed(2)}`;
                metrics.marginPerc.textContent = `${((m / price) * 100).toFixed(1)}%`;
            } else {
                metrics.marginAbs.textContent = '-';
                metrics.marginPerc.textContent = '-';
            }
            metrics.totalRevenue.textContent = (price > 0 && qty > 0) ? `€${(price * qty).toFixed(2)}` : '-';
        }

        catalog.modal.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const { modal } = catalog;
            const lotId = modal.wineLotSelect.value;
            if (!lotId) {
                alert("Para crear un producto, debes asociarlo a un lote de vino de origen.");
                return;
            }

            const productData = { 
                name: modal.inputs.name.value, 
                sku: modal.inputs.sku.value, 
                price: parseFloat(modal.inputs.price.value),
                wine_lot_origin_id: lotId,
                stock_units: modal.inputs.quantity.value ? parseInt(modal.inputs.quantity.value) : 0 
            };
            try {
                await apiFetch('/api/products/', { method: 'POST', body: JSON.stringify(productData) });
                modal.container.classList.add('hidden');
                alert("Producto añadido a la base de datos.");
                loadProducts(currentPage); // Recargar la tabla para mostrar el nuevo producto
            } catch (err) {
                alert(`Error al guardar el producto: ${err.message}`);
            }
        });

        // Carga inicial
        loadProducts(1);
    });
  </script>
</body>
</html>