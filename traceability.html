<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Trazabilidad - GrapeIQ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        :root { /* Tema Blanco por Defecto */
            --bg-color: #F8F7F4; --text-color: #1c1917; --text-secondary-color: #57534e;
            --header-bg-color: #292524; --tab-active-color: #5C1A33; --cta-button-bg: #16a34a;
            --secondary-button-bg: #dc2626; --accent-color: #C98C32; --border-color: #e5e7eb;
            --kanban-bg: rgba(255, 255, 255, 0.8); --modal-input-bg: #FFFFFF;
            --harvested-bg: #e2e8f0; --fermenting-bg: #fef3c7; --aging-bg: #fde68a;
            --ready-bg: #dbeafe; --bottled-bg: #dcfce7;
        }
        body.theme-warm { /* Tema Otoñal Cálido */
            --bg-color: #F2E2C4; --text-color: #5C4033; --text-secondary-color: #8C8C88;
            --header-bg-color: #5C4033; --tab-active-color: #C98C32; --cta-button-bg: #D96C06;
            --secondary-button-bg: #A23E48; --border-color: rgba(92, 64, 51, 0.2);
            --kanban-bg: rgba(255, 255, 255, 0.6); --modal-input-bg: rgba(92, 64, 51, 0.05);
            --harvested-bg: rgba(107, 114, 128, 0.2); --fermenting-bg: rgba(217, 108, 6, 0.2);
            --aging-bg: rgba(162, 62, 72, 0.2); --ready-bg: rgba(107, 112, 92, 0.3);
            --bottled-bg: rgba(92, 64, 51, 0.3);
        }
        body { font-family: 'Montserrat', sans-serif; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
        .tab-active { border-color: var(--tab-active-color) !important; color: var(--tab-active-color) !important; font-weight: 700; }
        .text-secondary { color: var(--text-secondary-color); } .bg-dark { background-color: var(--header-bg-color); }
        .border-accent { border-color: var(--border-color); } .cta-button { background-color: var(--cta-button-bg); color: white; }
        .secondary-button { background-color: var(--secondary-button-bg); color: white; }
        .kanban-column { min-height: 400px; background-color: var(--kanban-bg); }
        .modal { display: none; } .modal-active { display: flex; }
        .modal-input { background-color: var(--modal-input-bg); border-color: var(--border-color); }
        .kanban-card { cursor: grab; transition: transform 0.2s ease, box-shadow 0.2s ease; position: relative; }
        .kanban-card:active { cursor: grabbing; }
        .kanban-card:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .status-Cosechado { background-color: var(--harvested-bg); }
        .status-En-Fermentación { background-color: var(--fermenting-bg); }
        .status-En-Crianza { background-color: var(--aging-bg); }
        .status-Listo-para-Embotellar { background-color: var(--ready-bg); }
        .status-Embotellado { background-color: var(--bottled-bg); }
        .sortable-ghost { opacity: 0.4; background: var(--tab-active-color); border-radius: 0.5rem; }
        .sortable-drag { opacity: 1 !important; }
        
        @keyframes pulse-animation {
            0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(234, 179, 8, 0); }
            100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); }
        }

        /* ================================================================= */
        /* INICIO DE LA CORRECCIÓN */
        /* ================================================================= */
        .pending-action-indicator {
            position: absolute; bottom: 8px; right: 8px; /* Movido abajo a la derecha */
            width: 12px; height: 12px;
            background-color: #eab308; /* Amarillo */
            border-radius: 9999px; border: 2px solid white;
            animation: pulse-animation 1.5s infinite; z-index: 10;
        }

        .ready-indicator {
            position: absolute; bottom: 8px; right: 8px; /* Posición abajo a la derecha */
            width: 12px; height: 12px;
            background-color: #22c55e; /* Verde */
            border-radius: 9999px; border: 2px solid white;
            box-shadow: 0 0 7px 1px rgba(34, 197, 94, 0.6); /* Sutil brillo verde */
            z-index: 10;
        }
        /* ================================================================= */
        /* FIN DE LA CORRECCIÓN */
        /* ================================================================= */

        .torch-container { position: absolute; right: 220px; top: -35px; display: flex; flex-direction: column; align-items: center; cursor: pointer; user-select: none; transform: scale(0.45); }
        .torch-container input { position: absolute; opacity: 0; } .torch { display: flex; justify-content: center; height: 150px; }
        .head, .stick { position: absolute; width: 30px; transform-style: preserve-3d; transform: rotateX(-30deg) rotateY(45deg); }
        .stick { position: relative; height: 120px; } .face { position: absolute; transform-style: preserve-3d; width: 30px; height: 30px; display: grid; grid-template-columns: 50% 50%; grid-template-rows: 50% 50%; background-color: #000000; }
        .top { transform: rotateX(90deg) translateZ(15px); } .left { transform: rotateY(-90deg) translateZ(15px); } .right { transform: rotateY(0deg) translateZ(15px); }
        .top div, .left div, .right div { width: 102%; height: 102%; } .top div:nth-child(1), .left div:nth-child(3), .right div:nth-child(3) { background-color: #ffff9760; } .top div:nth-child(2), .left div:nth-child(1), .right div:nth-child(1) { background-color: #ffd80060; } .top div:nth-child(3), .left div:nth-child(4), .right div:nth-child(4) { background-color: #ffffff60; } .top div:nth-child(4), .left div:nth-child(2), .right div:nth-child(2) { background-color: #ff8f0060; }
        .side { position: absolute; width: 30px; height: 120px; display: grid; grid-template-columns: 50% 50%; grid-template-rows: repeat(8, 12.5%); cursor: pointer; translate: 0 12px; }
        .side-left { transform: rotateY(-90deg) translateZ(15px) translateY(8px); } .side-right { transform: rotateY(0deg) translateZ(15px) translateY(8px); } .side-left div, .side-right div { width: 103%; height: 103%; }
        .side div:nth-child(1){background-color:#443622}.side div:nth-child(2){background-color:#2e2517}.side div:nth-child(3),.side div:nth-child(5){background-color:#4b3b23}.side div:nth-child(4),.side div:nth-child(10){background-color:#251e12}.side div:nth-child(6){background-color:#292115}.side div:nth-child(7){background-color:#4b3c26}.side div:nth-child(8){background-color:#292115}.side div:nth-child(9){background-color:#4b3a21}.side div:nth-child(11),.side div:nth-child(15){background-color:#3d311d}.side div:nth-child(12){background-color:#2c2315}.side div:nth-child(13){background-color:#493a22}.side div:nth-child(14){background-color:#2b2114}.side div:nth-child(16){background-color:#271e10}
        .torch-container input:checked~.torch .face{filter:drop-shadow(0 0 2px #fff) drop-shadow(0 0 10px rgba(255,237,156,.7)) drop-shadow(0 0 25px rgba(255,227,101,.4))}.torch-container input:checked~.torch .top div:nth-child(1),.torch-container input:checked~.torch .left div:nth-child(3),.torch-container input:checked~.torch .right div:nth-child(3){background-color:#ffff97}.torch-container input:checked~.torch .top div:nth-child(2),.torch-container input:checked~.torch .left div:nth-child(1),.torch-container input:checked~.torch .right div:nth-child(1){background-color:#ffd800}.torch-container input:checked~.torch .top div:nth-child(3),.torch-container input:checked~.torch .left div:nth-child(4),.torch-container input:checked~.torch .right div:nth-child(4){background-color:#fff}.torch-container input:checked~.torch .top div:nth-child(4),.torch-container input:checked~.torch .left div:nth-child(2),.torch-container input:checked~.torch .right div:nth-child(2){background-color:#ff8f00}.torch-container input:checked~.torch .side div:nth-child(1){background-color:#7c623e}.torch-container input:checked~.torch .side div:nth-child(2){background-color:#4c3d26}.torch-container input:checked~.torch .side div:nth-child(3),.torch-container input:checked~.torch .side div:nth-child(5){background-color:#937344}.torch-container input:checked~.torch .side div:nth-child(4),.torch-container input:checked~.torch .side div:nth-child(10){background-color:#3c2f1c}.torch-container input:checked~.torch .side div:nth-child(6){background-color:#423522}.torch-container input:checked~.torch .side div:nth-child(7){background-color:#9f7f50}.torch-container input:checked~.torch .side div:nth-child(8){background-color:#403320}.torch-container input:checked~.torch .side div:nth-child(9){background-color:#977748}.torch-container input:checked~.torch .side div:nth-child(11),.torch-container input:checked~.torch .side div:nth-child(15){background-color:#675231}.torch-container input:checked~.torch .side div:nth-child(12){background-color:#3d301d}.torch-container input:checked~.torch .side div:nth-child(13){background-color:#987849}.torch-container input:checked~.torch .side div:nth-child(14){background-color:#3b2e1b}.torch-container input:checked~.torch .side div:nth-child(16){background-color:#372a17}
    </style>
</head>
<body>
    <div class="p-4 sm:p-8">
        <header class="flex justify-between items-center mb-6 relative">
             <a href="performance.html" class="flex items-center gap-4">
                <img src="assets/GrapeIQ.png" alt="GrapeIQ Logo" class="h-10">
                <span class="text-3xl font-light text-secondary">|</span>
                <h1 class="text-3xl font-semibold">Trazabilidad del Vino</h1>
            </a>
            <div class="flex items-center gap-4">
                 <label class="torch-container">
                    <input id="theme-toggle" type="checkbox" />
                    <div class="torch">
                        <div class="head">
                            <div class="face top"><div></div><div></div><div></div><div></div></div>
                            <div class="face left"><div></div><div></div><div></div><div></div></div>
                            <div class="face right"><div></div><div></div><div></div><div></div></div>
                        </div>
                        <div class="stick">
                            <div class="side side-left"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
                            <div class="side side-right"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
                        </div>
                    </div>
                </label>
                <button id="logout-btn" class="bg-dark text-white px-6 py-2 rounded-full font-semibold hover:opacity-90">Cerrar Sesión</button>
             </div>
        </header>
        <div class="mb-8 border-b border-accent">
            <nav class="flex space-x-8 overflow-x-auto pb-2">
                <a href="performance.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-chestnut-brown border-transparent">Análisis de Rendimiento</a>
                <a href="forecast.html"   class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-chestnut-brown border-transparent">Predicciones y Escenarios</a>
                <a href="catalog.html"     id="menu-catalogo" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-chestnut-brown border-transparent">Catálogo y Stock</a>
                <a href="daily-log.html"   id="menu-registro-diario" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-chestnut-brown border-transparent">Registro Diario</a>
                <a href="financials.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-chestnut-brown border-transparent">Finanzas</a>
                <a href="field_log.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-chestnut-brown border-transparent">Cuaderno de Campo</a>
                <a href="traceability.html" class="px-1 py-4 border-b-2 font-semibold text-lg border-transparent tab-active">Trazabilidad</a>
                <a href="cellar_management.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-chestnut-brown border-transparent">Gestión de Bodega</a>
                <a href="parcels.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-chestnut-brown border-transparent">Parcelas</a>
                <a href="weather.html"     class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-chestnut-brown border-transparent">Clima</a>
                <a href="settings.html"    class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-chestnut-brown border-transparent">Configuración</a>
            </nav>
        </div>

        <div class="flex flex-wrap justify-end mb-6 gap-4">
            <button id="add-lot-btn" class="cta-button px-5 py-2 rounded-full font-semibold hover:opacity-90">
                <i class="fas fa-plus mr-2"></i>Crear Lote de Vino
            </button>
        </div>
        <main id="kanban-board" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-6">
            <section class="p-4 rounded-2xl shadow-lg kanban-column" data-id="Cosechado">
                <h2 class="text-lg font-bold mb-4 text-center">🍇 Cosechado</h2>
                <div id="harvested-list" data-status="Cosechado" class="space-y-3 kanban-list min-h-full"></div>
            </section>
            
            <section class="p-4 rounded-2xl shadow-lg kanban-column" data-id="En Fermentación">
                <h2 class="text-lg font-bold mb-4 text-center">🌡️ Vinificación</h2>
                <div id="fermenting-list" data-status="En Fermentación" class="space-y-3 kanban-list min-h-full"></div>
            </section>

            <section class="p-4 rounded-2xl shadow-lg kanban-column" data-id="En Crianza">
                <h2 class="text-lg font-bold mb-4 text-center">📦 Crianza</h2>
                <div id="aging-list" data-status="En Crianza" class="space-y-3 kanban-list min-h-full"></div>
            </section>
            
            <section class="p-4 rounded-2xl shadow-lg kanban-column" data-id="Listo para Embotellar">
                <h2 class="text-lg font-bold mb-4 text-center">🧪 Listo para Embotellar</h2>
                <div id="ready_to_bottle-list" data-status="Listo para Embotellar" class="space-y-3 kanban-list min-h-full"></div>
            </section>

            <section class="p-4 rounded-2xl shadow-lg kanban-column" data-id="Embotellado">
                <h2 class="text-lg font-bold mb-4 text-center">🍾 Embotellado</h2>
                <div id="bottled-list" data-status="Embotellado" class="space-y-3 kanban-list min-h-full"></div>
            </section>
        </main>
    </div>

    <div id="lot-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md m-4">
            <h3 id="modal-title" class="text-2xl font-bold mb-6"></h3>
            <form id="lot-form" class="space-y-4">
                <input type="hidden" id="lot-id" name="id">
                <div><label class="block text-sm">Nombre del Lote</label><input type="text" id="lot-name" name="name" required class="w-full mt-1 p-2 rounded modal-input"></div>
                <div><label class="block text-sm">Parcela de Origen</label><select name="origin_parcel_id" id="lot-origin_parcel_id" required class="w-full mt-1 p-2 rounded modal-input"></select></div>
                <div><label class="block text-sm">Kilos de Uva (kg)</label><input type="number" step="0.1" id="lot-initial_grape_kg" name="initial_grape_kg" required class="w-full mt-1 p-2 rounded modal-input"></div>
                <div><label class="block text-sm">Variedad de Uva</label><input type="text" id="lot-grape_variety" name="grape_variety" class="w-full mt-1 p-2 rounded modal-input"></div>
                <div><label class="block text-sm">Año de Cosecha</label><input type="number" id="lot-vintage_year" name="vintage_year" class="w-full mt-1 p-2 rounded modal-input"></div>
            </form>
            <div class="flex justify-end gap-4 mt-8">
                <button type="button" class="close-modal-btn bg-stone-200 px-5 py-2 rounded-full font-semibold">Cancelar</button>
                <button type="submit" form="lot-form" class="cta-button px-5 py-2 rounded-full font-semibold">Guardar</button>
            </div>
        </div>
    </div>
    
    <div id="bottling-event-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-lg m-4">
            <h3 class="text-2xl font-bold mb-2">Registrar Embotellado</h3>
            <p class="text-secondary text-sm mb-6">Lote: <strong id="bottling-lot-name"></strong></p>
            <form id="bottling-event-form" class="space-y-4">
                <input type="hidden" id="bottling-lot-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm">Nº Lote Oficial (etiqueta)</label><input type="text" name="official_lot_number" required class="w-full mt-1 p-2 rounded modal-input"></div>
                    <div><label class="block text-sm">Nº de Botellas</label><input type="number" name="bottles_produced" required class="w-full mt-1 p-2 rounded modal-input"></div>
                </div>
            </form>
            <div class="flex justify-end gap-4 mt-8">
                <button type="button" class="close-modal-btn bg-stone-200 px-5 py-2 rounded-full font-semibold">Cancelar</button>
                <button type="submit" form="bottling-event-form" class="cta-button px-5 py-2 rounded-full font-semibold">Siguiente: Crear Producto</button>
            </div>
        </div>
    </div>

    <div id="create-product-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-lg m-4">
            <h3 class="text-2xl font-bold mb-2">Crear Nuevo Producto</h3>
            <p class="text-secondary text-sm mb-6">Asociado al lote: <strong id="product-lot-name"></strong></p>
            <form id="create-product-form" class="space-y-4">
                <input type="hidden" id="product-lot-id">
                <div><label class="block text-sm">Nombre del Producto</label><input type="text" name="name" required class="w-full mt-1 p-2 rounded modal-input"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm">SKU</label><input type="text" name="sku" required class="w-full mt-1 p-2 rounded modal-input"></div>
                    <div><label class="block text-sm">Precio de Venta (€)</label><input type="number" step="0.01" name="price" required class="w-full mt-1 p-2 rounded modal-input"></div>
                </div>
                 <div><label class="block text-sm">Descripción</label><textarea name="description" rows="3" class="w-full mt-1 p-2 rounded modal-input"></textarea></div>
            </form>
            <div class="flex justify-end gap-4 mt-8">
                <button type="button" class="close-modal-btn bg-stone-200 px-5 py-2 rounded-full font-semibold">Cancelar</button>
                <button type="submit" form="create-product-form" class="cta-button px-5 py-2 rounded-full font-semibold">Finalizar Embotellado</button>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            const API_BASE_URL = 'http://127.0.0.1:8000';
            const TOKEN_KEY = 'accessToken';
            
            function requireAuth() { if (!localStorage.getItem(TOKEN_KEY)) window.location.href = 'login.html'; }
            function logout() { localStorage.removeItem(TOKEN_KEY); localStorage.removeItem('theme'); window.location.href = 'login.html'; }
            
            async function apiFetch(endpoint, options = {}) {
                const headers = { 'Content-Type': 'application/json', ...options.headers };
                const token = localStorage.getItem(TOKEN_KEY);
                if (token) headers['Authorization'] = `Bearer ${token}`;
                if (options.body && typeof options.body !== 'string') options.body = JSON.stringify(options.body);
                const resp = await fetch(`${API_BASE_URL}${endpoint}`, { ...options, headers });
                if (resp.status === 401) { logout(); throw new Error('Sesión expirada.'); }
                if (resp.status === 204) return null;
                if (!resp.ok) {
                    const data = await resp.json().catch(() => ({ detail: `Error en la petición a ${endpoint}` }));
                    throw new Error(data.detail);
                }
                return resp.json();
            }

            const themeToggle = document.getElementById('theme-toggle');
            const body = document.body;
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'warm') {
                body.classList.add('theme-warm');
                themeToggle.checked = true;
            } else {
                themeToggle.checked = false;
            }
            themeToggle.addEventListener('change', () => {
                body.classList.toggle('theme-warm');
                localStorage.setItem('theme', body.classList.contains('theme-warm') ? 'warm' : 'light');
            });

            requireAuth();
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            const lists = {
                harvested: document.getElementById('harvested-list'),
                fermenting: document.getElementById('fermenting-list'),
                aging: document.getElementById('aging-list'),
                ready_to_bottle: document.getElementById('ready_to_bottle-list'),
                bottled: document.getElementById('bottled-list')
            };
            const lotModal = document.getElementById('lot-modal');
            const lotModalTitle = document.getElementById('modal-title');
            const lotForm = document.getElementById('lot-form');
            const addLotBtn = document.getElementById('add-lot-btn');
            let traceabilityData = {};

            // =================================================================
            // INICIO DE LA CORRECCIÓN
            // =================================================================
            const renderCard = (lot) => {
                const volumeInfo = lot.total_liters ? `<p class="text-sm text-secondary">${parseFloat(lot.total_liters).toFixed(0)} L</p>` : '';
                const statusClass = `status-${lot.status.replace(/\s+/g, '-')}`;
                
                let indicatorHtml = '';
                let actionLink = `cellar_management.html#lot-action-${lot.id}`;

                if (lot.status === 'En Fermentación') {
                    if (!lot.containers || lot.containers.length === 0) {
                        indicatorHtml = '<div class="pending-action-indicator" title="Acción pendiente: Llenado Inicial"></div>';
                    } else {
                        indicatorHtml = '<div class="ready-indicator" title="Lote asignado a depósito"></div>';
                    }
                } else if (lot.status === 'En Crianza') {
                    const hasWineInTanks = lot.containers && lot.containers.some(c => c.type === 'Depósito' && c.current_volume > 0.1);
                    if (hasWineInTanks) {
                        indicatorHtml = '<div class="pending-action-indicator" title="Acción pendiente: Trasvasar a barrica"></div>';
                    } else {
                        indicatorHtml = '<div class="ready-indicator" title="Lote en barrica"></div>';
                    }
                } else if (lot.status === 'Listo para Embotellar') {
                    indicatorHtml = '<div class="ready-indicator" title="Listo para embotellar"></div>';
                    actionLink = '#'; // No lleva a ningún sitio, la acción es arrastrar
                }
                
                const cardContent = `
                    <div class="kanban-card border-accent border rounded-lg p-3 shadow-sm ${statusClass}" data-id="${lot.id}">
                        ${indicatorHtml}
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold">${lot.name}</p>
                                <p class="text-sm text-secondary">${lot.grape_variety || 'N/A'} - ${lot.vintage_year || 'N/A'}</p>
                                ${volumeInfo}
                            </div>
                            <div class="flex gap-2 text-secondary z-10">
                                <i class="fas fa-pencil-alt cursor-pointer hover:text-chestnut-brown edit-lot-btn" data-id="${lot.id}"></i>
                                <i class="fas fa-trash-alt cursor-pointer hover:text-red-600 delete-lot-btn" data-id="${lot.id}"></i>
                            </div>
                        </div>
                        ${(lot.containers && lot.containers.length > 0) ? `<ul class="text-xs text-secondary mt-1 pl-4 list-disc">${lot.containers.map(c => `<li>${c.name} (${c.type})</li>`).join('')}</ul>` : ''}
                    </div>`;

                return (lot.status === 'Embotellado' || lot.status === 'Cosechado') 
                    ? `<div>${cardContent}</div>` 
                    : `<a href="${actionLink}" class="block">${cardContent}</a>`;
            };
            // =================================================================
            // FIN DE LA CORRECCIÓN
            // =================================================================

            async function loadTraceabilityView() {
                try {
                    traceabilityData = await apiFetch('/api/traceability/kanban-view/');
                    if (!traceabilityData) throw new Error("No se recibieron datos de la vista Kanban.");

                    const keyMapping = {
                        harvested: 'harvested', fermenting: 'fermenting',
                        aging: 'aging', ready_to_bottle: 'ready_to_bottle',
                        bottled: 'bottled'
                    };

                    Object.keys(lists).forEach(key => {
                        const lotArray = traceabilityData[keyMapping[key]];
                        if (Array.isArray(lotArray)) {
                            lists[key].innerHTML = lotArray.length > 0 ? lotArray.map(renderCard).join('') : '<p class="text-xs text-center text-secondary">No hay lotes.</p>';
                        } else {
                            lists[key].innerHTML = '<p class="text-xs text-center text-red-500">Error: Datos no válidos.</p>';
                        }
                    });
                } catch (error) {
                    console.error("Error al cargar la vista de trazabilidad:", error);
                    document.getElementById('kanban-board').innerHTML = `<p class="text-center text-red-600 p-8 col-span-5">${error.message}</p>`;
                }
            }
            
            const stages = ["Cosechado", "En Fermentación", "En Crianza", "Listo para Embotellar", "Embotellado"];
            document.querySelectorAll('.kanban-list').forEach(list => {
                new Sortable(list, {
                    group: 'kanban', animation: 150, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag',
                    onMove: function (evt) {
                        const fromStatus = evt.from.dataset.status;
                        const toStatus = evt.to.dataset.status;
                        const lotId = evt.dragged.querySelector('.kanban-card').dataset.id;
                        const allLotsFlat = Object.values(traceabilityData).flat();
                        const lot = allLotsFlat.find(l => l.id === lotId);
                        if (!lot) return false;

                        const fromIndex = stages.indexOf(fromStatus);
                        const toIndex = stages.indexOf(toStatus);

                        if (toIndex > fromIndex) {
                            if (fromStatus === 'En Fermentación' && (!lot.containers || lot.containers.length === 0)) return false;
                            if (fromStatus === 'En Crianza' && (!lot.containers || !lot.containers.some(c => c.type === 'Barrica'))) return false;
                        }
                        if (toIndex < fromIndex) {
                            if (fromStatus === 'En Fermentación' && lot.containers && lot.containers.length > 0) return false;
                            if (fromStatus === 'En Crianza' && lot.containers && lot.containers.some(c => c.type === 'Barrica')) return false;
                        }
                        return true;
                    },
                    onEnd: async function (evt) {
                        const lotId = evt.item.querySelector('.kanban-card').dataset.id;
                        const toStatus = evt.to.dataset.status;
                        if (toStatus === evt.from.dataset.status) return;

                        evt.from.appendChild(evt.item);
                        if (toStatus === 'Embotellado') {
                            await startBottlingWorkflow(lotId);
                        } else {
                            try {
                                await apiFetch(`/api/traceability/wine-lots/${lotId}/status`, { method: 'PUT', body: { new_status: toStatus } });
                                alert(`Lote movido a '${toStatus}' con éxito.`);
                                await loadTraceabilityView();
                            } catch (error) {
                                alert(`Error al mover el lote: ${error.message}`);
                                await loadTraceabilityView();
                            }
                        }
                    },
                });
            });

            const bottlingModal = document.getElementById('bottling-event-modal');
            const productModal = document.getElementById('create-product-modal');
            const bottlingForm = document.getElementById('bottling-event-form');
            const productForm = document.getElementById('create-product-form');
            
            let currentBottlingLot = null; 

            async function startBottlingWorkflow(lotId) {
                const allLotsFlat = Object.values(traceabilityData).flat();
                const lot = allLotsFlat.find(l => l.id === lotId);
                if (!lot) {
                    alert("Error: No se encontró el lote.");
                    return;
                }
                
                currentBottlingLot = lot;

                bottlingForm.reset();
                document.getElementById('bottling-lot-id').value = lotId;
                document.getElementById('bottling-lot-name').textContent = lot.name;
                bottlingModal.classList.add('modal-active');
            }

            bottlingForm.addEventListener('submit', (e) => {
                e.preventDefault();
                bottlingModal.classList.remove('modal-active');
                productForm.reset();
                document.getElementById('product-lot-id').value = document.getElementById('bottling-lot-id').value;
                document.getElementById('product-lot-name').textContent = document.getElementById('bottling-lot-name').textContent;
                productModal.classList.add('modal-active');
            });

            productForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                if (!currentBottlingLot) {
                    alert("Error: No se ha encontrado información del lote para embotellar.");
                    return;
                }

                const productFormData = new FormData(productForm);
                const productData = Object.fromEntries(productFormData.entries());
                const bottlingFormData = new FormData(bottlingForm);
                const bottlingData = Object.fromEntries(bottlingFormData.entries());
                
                const sourceContainerIds = currentBottlingLot.containers.map(c => c.id);
                if (!sourceContainerIds || sourceContainerIds.length === 0) {
                    alert("Error: El lote no tiene contenedores asignados para embotellar.");
                    loadTraceabilityView();
                    return;
                }

                const lotId = document.getElementById('product-lot-id').value;

                try {
                    const requestBody = {
                        lot_id: lotId,
                        source_container_ids: sourceContainerIds,
                        bottles_produced: parseInt(bottlingData.bottles_produced, 10) || 0,
                        product_name: productData.name,
                        product_sku: productData.sku,
                        product_price: parseFloat(productData.price)
                    };
                    
                    const response = await apiFetch('/api/cellar/movements/bottling-and-create-product', {
                        method: 'POST',
                        body: requestBody
                    });

                    alert(response.message || '¡Embotellado completado con éxito!');
                    productModal.classList.remove('modal-active');
                    currentBottlingLot = null;
                    await loadTraceabilityView();
                    
                } catch (error) {
                    alert(`Error en el proceso de embotellado: ${error.message}`);
                }
            });
            
            async function openLotModal(lot = null) {
                lotForm.reset();
                const parcelSelect = document.getElementById('lot-origin_parcel_id');
                parcelSelect.innerHTML = '<option value="">Cargando parcelas...</option>';
                lotModal.classList.add('modal-active');
                try {
                    const parcels = await apiFetch('/api/parcels/');
                    parcelSelect.innerHTML = parcels.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                } catch (error) {
                    parcelSelect.innerHTML = '<option value="">Error al cargar</option>';
                }
                if (lot) {
                    lotModalTitle.textContent = 'Editar Lote de Vino';
                    Object.keys(lot).forEach(key => {
                        const input = lotForm.querySelector(`#lot-${key}`);
                        if (input) input.value = lot[key];
                    });
                } else {
                    lotModalTitle.textContent = 'Crear Nuevo Lote de Vino';
                    document.getElementById('lot-vintage_year').value = new Date().getFullYear();
                }
            }

            lotForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(lotForm);
                const data = Object.fromEntries(formData.entries());
                const lotId = data.id;
                const body = {
                    name: data.name, origin_parcel_id: data.origin_parcel_id,
                    initial_grape_kg: parseFloat(data.initial_grape_kg),
                    grape_variety: data.grape_variety, vintage_year: parseInt(data.vintage_year, 10)
                };
                try {
                    const endpoint = lotId ? `/api/traceability/wine-lots/${lotId}` : '/api/traceability/wine-lots/';
                    const method = lotId ? 'PUT' : 'POST';
                    await apiFetch(endpoint, { method, body });
                    lotModal.classList.remove('modal-active');
                    await loadTraceabilityView();
                } catch (error) {
                    alert(`Error al guardar el lote: ${error.message}`);
                }
            });

            document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', () => {
                lotModal.classList.remove('modal-active');
                bottlingModal.classList.remove('modal-active');
                productModal.classList.remove('modal-active');
            }));
            addLotBtn.addEventListener('click', () => openLotModal());

            document.body.addEventListener('click', async (e) => {
                const editTarget = e.target.closest('.edit-lot-btn');
                if (editTarget) {
                    e.preventDefault(); e.stopPropagation();
                    const lotId = editTarget.dataset.id;
                    const allLotsFlat = Object.values(traceabilityData).flat();
                    const lotData = allLotsFlat.find(l => l.id === lotId);
                    if (lotData) openLotModal(lotData);
                }
                const deleteTarget = e.target.closest('.delete-lot-btn');
                if (deleteTarget) {
                    e.preventDefault(); e.stopPropagation();
                    const lotId = deleteTarget.dataset.id;
                    if (confirm('¿Seguro que quieres eliminar este lote?')) {
                        try {
                            await apiFetch(`/api/traceability/wine-lots/${lotId}/`, { method: 'DELETE' });
                            await loadTraceabilityView();
                        } catch (error) { alert(`Error: ${error.message}`); }
                    }
                }
            });

            loadTraceabilityView();
        });
    </script>
</body>
</html>