<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GrapeIQ Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #F8F7F4; }
        .loader { border: 4px solid #e0e0e0; border-top: 4px solid #5C1A33; border-radius: 50%; width: 24px; height: 24px; animation: spin 1.5s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .wine-grad { background-image: linear-gradient(to right, #5C1A33, #8C2B4F); }
        #map { height: 500px; border-radius: 1rem; z-index: 0; }
        .tab { cursor: pointer; }
        .tab-active { border-color: #5C1A33; color: #5C1A33; font-weight: 700; }
        .details-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .kpi-value { font-size: 2.25rem; line-height: 2.5rem; font-weight: 700; }
        .kpi-trend-positive { color: #16a34a; }
        .kpi-trend-negative { color: #dc2626; }
    </style>
</head>
<body class="text-stone-800">

    <div id="login-container" class="flex items-center justify-center h-screen bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1558422239-4445a4980a3a?q=80&w=2940&auto=format&fit=crop');">
        <div class="bg-white/90 backdrop-blur-sm p-8 rounded-3xl shadow-2xl w-full max-w-sm">
            <img src="GrapeIQ.png" alt="GrapeIQ Logo" class="w-48 mx-auto mb-6">
            <div class="space-y-4">
                <div><label for="username" class="block text-stone-700 mb-2 font-semibold">Usuario</label><input type="text" id="username" class="w-full px-4 py-2 border border-stone-300 rounded-full focus:outline-none focus:ring-2 focus:ring-[#5C1A33]"></div>
                <div><label for="password" class="block text-stone-700 mb-2 font-semibold">Contraseña</label><input type="password" id="password" class="w-full px-4 py-2 border border-stone-300 rounded-full focus:outline-none focus:ring-2 focus:ring-[#5C1A33]"></div>
                <button id="login-btn" type="button" class="w-full wine-grad text-white py-3 rounded-full font-bold text-lg hover:opacity-90 transition-opacity">Entrar</button>
                <p id="login-error" class="text-red-600 text-sm pt-2 text-center font-semibold"></p>
            </div>
        </div>
    </div>

    <div id="dashboard-container" class="hidden p-4 sm:p-8">
        <header class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-4">
                <img src="GrapeIQ.png" alt="GrapeIQ Logo" class="h-10">
                <span class="text-3xl font-light text-stone-400">|</span>
                <h1 id="header-title" class="text-3xl font-semibold text-stone-700">Análisis de Rendimiento</h1>
            </div>
            <button id="logout-btn" type="button" class="bg-stone-700 text-white px-6 py-2 rounded-full font-semibold hover:bg-stone-800 transition-colors">Cerrar Sesión</button>
        </header>

        <div class="mb-6 border-b border-stone-200">
            <nav class="flex space-x-8" aria-label="Tabs">
                <button data-tab="performance" data-title="Análisis de Rendimiento" class="tab px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent tab-active">Análisis de Rendimiento</button>
                <button data-tab="forecast" data-title="Predicciones" class="tab px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Predicciones</button>
                <button data-tab="catalog" data-title="Catálogo y Stock" class="tab px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Catálogo y Stock</button>
                <button data-tab="daily-log" data-title="Registro Diario" class="tab px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Registro Diario</button>
                <button data-tab="weather" data-title="Clima" class="tab px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Clima</button>
                <button data-tab="settings" data-title="Configuración" class="tab px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Configuración</button>
            </nav>
        </div>

        <main>
            <div id="content-performance">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="font-semibold text-stone-500 mb-2">Ventas Totales</h3>
                        <p id="kpi-total-sales" class="kpi-value text-stone-800">Cargando...</p>
                        <p id="kpi-mom-change" class="font-semibold text-sm mt-1">Cargando...</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="font-semibold text-stone-500 mb-2">Margen Bruto</h3>
                        <p id="kpi-gross-margin" class="kpi-value text-stone-800">Cargando...</p>
                        <p class="text-sm text-stone-400 mt-1">Beneficio sobre ventas</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="font-semibold text-stone-500 mb-2">Unidades Transferidas</h3>
                        <p id="kpi-inventory-transfers" class="kpi-value text-stone-800">Cargando...</p>
                        <p class="text-sm text-stone-400 mt-1">Movimientos de inventario</p>
                    </div>
                     <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="font-semibold text-stone-500 mb-2">Buscador por SKU</h3>
                        <div class="flex items-center gap-2">
                            <input type="text" id="sku-search-input" placeholder="Buscar SKU..." class="w-full px-4 py-2 border border-stone-300 rounded-full focus:outline-none focus:ring-2 focus:ring-[#5C1A33]">
                        </div>
                        <div id="sku-search-result" class="mt-2 text-sm text-center font-semibold h-8"></div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-lg mb-6 flex items-center justify-center">
                    <div id="monthlySalesChartContainer" class="h-96 w-full"><canvas id="monthlySalesChart"></canvas></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg flex items-center justify-center">
                        <div id="topProfitableProductsChartContainer" class="h-96 w-full"><canvas id="topProfitableProductsChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg flex items-center justify-center">
                        <div id="topProductsByUnitsChartContainer" class="h-96 w-full"><canvas id="topProductsByUnitsChart"></canvas></div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                     <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-bold text-stone-800 mb-4">Ventas por Día de la Semana</h3>
                        <div id="weekday-heatmap" class="grid grid-cols-7 gap-2 text-center"></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg flex items-center justify-center">
                        <div id="salesByChannelChartContainer" class="h-80 w-full"><canvas id="salesByChannelChart"></canvas></div>
                    </div>
                </div>
            </div>

            <div id="content-forecast" class="hidden">
                <div class="space-y-6">
                    
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-stone-800">Predicción de Ventas por Producto (SKU)</h3>
                        <p class="text-sm text-stone-600 mb-4">Introduce el SKU de un producto para generar una predicción de ventas para los próximos 90 días.</p>
                        
                        <div class="flex items-center gap-4 mb-4">
                            <input type="text" id="sku-forecast-input" placeholder="Ej: 100009" class="w-full max-w-xs px-4 py-2 border border-stone-300 rounded-full focus:outline-none focus:ring-2 focus:ring-[#5C1A33]">
                            <button id="run-sku-forecast-btn" class="wine-grad text-white px-6 py-2 rounded-full font-semibold hover:opacity-90 flex items-center gap-2">
                                Predecir
                                <div id="forecast-loader" class="loader hidden" style="width: 16px; height: 16px; border-width: 2px;"></div>
                            </button>
                        </div>
                        <p id="sku-forecast-error" class="text-red-600 text-sm font-semibold"></p>

                        <div class="mt-4 h-96 bg-stone-50 rounded-xl p-4">
                            <canvas id="skuForecastChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-2xl shadow-lg">
                        <div class="p-6 flex justify-between items-center">
                            <h3 class="text-xl font-bold text-stone-800">Predicción de Días de Alta Demanda</h3>
                            <button class="toggle-details-btn text-2xl font-semibold text-stone-400 hover:text-stone-800 transition-colors">+</button>
                        </div>
                        <div class="details-content px-6 pb-6">
                             <p class="text-sm text-stone-600 mb-4">Identifica qué días de la semana o fechas especiales son propensos a tener picos de ventas.</p>
                             <div class="bg-stone-50 p-4 rounded-lg border">
                                 <h4 class="font-bold mb-2">Variables utilizadas:</h4>
                                 <div class="flex flex-wrap gap-2 text-sm">
                                     <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Ventas Diarias (Formulario)</span>
                                     <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">Eventos Especiales (Formulario)</span>
                                     <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full">Festivos Nacionales (Automático)</span>
                                 </div>
                             </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg">
                        <div class="p-6 flex justify-between items-center">
                            <h3 class="text-xl font-bold text-stone-800">Predicción del Impacto de Marketing</h3>
                            <button class="toggle-details-btn text-2xl font-semibold text-stone-400 hover:text-stone-800 transition-colors">+</button>
                        </div>
                        <div class="details-content px-6 pb-6">
                             <p class="text-sm text-stone-600 mb-4">Estima el retorno de la inversión (ROI) de tus campañas para optimizar el gasto publicitario.</p>
                             <div class="bg-stone-50 p-4 rounded-lg border">
                                 <h4 class="font-bold mb-2">Variables utilizadas:</h4>
                                 <div class="flex flex-wrap gap-2 text-sm">
                                     <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">Inversión y Canales (Formulario)</span>
                                     <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Ventas en días de campaña</span>
                                 </div>
                             </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg">
                        <div class="p-6 flex justify-between items-center">
                            <h3 class="text-xl font-bold text-stone-800">Predicción de Ventas según el Clima</h3>
                            <button class="toggle-details-btn text-2xl font-semibold text-stone-400 hover:text-stone-800 transition-colors">+</button>
                        </div>
                        <div class="details-content px-6 pb-6">
                             <p class="text-sm text-stone-600 mb-4">Anticipa cómo afectará el tiempo a la demanda de ciertos tipos de vino (ej. más vino blanco en días calurosos).</p>
                             <div class="bg-stone-50 p-4 rounded-lg border">
                                 <h4 class="font-bold mb-2">Variables utilizadas:</h4>
                                 <div class="flex flex-wrap gap-2 text-sm">
                                     <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full">Datos Meteorológicos (API)</span>
                                     <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Ventas por Tipo de Producto</span>
                                 </div>
                             </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-2xl shadow-lg opacity-60">
                        <div class="p-6 flex justify-between items-center">
                            <div>
                                <h3 class="text-xl font-bold text-stone-800">Predicción de Rotura de Stock</h3>
                                <p class="text-sm font-semibold text-amber-600">Próximamente</p>
                            </div>
                            <button class="toggle-details-btn text-2xl font-semibold text-stone-400 hover:text-stone-800 transition-colors">+</button>
                        </div>
                        <div class="details-content px-6 pb-6">
                             <p class="text-sm text-stone-600 mb-4">Anticipa cuándo un producto se agotará para evitar pérdidas de ventas. Se activará tras acumular datos.</p>
                             <div class="bg-stone-50 p-4 rounded-lg border">
                                 <h4 class="font-bold mb-2">Variables utilizadas:</h4>
                                 <div class="flex flex-wrap gap-2 text-sm">
                                     <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full">Stock Inicial (Catálogo)</span>
                                     <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Ritmo de Ventas Diario</span>
                                     <span class="bg-red-100 text-red-800 px-2 py-1 rounded-full">Tiempos de Entrega (Proveedores)</span>
                                 </div>
                             </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-2xl shadow-lg opacity-60">
                        <div class="p-6 flex justify-between items-center">
                             <div>
                                <h3 class="text-xl font-bold text-stone-800">Predicción de Tiempos de Entrega</h3>
                                <p class="text-sm font-semibold text-amber-600">Próximamente</p>
                            </div>
                            <button class="toggle-details-btn text-2xl font-semibold text-stone-400 hover:text-stone-800 transition-colors">+</button>
                        </div>
                        <div class="details-content px-6 pb-6">
                             <p class="text-sm text-stone-600 mb-4">Estima posibles retrasos de tus proveedores para ajustar tus planes de compra. Se activará tras acumular datos.</p>
                             <div class="bg-stone-50 p-4 rounded-lg border">
                                 <h4 class="font-bold mb-2">Variables utilizadas:</h4>
                                 <div class="flex flex-wrap gap-2 text-sm">
                                     <span class="bg-red-100 text-red-800 px-2 py-1 rounded-full">Fecha Prometida (Formulario)</span>
                                     <span class="bg-red-100 text-red-800 px-2 py-1 rounded-full">Fecha de Entrega Real (Formulario)</span>
                                     <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full">Histórico de Proveedores</span>
                                 </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="content-catalog" class="hidden">
                <div class="bg-white p-6 rounded-2xl shadow-lg mb-6">
                    <h3 class="text-xl font-bold text-stone-800 mb-2">Gestión de Stock Inicial</h3>
                    <p class="text-stone-500 mb-4 text-sm">Establece el inventario inicial para tus productos. El sistema restará las ventas diarias a partir de estos valores.</p>
                    <form id="initial-stock-form" class="space-y-4">
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                            <div><label for="stock_100009" class="block text-sm font-semibold mb-1">BOOTLEG RED</label><input type="number" id="stock_100009" placeholder="Uds." class="w-full bg-stone-50 p-2 rounded-lg border border-stone-300"></div>
                            <div><label for="stock_100024" class="block text-sm font-semibold mb-1">MOMENT DE PLAISIR</label><input type="number" id="stock_100024" placeholder="Uds." class="w-full bg-stone-50 p-2 rounded-lg border border-stone-300"></div>
                            <div><label for="stock_1001" class="block text-sm font-semibold mb-1">S SMITH CIDER</label><input type="number" id="stock_1001" placeholder="Uds." class="w-full bg-stone-50 p-2 rounded-lg border border-stone-300"></div>
                            <div><label for="stock_100145" class="block text-sm font-semibold mb-1">SCHLINK HAUS</label><input type="number" id="stock_100145" placeholder="Uds." class="w-full bg-stone-50 p-2 rounded-lg border border-stone-300"></div>
                            <div><label for="stock_100293" class="block text-sm font-semibold mb-1">SANTORINI GAVALA</label><input type="number" id="stock_100293" placeholder="Uds." class="w-full bg-stone-50 p-2 rounded-lg border border-stone-300"></div>
                        </div>
                        <div class="flex gap-4 pt-2">
                            <button type="submit" class="bg-stone-700 text-white px-6 py-2 rounded-full font-semibold hover:bg-stone-800">Guardar Stock</button>
                            <button type="button" id="reset-stock-btn" class="bg-stone-200 text-stone-700 px-6 py-2 rounded-full font-semibold hover:bg-stone-300">Resetear</button>
                        </div>
                    </form>
                </div>
                <div class="flex justify-between items-center mb-6">
                    <div class="relative">
                        <input type="text" id="sku-filter-input" placeholder="Buscar por SKU..." class="w-full max-w-xs pl-10 pr-4 py-2 border border-stone-300 rounded-full">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-stone-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
<circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </div>
                    <button id="add-product-btn" class="wine-grad text-white px-5 py-2 rounded-full font-semibold hover:opacity-90 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
    </svg>
                        Añadir Vino
                    </button>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <div class="max-h-[60vh] overflow-y-auto">
                        <table class="w-full text-left">
                            <thead class="border-b border-stone-200 sticky top-0 bg-white">
                                <tr>
                                    <th class="p-4 font-bold">Nombre del Vino</th>
                                    <th class="p-4 font-bold">SKU</th>
                                    <th class="p-4 font-bold">Precio</th>
                                    <th class="p-4 font-bold">Coste</th>
                                    <th class="p-4 font-bold">Stock</th>
                                </tr>
                            </thead>
                            <tbody id="product-table-body"></tbody>
                        </table>
                    </div>
                    <p id="catalog-placeholder" class="hidden text-center py-8 text-stone-500">Aún no has añadido ningún producto. ¡Añade el primero!</p>
                    <div id="catalog-pagination" class="flex justify-center items-center gap-4 mt-4"></div>
                </div>
            </div>
            
            <div id="content-daily-log" class="hidden">
                 <form id="daily-log-form" class="space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-bold text-stone-800 mb-4">Ventas y Costes</h3>
                        <p class="text-stone-500 mb-4 text-sm">Introduce las unidades vendidas hoy por canal y el coste actualizado de los productos.</p>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="border-b border-stone-200">
                                    <tr>
                                        <th class="p-4 font-bold text-sm">Producto</th>
                                        <th class="p-4 font-bold text-sm">Ventas Online (Uds.)</th>
                                        <th class="p-4 font-bold text-sm">Ventas Físicas (Uds.)</th>
                                        <th class="p-4 font-bold text-sm">Coste por Unidad (€)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="border-b border-stone-100">
                                        <td class="p-4 font-semibold text-sm">BOOTLEG RED - 750ML</td>
                                        <td class="p-2"><input type="number" name="sold_online_100009" placeholder="Ej: 3" class="w-full bg-stone-50 p-2 rounded-lg border border-stone-300 focus:outline-none focus:ring-2 focus:ring-[#5C1A33]"></td>
                                        <td class="p-2"><input type="number" name="sold_physical_100009" placeholder="Ej: 9" class="w-full bg-stone-50 p-2 rounded-lg border border-stone-300 focus:outline-none focus:ring-2 focus:ring-[#5C1A33]"></td>
                                        <td class="p-2"><input type="number" step="0.01" name="cost_100009" placeholder="Ej: 4.50" class="w-full bg-stone-50 p-2 rounded-lg border border-stone-300 focus:outline-none focus:ring-2 focus:ring-[#5C1A33]"></td>
                                    </tr>
                                    <tr class="border-b border-stone-100">
                                        <td class="p-4 font-semibold text-sm">MOMENT DE PLAISIR - 750ML</td>
                                        <td class="p-2"><input type="number" name="sold_online_100024" placeholder="Ej: 2" class="w-full bg-stone-50 p-2 rounded-lg border border-stone-300 focus:outline-none focus:ring-2 focus:ring-[#5C1A33]"></td>
                                        <td class="p-2"><input type="number" name="sold_physical_100024" placeholder="Ej: 6" class="w-full bg-stone-50 p-2 rounded-lg border border-stone-300 focus:outline-none focus:ring-2 focus:ring-[#5C1A33]"></td>
                                        <td class="p-2"><input type="number" step="0.01" name="cost_100024" placeholder="Ej: 5.20" class="w-full bg-stone-50 p-2 rounded-lg border border-stone-300 focus:outline-none focus:ring-2 focus:ring-[#5C1A33]"></td>
                                    </tr>
                                     <tr class="border-b border-stone-100">
                                        <td class="p-4 font-semibold text-sm">S SMITH ORGANIC PEAR CIDER - 18.7OZ</td>
                                        <td class="p-2"><input type="number" name="sold_online_1001" placeholder="Ej: 10" class="w-full bg-stone-50 p-2 rounded-lg border border-stone-300 focus:outline-none focus:ring-2 focus:ring-[#5C1A33]"></td>
                                        <td class="p-2"><input type="number" name="sold_physical_1001" placeholder="Ej: 14" class="w-full bg-stone-50 p-2 rounded-lg border border-stone-300 focus:outline-none focus:ring-2 focus:ring-[#5C1A33]"></td>
                                        <td class="p-2"><input type="number" step="0.01" name="cost_1001" placeholder="Ej: 1.80" class="w-full bg-stone-50 p-2 rounded-lg border border-stone-300 focus:outline-none focus:ring-2 focus:ring-[#5C1A33]"></td>
                                    </tr>
                                    <tr class="border-b border-stone-100">
                                        <td class="p-4 font-semibold text-sm">SCHLINK HAUS KABINETT - 750ML</td>
                                        <td class="p-2"><input type="number" name="sold_online_100145" placeholder="Ej: 1" class="w-full bg-stone-50 p-2 rounded-lg border border-stone-300 focus:outline-none focus:ring-2 focus:ring-[#5C1A33]"></td>
                                        <td class="p-2"><input type="number" name="sold_physical_100145" placeholder="Ej: 4" class="w-full bg-stone-50 p-2 rounded-lg border border-stone-300 focus:outline-none focus:ring-2 focus:ring-[#5C1A33]"></td>
                                        <td class="p-2"><input type="number" step="0.01" name="cost_100145" placeholder="Ej: 6.00" class="w-full bg-stone-50 p-2 rounded-lg border border-stone-300 focus:outline-none focus:ring-2 focus:ring-[#5C1A33]"></td>
                                    </tr>
                                    <tr>
                                        <td class="p-4 font-semibold text-sm">SANTORINI GAVALA WHITE - 750ML</td>
                                        <td class="p-2"><input type="number" name="sold_online_100293" placeholder="Ej: 3" class="w-full bg-stone-50 p-2 rounded-lg border border-stone-300 focus:outline-none focus:ring-2 focus:ring-[#5C1A33]"></td>
                                        <td class="p-2"><input type="number" name="sold_physical_100293" placeholder="Ej: 4" class="w-full bg-stone-50 p-2 rounded-lg border border-stone-300 focus:outline-none focus:ring-2 focus:ring-[#5C1A33]"></td>
                                        <td class="p-2"><input type="number" step="0.01" name="cost_100293" placeholder="Ej: 7.50" class="w-full bg-stone-50 p-2 rounded-lg border border-stone-300 focus:outline-none focus:ring-2 focus:ring-[#5C1A33]"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-2xl shadow-lg space-y-4">
                             <h3 class="text-xl font-bold text-stone-800">Marketing</h3>
                             <p class="text-stone-500 -mt-2 text-xs italic">Dejar en blanco salvo los días que haya campañas activas.</p>
                            <div><label for="marketing-investment" class="block mb-1 text-sm font-semibold">Inversión en Marketing (€)</label><input type="number" step="0.01" id="marketing-investment" placeholder="Ej: 50.00" class="w-full bg-stone-50 p-3 rounded-lg border border-stone-300 focus:outline-none focus:ring-2 focus:ring-[#5C1A33]"></div>
                            <div>
                                <label class="block mb-2 text-sm font-semibold">Canales de Marketing Activos</label>
                                <div class="flex gap-4 items-center">
                                    <label class="flex items-center gap-2"><input type="checkbox" id="channel-social" value="social_media" class="h-4 w-4 rounded border-stone-300 text-[#5C1A33] focus:ring-[#5C1A33]"> Redes Sociales</label>
                                    <label class="flex items-center gap-2"><input type="checkbox" id="channel-email" value="email" class="h-4 w-4 rounded border-stone-300 text-[#5C1A33] focus:ring-[#5C1A33]"> Email</label>
                                </div>
                            </div>
                            <div><label for="active-promotions" class="block mb-1 text-sm font-semibold">Promociones Activas</label><textarea id="active-promotions" rows="2" placeholder="Ej: 2x1 en vinos de la D.O. Ribera del Duero" class="w-full bg-stone-50 p-3 rounded-lg border border-stone-300 focus:outline-none focus:ring-2 focus:ring-[#5C1A33]"></textarea></div>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-lg space-y-4">
                            <h3 class="text-xl font-bold text-stone-800">Eventos y Proveedores</h3>
                            <p class="text-stone-500 -mt-2 text-xs italic">Dejar en blanco salvo eventos especiales o nuevos pedidos.</p>
                            <div><label for="special-events" class="block mb-1 text-sm font-semibold">Eventos Especiales</label><textarea id="special-events" rows="2" placeholder="Ej: Fiesta patronal, partido de fútbol..." class="w-full bg-stone-50 p-3 rounded-lg border border-stone-300 focus:outline-none focus:ring-2 focus:ring-[#5C1A33]"></textarea></div>
                            <div class="border-t border-stone-200 pt-4">
                                <h4 class="font-semibold text-stone-700 mb-2">Nuevo Pedido a Proveedor</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label for="supplier-name" class="block mb-1 text-sm">Nombre Proveedor</label><input type="text" id="supplier-name" placeholder="Ej: Vinos S.L." class="w-full bg-stone-50 p-3 rounded-lg border border-stone-300 focus:outline-none focus:ring-2 focus:ring-[#5C1A33]"></div>
                                    <div><label for="promised-delivery" class="block mb-1 text-sm">Fecha Prometida</label><input type="date" id="promised-delivery" class="w-full bg-stone-50 p-3 rounded-lg border border-stone-300 focus:outline-none focus:ring-2 focus:ring-[#5C1A33]"></div>
                                </div>
                                <h4 class="font-semibold text-stone-700 mt-4 mb-2">Pedidos Pendientes de Recibir</h4>
                                <div id="pending-orders-list" class="space-y-2 text-sm">
                                    <p class="text-stone-500 text-center py-2">No hay pedidos pendientes.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="w-full wine-grad text-white py-4 rounded-full font-bold text-lg hover:opacity-90 transition-opacity">Guardar Registro Diario</button>
                 </form>
            </div>

            <div id="content-weather" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4 text-stone-800">Ubicaciones Disponibles</h3>
                        <p class="text-sm text-stone-500 mb-4">Selecciona una ciudad para ver la previsión detallada.</p>
                        <div id="predefined-locations-list" class="space-y-2"></div>
                    </div>
                    <div class="lg:col-span-2">
                        <div class="bg-white p-6 rounded-2xl shadow-lg mb-6">
                            <h3 class="text-xl font-bold mb-4 text-stone-800">Tiempo Actual</h3>
                            <div id="weather-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4 text-stone-800">Previsión Detallada</h3>
                            <div id="weather-data-container" class="mt-6 space-y-4 flex items-center justify-center h-full min-h-[200px]">
                                <p class="text-center text-stone-500">Selecciona una ubicación para ver los detalles.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="content-settings" class="hidden text-center p-16 bg-white rounded-2xl shadow-lg"><h2 class="text-2xl font-bold">Configuración</h2><p class="text-stone-500">Próximamente: La gestión de tu cuenta, usuarios y facturación.</p></div>
        </main>
    </div>

    <div id="add-product-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white text-stone-800 w-full max-w-4xl p-8 rounded-3xl shadow-2xl grid grid-cols-1 md:grid-cols-2 gap-8 relative">
            <div>
                <div class="flex items-center gap-3 mb-6">
                    <div class="bg-[#5C1A33] text-white p-2 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    </div>
                    <div><h2 class="text-2xl font-bold">Añadir Nuevo Vino al Catálogo</h2><p class="text-stone-500 text-sm">Completa los campos para añadir un nuevo producto.</p></div>
                </div>
                <form id="add-product-form" class="space-y-4">
                    <h3 class="font-bold text-lg border-b border-stone-200 pb-2">Datos del vino</h3>
                    <div><label for="product-name" class="block mb-1 text-sm font-semibold">Nombre del Vino <span class="text-red-500">*</span></label><input type="text" id="product-name" required class="w-full bg-stone-50 p-3 rounded-lg border border-stone-300 focus:outline-none focus:ring-2 focus:ring-[#5C1A33]"></div>
                    <div><label for="product-sku" class="block mb-1 text-sm font-semibold">SKU / Código de Producto <span class="text-red-500">*</span></label><input type="text" id="product-sku" required class="w-full bg-stone-50 p-3 rounded-lg border border-stone-300 focus:outline-none focus:ring-2 focus:ring-[#5C1A33]"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label for="product-price" class="block mb-1 text-sm font-semibold">Precio de Venta (€) <span class="text-red-500">*</span></label><input type="number" step="0.01" id="product-price" required class="w-full bg-stone-50 p-3 rounded-lg border border-stone-300 focus:outline-none focus:ring-2 focus:ring-[#5C1A33]"></div>
                        <div><label for="product-type" class="block mb-1 text-sm font-semibold">Tipo de Vino <span class="text-red-500">*</span></label><select id="product-type" required class="w-full bg-stone-50 p-3 rounded-lg border border-stone-300 focus:outline-none focus:ring-2 focus:ring-[#5C1A33]"><option value="">Selecciona una opción</option><option value="Tinto">Tinto</option><option value="Blanco">Blanco</option><option value="Rosado">Rosado</option><option value="Espumoso">Espumoso</option><option value="Generoso">Generoso</option></select></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label for="product-cost" class="block mb-1 text-sm font-semibold">Coste de Producción (€)</label><input type="number" step="0.01" id="product-cost" class="w-full bg-stone-50 p-3 rounded-lg border border-stone-300 focus:outline-none focus:ring-2 focus:ring-[#5C1A33]"></div>
                        <div><label for="product-quantity" class="block mb-1 text-sm font-semibold">Cantidad (Stock inicial)</label><input type="number" id="product-quantity" class="w-full bg-stone-50 p-3 rounded-lg border border-stone-300 focus:outline-none focus:ring-2 focus:ring-[#5C1A33]"></div>
                    </div>
                </form>
            </div>
            <div class="bg-stone-50 p-6 rounded-2xl border border-stone-200">
                <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg">Métricas en Tiempo Real</h3><button id="clear-metrics-btn" class="text-sm text-stone-500 hover:text-stone-800">Borrar</button></div>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="bg-white p-3 rounded-lg border"><p class="text-stone-500 text-sm">Precio de venta</p><p id="metric-price" class="font-bold text-xl">-</p></div>
                    <div class="bg-white p-3 rounded-lg border"><p class="text-stone-500 text-sm">Coste por botella</p><p id="metric-cost" class="font-bold text-xl">-</p></div>
                    <div class="bg-white p-3 rounded-lg border"><p class="text-stone-500 text-sm">Margen por botella</p><p id="metric-margin-abs" class="font-bold text-xl">-</p></div>
                    <div class="bg-white p-3 rounded-lg border"><p class="text-stone-500 text-sm">Margen %</p><p id="metric-margin-perc" class="font-bold text-xl">-</p></div>
                    <div class="bg-white p-3 rounded-lg border col-span-2"><p class="text-stone-500 text-sm">Ingresos totales (estim.)</p><p id="metric-total-revenue" class="font-bold text-3xl text-green-600">-</p></div>
                </div>
                <p class="text-xs text-stone-500 mt-4 text-center">Las métricas se actualizan automáticamente al escribir.</p>
            </div>
            <div class="md:col-span-2 flex justify-end gap-4 mt-6">
                <button id="cancel-product-btn" type="button" class="bg-stone-200 px-6 py-3 rounded-full font-bold hover:bg-stone-300">Cancelar</button>
                <button id="save-product-btn" form="add-product-form" type="submit" class="wine-grad text-white px-6 py-3 rounded-full font-bold hover:opacity-90">Guardar Vino</button>
            </div>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_BASE_URL = 'http://127.0.0.1:8000';
        let charts = {};
        let map = null;
        let currentPage = 1;
        const pageSize = 10;
        let skuFilterTimeout;
        let pendingOrders = []; 
        let skuSearchTimeout;

        const DOMElements = {
            loginContainer: document.getElementById('login-container'),
            dashboardContainer: document.getElementById('dashboard-container'),
            loginBtn: document.getElementById('login-btn'),
            loginError: document.getElementById('login-error'),
            usernameInput: document.getElementById('username'),
            passwordInput: document.getElementById('password'),
            logoutBtn: document.getElementById('logout-btn'),
            headerTitle: document.getElementById('header-title'),
            kpiSales: document.getElementById('kpi-total-sales'),
            kpiTransfers: document.getElementById('kpi-inventory-transfers'),
            kpiGrossMargin: document.getElementById('kpi-gross-margin'),
            kpiMomChange: document.getElementById('kpi-mom-change'),
            dailyLogForm: document.getElementById('daily-log-form'),
            initialStockForm: document.getElementById('initial-stock-form'),
            resetStockBtn: document.getElementById('reset-stock-btn'),
            pendingOrdersList: document.getElementById('pending-orders-list'),
            performance: {
                skuSearchInput: document.getElementById('sku-search-input'),
                skuSearchResult: document.getElementById('sku-search-result'),
                weekdayHeatmap: document.getElementById('weekday-heatmap'),
            },
            weather: {
                locationsList: document.getElementById('predefined-locations-list'),
                dataContainer: document.getElementById('weather-data-container'),
                cardsContainer: document.getElementById('weather-cards-container'),
            },
            catalog: {
                addProductBtn: document.getElementById('add-product-btn'),
                tableBody: document.getElementById('product-table-body'),
                placeholder: document.getElementById('catalog-placeholder'),
                pagination: document.getElementById('catalog-pagination'),
                filterInput: document.getElementById('sku-filter-input'),
                modal: {
                    container: document.getElementById('add-product-modal'),
                    form: document.getElementById('add-product-form'),
                    cancelBtn: document.getElementById('cancel-product-btn'),
                    clearMetricsBtn: document.getElementById('clear-metrics-btn'),
                    inputs: { name: document.getElementById('product-name'), sku: document.getElementById('product-sku'), price: document.getElementById('product-price'), type: document.getElementById('product-type'), cost: document.getElementById('product-cost'), quantity: document.getElementById('product-quantity') },
                    metrics: { price: document.getElementById('metric-price'), cost: document.getElementById('metric-cost'), marginAbs: document.getElementById('metric-margin-abs'), marginPerc: document.getElementById('metric-margin-perc'), totalRevenue: document.getElementById('metric-total-revenue') }
                }
            }
        };

        const tabs = document.querySelectorAll('.tab');
        const contentDivs = {
            performance: document.getElementById('content-performance'), forecast: document.getElementById('content-forecast'),
            catalog: document.getElementById('content-catalog'), 'daily-log': document.getElementById('content-daily-log'),
            weather: document.getElementById('content-weather'), settings: document.getElementById('content-settings'),
        };
        
        const runSkuForecastBtn = document.getElementById('run-sku-forecast-btn');
        const skuInput = document.getElementById('sku-forecast-input');
        const forecastErrorEl = document.getElementById('sku-forecast-error');
        const forecastLoader = document.getElementById('forecast-loader');

        const handleSkuForecast = async () => {
            const sku = skuInput.value.trim();
            if (!sku) {
                forecastErrorEl.textContent = 'Por favor, introduce un SKU.';
                return;
            }

            forecastErrorEl.textContent = '';
            runSkuForecastBtn.disabled = true;
            forecastLoader.classList.remove('hidden');

            try {
                const forecastData = await apiFetch(`/api/forecast/sku/${sku}`);
                updateSkuForecastChart(forecastData);
            } catch (error) {
                forecastErrorEl.textContent = `Error: ${error.message}`;
                updateSkuForecastChart({ dates: [], sales: [] });
            } finally {
                runSkuForecastBtn.disabled = false;
                forecastLoader.classList.add('hidden');
            }
        };

        const updateSkuForecastChart = (data) => {
            const chart = charts.skuForecast;
            if (!chart || !data) return;
            chart.data = {
                labels: data.dates,
                datasets: [{
                    label: 'Ventas Predichas',
                    data: data.sales,
                    borderColor: '#5C1A33',
                    backgroundColor: 'rgba(92, 26, 51, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            };
            chart.update();
        };

        async function apiFetch(endpoint, options = {}) {
            const headers = { 'Content-Type': 'application/json' };
            const token = localStorage.getItem('grapeiq_token');
            if (token) { headers['Authorization'] = `Bearer ${token}`; }
            if (options.body && options.body instanceof FormData) { delete headers['Content-Type']; }
            
            const response = await fetch(`${API_BASE_URL}${endpoint}`, { ...options, headers });

            if (response.status === 401) { logout(); throw new Error("Sesión expirada o no autorizada."); }
            if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.detail || 'Ocurrió un error en la API'); }
            
            const contentType = response.headers.get("content-type");
            return contentType?.includes("application/json") ? response.json() : response.text();
        }

        function showDashboard() {
            DOMElements.loginContainer.style.display = 'none';
            DOMElements.dashboardContainer.style.display = 'block';
            tabs[0].click(); 
        }

        function handleTabClick(event) {
            const tab = event.currentTarget;
            const tabName = tab.dataset.tab;
            tabs.forEach(t => t.classList.remove('tab-active'));
            tab.classList.add('tab-active');
            DOMElements.headerTitle.textContent = tab.dataset.title;
            Object.values(contentDivs).forEach(div => div.style.display = 'none');
            contentDivs[tabName].style.display = 'block';

            if (tabName === 'weather') {
                if (!map) initMap();
                renderPredefinedCities();
                loadPredefinedCitiesWeather();
            }
            if (tabName === 'catalog') { loadProducts(); }
            if (tabName === 'performance') { loadPerformanceData(); }
        }
        
        function init() {
            DOMElements.loginBtn.addEventListener('click', handleLogin);
            DOMElements.logoutBtn.addEventListener('click', logout);
            tabs.forEach(tab => tab.addEventListener('click', handleTabClick));
            DOMElements.dailyLogForm.addEventListener('submit', handleDailyLogSubmit);
            DOMElements.initialStockForm.addEventListener('submit', handleInitialStockSubmit);
            DOMElements.resetStockBtn.addEventListener('click', handleResetStock);
            DOMElements.pendingOrdersList.addEventListener('click', handlePendingOrdersClick);
            DOMElements.performance.skuSearchInput.addEventListener('input', () => {
                clearTimeout(skuSearchTimeout);
                skuSearchTimeout = setTimeout(handleSkuSearch, 300);
            });

            document.querySelectorAll('.toggle-details-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const content = this.parentElement.nextElementSibling;
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                        this.textContent = '+';
                    } else {
                        content.style.maxHeight = content.scrollHeight + "px";
                        this.textContent = '−';
                    }
                });
            });

            const { catalog } = DOMElements;
            catalog.addProductBtn.addEventListener('click', () => catalog.modal.container.classList.remove('hidden'));
            catalog.modal.cancelBtn.addEventListener('click', () => catalog.modal.container.classList.add('hidden'));
            Object.values(catalog.modal.inputs).forEach(input => input.addEventListener('input', updateMetrics));
            catalog.modal.clearMetricsBtn.addEventListener('click', () => { catalog.modal.form.reset(); updateMetrics(); });
            catalog.modal.form.addEventListener('submit', handleSaveProduct);
            catalog.filterInput.addEventListener('input', () => {
                clearTimeout(skuFilterTimeout);
                skuFilterTimeout = setTimeout(() => loadProducts(1), 500);
            });

            if (localStorage.getItem('grapeiq_token')) {
                showDashboard();
            }
        }
        
        async function handleLogin() { 
            DOMElements.loginError.textContent = ''; 
            const formData = new FormData(); 
            formData.append('username', DOMElements.usernameInput.value); 
            formData.append('password', DOMElements.passwordInput.value); 
            try { 
                const response = await fetch(`${API_BASE_URL}/api/auth/token`, { method: 'POST', body: formData }); 
                const data = await response.json(); 
                if (!response.ok) { throw new Error(data.detail || 'Usuario o contraseña incorrectos.'); } 
                localStorage.setItem('grapeiq_token', data.access_token); 
                showDashboard(); 
            } catch (error) { 
                DOMElements.loginError.textContent = error.message; 
            } 
        }

        function logout() { 
            localStorage.removeItem('grapeiq_token'); 
            DOMElements.loginContainer.style.display = 'flex'; 
            DOMElements.dashboardContainer.style.display = 'none'; 
        }
        
        async function loadPerformanceData() { 
            try { 
                const kpis = await apiFetch('/api/data/kpis');
                
                DOMElements.kpiSales.textContent = formatCurrency(kpis.total_sales);
                DOMElements.kpiTransfers.textContent = kpis.total_inventory_transfers.toLocaleString('es-ES');
                DOMElements.kpiGrossMargin.textContent = `${kpis.gross_profit_margin.toFixed(1)}%`;
                updateMomChange(kpis.month_over_month_change);

                const [monthlySales, topProfit, topUnits, byWeekday, byChannel] = await Promise.all([
                    apiFetch('/api/data/analytics/monthly-sales'),
                    apiFetch('/api/data/analytics/top-profitable-products'),
                    apiFetch('/api/data/analytics/top-units-products'),
                    apiFetch('/api/data/analytics/sales-by-weekday'),
                    apiFetch('/api/data/analytics/sales-by-channel')
                ]); 
                
                renderMonthlySalesChart(monthlySales);
                renderTopProfitableProductsChart(topProfit);
                renderTopProductsByUnitsChart(topUnits);
                renderWeekdayHeatmap(byWeekday);
                renderSalesByChannelChart(byChannel);

            } catch (error) { 
                console.error('Error al cargar datos de rendimiento:', error); 
            } 
        }

        function formatCurrency(value) {
            if (value === null || isNaN(value)) return '€0,00';
            return `€${parseFloat(value).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        function updateMomChange(change) {
            const el = DOMElements.kpiMomChange;
            if (change === null || isNaN(change)) {
                el.innerHTML = '<span class="text-stone-400">Datos insuficientes</span>';
                return;
            }
            const isPositive = change >= 0;
            const trendClass = isPositive ? 'kpi-trend-positive' : 'kpi-trend-negative';
            const icon = isPositive ? '▲' : '▼';
            el.innerHTML = `<span class="${trendClass}">${icon} ${Math.abs(change).toFixed(1)}%</span> vs. mes anterior`;
        }

        async function handleSkuSearch() {
            const { skuSearchInput, skuSearchResult } = DOMElements.performance;
            const sku = skuSearchInput.value.trim();
            
            if (!sku) {
                skuSearchResult.innerHTML = '';
                return;
            }
            
            try {
                const data = await apiFetch(`/api/data/sales/by_sku/${sku}`);
                skuSearchResult.innerHTML = `<span class="text-stone-600">${data.product_name}:</span> <span class="text-green-700 font-bold">${formatCurrency(data.total_sales)}</span>`;
            } catch (error) {
                if(error.message.includes('404')) {
                    skuSearchResult.innerHTML = `<span class="text-red-600">SKU no encontrado</span>`;
                } else {
                    skuSearchResult.innerHTML = `<span class="text-red-600">Error</span>`;
                }
            }
        }

        async function loadProducts(page = 1) { 
            currentPage = page; 
            const offset = (page - 1) * pageSize; 
            const sku = DOMElements.catalog.filterInput.value; 
            const { catalog } = DOMElements; 
            try { 
                const products = await apiFetch(`/api/products/?limit=${pageSize}&offset=${offset}&sku=${encodeURIComponent(sku)}`); 
                const tableBody = catalog.tableBody; 
                tableBody.innerHTML = ''; 
                if (products.length > 0) { 
                    catalog.placeholder.style.display = 'none'; 
                    products.forEach(p => { 
                        const row = `<tr class="border-b border-stone-100"><td class="p-4 font-semibold">${p.name}</td><td class="p-4 text-stone-500">${p.sku}</td><td class="p-4">${p.price_per_unit ? `€${p.price_per_unit.toFixed(2)}` : '-'}</td><td class="p-4">${p.cost_per_unit ? `€${p.cost_per_unit.toFixed(2)}` : '-'}</td><td class="p-4">${p.stock_quantity != null ? p.stock_quantity : '-'}</td></tr>`; 
                        tableBody.innerHTML += row; 
                    }); 
                } else { 
                    if (page === 1) catalog.placeholder.style.display = 'block'; 
                } 
                renderPaginationControls(page, products.length === pageSize); 
            } catch (error) { 
                alert(`Error al cargar los productos: ${error.message}`); 
            } 
        }
        
        function initMap() { 
            if(map) return; 
            map = L.map('map').setView([40.41, -3.70], 5); 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' }).addTo(map); 
            setTimeout(() => map.invalidateSize(), 0); 
        }
        
        function renderPredefinedCities() {
            const list = DOMElements.weather.locationsList;
            list.innerHTML = '';
            PREDEFINED_CITIES.forEach(city => {
                const cityItem = document.createElement('div');
                cityItem.className = 'p-3 bg-stone-100 rounded-lg font-semibold text-[#5C1A33] hover:bg-stone-200 cursor-pointer';
                cityItem.textContent = city.name;
                cityItem.onclick = () => fetchAndDisplayWeather(city.lat, city.lon, city.name, true);
                list.appendChild(cityItem);
            });
        }

        async function fetchAndDisplayWeather(lat, lon, name, centerMap = false) { 
            if (map && centerMap) map.setView([lat, lon], 9); 
            const { dataContainer } = DOMElements.weather; 
            dataContainer.innerHTML = '<div class="flex justify-center"><div class="loader"></div></div>'; 
            try { 
                const weatherData = await apiFetch(`/api/weather/prediction/${lat}/${lon}`); 
                const today = weatherData.prediccion.dia[0]; 
                let html = `<div class="text-center">
                    <h4 class="text-2xl font-bold">${name}</h4>
                    <p class="text-stone-500 mb-4">${new Date(today.fecha).toLocaleDateString('es-ES', {weekday: 'long', day: 'numeric', month: 'long'})}</p>
                    <div class="bg-stone-100 p-4 rounded-2xl">
                        <p class="text-5xl font-bold">${today.temperatura.maxima}°</p>
                        <p class="text-stone-600">Temperatura Máxima Prevista</p>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-lg text-center mt-4">
                        <p class="font-bold text-lg">${today.probPrecipitacion[0].value}%</p>
                        <p class="text-sm text-stone-500">Probabilidad de Lluvia</p>
                    </div>
                </div>`; 
                dataContainer.innerHTML = html; 
            } catch (error) { 
                dataContainer.innerHTML = `<p class="text-red-500 text-center">No se pudo cargar la predicción. ${error.message}</p>`; 
            } 
        }

        async function loadPredefinedCitiesWeather() {
            const { cardsContainer } = DOMElements.weather;
            cardsContainer.innerHTML = '<div class="loader col-span-full mx-auto"></div>';
            try {
                const weatherPromises = PREDEFINED_CITIES.map(city => 
                    apiFetch(`/api/weather/current/${city.lat}/${city.lon}`).then(data => ({ ...data, name: city.name }))
                );
                const weatherResults = await Promise.all(weatherPromises);
                cardsContainer.innerHTML = '';
                weatherResults.forEach(weather => {
                    const cardHTML = `<div class="bg-stone-50 border border-stone-200 p-4 rounded-xl flex flex-col items-center justify-center text-center">
                            <h4 class="font-bold text-lg text-[#5C1A33]">${weather.name}</h4>
                            <img src="https://openweathermap.org/img/wn/${weather.icon}@2x.png" alt="${weather.description}" class="w-16 h-16">
                            <p class="text-3xl font-bold text-stone-800">${weather.temp}°C</p>
                            <p class="text-sm text-stone-500">${weather.description}</p>
                        </div>`;
                    cardsContainer.innerHTML += cardHTML;
                });
            } catch (error) {
                cardsContainer.innerHTML = `<p class="text-red-500 col-span-full text-center">Error al cargar el tiempo actual: ${error.message}</p>`;
            }
        }

        function renderChart(chartId, existingChart, type, data, options) {
            const container = document.getElementById(chartId + 'Container');
            if (!container) return null; // Salir si el contenedor no existe
            if (
                !data || 
                !data.datasets || 
                data.datasets.some(ds => !ds.data || ds.data.length === 0)
            ) {
                if (existingChart) existingChart.destroy();
                container.innerHTML = `<div class="flex items-center justify-center h-full text-stone-500 font-semibold"><canvas id="${chartId}" class="hidden"></canvas><p>No hay datos disponibles para mostrar.</p></div>`;
                return null;
            }
            container.innerHTML = `<canvas id="${chartId}"></canvas>`;
            const ctx = document.getElementById(chartId).getContext('2d');
            if (existingChart) existingChart.destroy();
            return new Chart(ctx, { type, data, options });
        }
        
        function renderMonthlySalesChart(data) {
            // Si no hay datos, usar datos de ejemplo
            if (!Array.isArray(data) || data.length === 0) {
                data = [
                    { month: "2024-01", monthly_sales: 1200 },
                    { month: "2024-02", monthly_sales: 1500 },
                    { month: "2024-03", monthly_sales: 1800 },
                    { month: "2024-04", monthly_sales: 1700 },
                    { month: "2024-05", monthly_sales: 2100 },
                    { month: "2024-06", monthly_sales: 1900 },
                    { month: "2024-07", monthly_sales: 2300 }
                ];
            }
            const chartData = {
                labels: data.map(d => new Date(d.month + '-02').toLocaleString('es-ES', { month: 'short', year: '2-digit' })),
                datasets: [{
                    label: 'Ventas Mensuales',
                    data: data.map(d => d.monthly_sales),
                    borderColor: '#5C1A33',
                    backgroundColor: 'rgba(92, 26, 51, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            };
            charts.monthlySales = renderChart('monthlySalesChart', charts.monthlySales, 'line', chartData, {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false }, title: { display: true, text: 'Evolución de Ventas Mensuales (€)', font: { size: 18, weight: 'bold' } } },
                scales: { y: { beginAtZero: true } }
            });
        }

        function renderTopProfitableProductsChart(data) {
            // Si no hay datos, usar datos de ejemplo
            if (!Array.isArray(data) || data.length === 0) {
                data = [
                    { name: "BOOTLEG RED", total_profit: 1200 },
                    { name: "MOMENT DE PLAISIR", total_profit: 950 },
                    { name: "S SMITH CIDER", total_profit: 800 },
                    { name: "SCHLINK HAUS", total_profit: 700 },
                    { name: "SANTORINI GAVALA", total_profit: 650 },
                    { name: "RIOJA RESERVA", total_profit: 600 },
                    { name: "VERDEJO", total_profit: 550 },
                    { name: "CABERNET", total_profit: 500 },
                    { name: "MERLOT", total_profit: 450 },
                    { name: "PINOT NOIR", total_profit: 400 }
                ];
            }
            const chartData = {
                labels: data.map(p => p.name),
                datasets: [{
                    axis: 'y',
                    label: 'Beneficio Total (€)',
                    data: data.map(p => p.total_profit),
                    backgroundColor: 'rgba(22, 163, 74, 0.7)',
                    borderColor: 'rgba(22, 163, 74, 1)',
                    borderWidth: 1,
                    borderRadius: 6
                }]
            };
            charts.topProfit = renderChart('topProfitableProductsChart', charts.topProfit, 'bar', chartData, {
                indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false }, title: { display: true, text: 'Top 10 Productos Más Rentables', font: { size: 18, weight: 'bold' } } },
            });
        }
        
        function renderTopProductsByUnitsChart(data) {
            // Si no hay datos, usar datos de ejemplo
            if (!Array.isArray(data) || data.length === 0) {
                data = [
                    { sku: "100009", total_units: 320 },
                    { sku: "100024", total_units: 290 },
                    { sku: "1001", total_units: 250 },
                    { sku: "100145", total_units: 210 },
                    { sku: "100293", total_units: 180 },
                    { sku: "100500", total_units: 160 },
                    { sku: "100600", total_units: 140 },
                    { sku: "100700", total_units: 120 },
                    { sku: "100800", total_units: 100 },
                    { sku: "100900", total_units: 90 }
                ];
            }
            const chartData = {
                labels: data.map(p => p.sku),
                datasets: [{
                    label: 'Unidades Vendidas',
                    data: data.map(p => p.total_units),
                    backgroundColor: [
                'rgba(59, 130, 246, 0.7)',
                'rgba(37, 99, 235, 0.7)',
                'rgba(96, 165, 250, 0.7)',
                'rgba(30, 64, 175, 0.7)',
                'rgba(147, 197, 253, 0.7)',
                'rgba(191, 219, 254, 0.7)',
                'rgba(59, 130, 246, 0.5)',
                'rgba(37, 99, 235, 0.5)',
                'rgba(96, 165, 250, 0.5)',
                'rgba(30, 64, 175, 0.5)'
            ],
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1,
                    borderRadius: 6
                }]
            };
            charts.topUnits = renderChart('topProductsByUnitsChart', charts.topUnits, 'bar', chartData, {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false }, title: { display: true, text: 'Top 10 Productos por Unidades Vendidas', font: { size: 18, weight: 'bold' } } },
                scales: { y: { beginAtZero: true } }
            });
        }
        
        function renderWeekdayHeatmap(data) {
            const heatmapContainer = DOMElements.performance.weekdayHeatmap;
            heatmapContainer.innerHTML = '';
            const weekdays = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
            const salesByDay = new Array(7).fill(0);
            data.forEach(d => {
                salesByDay[parseInt(d.weekday_num) - 1] = d.total_sales;
            });
            
            const maxSales = Math.max(...salesByDay);

            weekdays.forEach((day, index) => {
                const sales = salesByDay[index];
                const intensity = maxSales > 0 ? (sales / maxSales) : 0;
                const lightness = 90 - (intensity * 50); 
                const bgColor = `hsl(340, 65%, ${lightness}%)`;
                
                const dayCell = `
                    <div class="p-2 rounded-lg" style="background-color: ${bgColor};">
                        <p class="font-bold text-sm">${day.substring(0,3)}</p>
                        <p class="text-xs font-semibold text-stone-700">${formatCurrency(sales)}</p>
                    </div>
                `;
                heatmapContainer.innerHTML += dayCell;
            });
        }

        function renderSalesByChannelChart(data) { 
             const chartData = {
                labels: data.map(item => item.channel),
                datasets: [{ 
                    data: data.map(item => item.total_sales), 
                    backgroundColor: ['rgba(92, 26, 51, 0.8)', 'rgba(140, 43, 79, 0.8)', 'rgba(180, 80, 110, 0.8)'], 
                    borderColor: '#FFFFFF', 
                    borderWidth: 4 
                }] 
            };
            charts.channel = renderChart('salesByChannelChart', charts.channel, 'doughnut', chartData, { 
                responsive: true, maintainAspectRatio: false, 
                plugins: { 
                    legend: { position: 'top', labels: { font: { weight: 'bold' } } }, 
                    title: { display: true, text: 'Ventas por Canal', font: { weight: 'bold', size: 18 } } 
                } 
            }); 
        }

        function renderPaginationControls(page, hasNext) { const { pagination } = DOMElements.catalog; pagination.innerHTML = `<button id="prev-page-btn" class="px-4 py-2 rounded-full bg-stone-200 hover:bg-stone-300 font-semibold disabled:opacity-50" ${page === 1 ? 'disabled' : ''}>Anterior</button><span class="font-bold">Página ${page}</span><button id="next-page-btn" class="px-4 py-2 rounded-full bg-stone-200 hover:bg-stone-300 font-semibold disabled:opacity-50" ${!hasNext ? 'disabled' : ''}>Siguiente</button>`; document.getElementById('prev-page-btn').onclick = () => { if (page > 1) loadProducts(page - 1); }; document.getElementById('next-page-btn').onclick = () => { if (hasNext) loadProducts(page + 1); }; }
        function updateMetrics() { const { inputs, metrics } = DOMElements.catalog.modal; const price = parseFloat(inputs.price.value) || 0; const cost = parseFloat(inputs.cost.value) || 0; const quantity = parseInt(inputs.quantity.value) || 0; metrics.price.textContent = price > 0 ? `€${price.toFixed(2)}` : '-'; metrics.cost.textContent = cost > 0 ? `€${cost.toFixed(2)}` : '-'; if (price > 0 && cost > 0 && price >= cost) { const marginAbs = price - cost; metrics.marginAbs.textContent = `€${marginAbs.toFixed(2)}`; metrics.marginPerc.textContent = `${((marginAbs / price) * 100).toFixed(1)}%`; } else { metrics.marginAbs.textContent = '-'; metrics.marginPerc.textContent = '-'; } metrics.totalRevenue.textContent = (price > 0 && quantity > 0) ? `€${(price * quantity).toFixed(2)}` : '-'; }
        async function handleSaveProduct(e) { e.preventDefault(); const { modal } = DOMElements.catalog; const productData = { name: modal.inputs.name.value, sku: modal.inputs.sku.value, price_per_unit: parseFloat(modal.inputs.price.value), product_type: modal.inputs.type.value, cost_per_unit: modal.inputs.cost.value ? parseFloat(modal.inputs.cost.value) : null, stock_quantity: modal.inputs.quantity.value ? parseInt(modal.inputs.quantity.value) : null }; try { await apiFetch('/api/products/', { method: 'POST', body: JSON.stringify(productData) }); modal.container.classList.add('hidden'); modal.form.reset(); updateMetrics(); loadProducts(currentPage); } catch (error) { alert(`Error al guardar el producto: ${error.message}`); } }
        
        function handleInitialStockSubmit(event) {
            event.preventDefault();
            const stockData = {};
            const inputs = DOMElements.initialStockForm.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                stockData[input.id] = input.value;
                localStorage.setItem(input.id, input.value);
            });
            alert('Stock inicial guardado con éxito.');
        }

        function handleResetStock() {
            if (confirm('¿Estás seguro de que quieres resetear el stock inicial? Se borrarán los valores guardados.')) {
                DOMElements.initialStockForm.reset();
                const inputs = DOMElements.initialStockForm.querySelectorAll('input[type="number"]');
                inputs.forEach(input => localStorage.removeItem(input.id));
                alert('Stock inicial reseteado.');
            }
        }
        
        function handleDailyLogSubmit(event) {
            event.preventDefault();
            
            const salesData = [];
            const productRows = DOMElements.dailyLogForm.querySelectorAll('tbody tr');
            productRows.forEach(row => {
                const productName = row.cells[0].innerText;
                const onlineSold = row.querySelector('input[name^="sold_online"]').value;
                const physicalSold = row.querySelector('input[name^="sold_physical"]').value;
                const cost = row.querySelector('input[name^="cost"]').value;
                salesData.push({
                    productName,
                    unitsSold: {

                        online: onlineSold ? parseInt(onlineSold, 10) : 0,
                        physical: physicalSold ? parseInt(physicalSold, 10) : 0,
                    },
                    cost: cost ? parseFloat(cost) : null
                });
            });

            const supplierName = document.getElementById('supplier-name').value.trim();
            const promisedDeliveryDate = document.getElementById('promised-delivery').value;
            let supplierOrderData = null;
            if (supplierName && promisedDeliveryDate) {
                supplierOrderData = { supplierName, promisedDeliveryDate };
                const newOrder = {
                    id: Date.now(),
                    name: supplierName,
                    date: promisedDeliveryDate
                };
                pendingOrders.push(newOrder);
                renderPendingOrders();

            }
            
            const dailyData = {
                date: new Date().toISOString().split('T')[0],
                sales: salesData,
                marketing: {
                    investment: parseFloat(document.getElementById('marketing-investment').value) || 0,
                    channels: Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value),
                    promotions: document.getElementById('active-promotions').value.trim()
                },
                events: { specialEvents: document.getElementById('special-events').value.trim() },
                newSupplierOrder: supplierOrderData
            };

            console.log('Datos del Registro Diario:', JSON.stringify(dailyData, null, 2));
            alert('Datos registrados con éxito. Revisa la consola para ver el JSON.');
            DOMElements.dailyLogForm.reset();
        }
        
        function renderPendingOrders() {
            const list = DOMElements.pendingOrdersList;
            if (pendingOrders.length === 0) {
                list.innerHTML = '<p class="text-stone-500 text-center py-2">No hay pedidos pendientes.</p>';
                return;
            }
            list.innerHTML = '';
            pendingOrders.forEach(order => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center bg-stone-100 p-2 rounded-lg';
                item.innerHTML = `
                    <div>
                        <span class="font-semibold">${order.name}</span>
                        <span class="text-stone-500 ml-2"> (Prometido: ${order.date})</span>
                    </div>
                    <button data-order-id="${order.id}" class="mark-received-btn text-xs bg-green-200 text-green-800 px-2 py-1 rounded-full font-semibold hover:bg-green-300">Marcar como Recibido</button>
                `;
                list.appendChild(item);
            });
        }

        function handlePendingOrdersClick(event) {
            if (event.target.classList.contains('mark-received-btn')) {
                const orderId = parseInt(event.target.dataset.orderId, 10);
                const order = pendingOrders.find(o => o.id === orderId);
                const deliveryData = {
                    ...order,
                    receivedDate: new Date().toISOString().split('T')[0]
                };
                console.log('Pedido Recibido:', deliveryData);
                alert(`Pedido de ${order.name} marcado como recibido.`);
                
                pendingOrders = pendingOrders.filter(o => o.id !== orderId);
                renderPendingOrders();
            }
        }
        
        // Inicializar la aplicación
        if (localStorage.getItem('grapeiq_token')) {
            showDashboard();
        } else {
            DOMElements.loginContainer.style.display = 'flex';
        }
        init();

    });
</script>

</body>
</html>