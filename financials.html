<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>An√°lisis Financiero - GrapeIQ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <style>
    /* üçÇ Paleta Oto√±al para la p√°gina general */
    :root {
        --pumpkin-orange: #D96C06;
        --clay-red: #A23E48;
        --golden-ochre: #C98C32;
        --chestnut-brown: #5C4033;
        --warm-beige: #F2E2C4;
        --stone-gray: #8C8C88;
    }

    body { 
        font-family: 'Montserrat', sans-serif; 
        background-color: var(--warm-beige); 
        color: var(--chestnut-brown);
    }
    .cta-button { background-color: var(--pumpkin-orange); color: white; }
    .secondary-button { background-color: var(--clay-red); color: white; }
    .tab-active { border-color: var(--golden-ochre) !important; color: var(--golden-ochre) !important; font-weight: 700; }
    .text-highlight { color: var(--golden-ochre); }
    .text-secondary { color: var(--stone-gray); }
    .bg-dark { background-color: var(--chestnut-brown); }
    .bg-light-accent { background-color: rgba(92, 64, 51, 0.05); }
    .border-accent { border-color: rgba(92, 64, 51, 0.2); }

    /* --- ESTILOS ORIGINALES PARA LA SECCI√ìN DE COSTES --- */
    .cost-card {
        cursor: pointer;
        overflow: hidden;
        position: relative;
        z-index: 1;
        transition: box-shadow 0.4s ease;
        border-radius: 1rem;
        background-color: #FFFFFF; /* Fondo blanco original */
    }
    .cost-card:hover {
        box-shadow: 0 15px 30px -10px rgba(0,0,0,0.2);
    }
    /* Efecto hover de vino */
    .cost-card::before, .cost-card::after {
        content: '';
        position: absolute;
        left: 0;
        top: 100%;
        width: 100%;
        height: 100%;
        background-color: #8C2B4F; /* Color vino */
        z-index: -1;
        transition: top 0.6s cubic-bezier(0.7, 0, 0.3, 1);
    }
    .cost-card::after {
        background-color: #5C1A33; /* Color vino oscuro */
        transition-delay: 0.05s;
    }
    .cost-card:hover::before, .cost-card:hover::after {
        top: 0;
    }
    /* Texto se vuelve blanco en hover */
    .cost-card:hover .main-card-text,
    .cost-card:hover .main-card-text h3,
    .cost-card:hover .main-card-text p,
    .cost-card:hover .main-card-text .font-bold {
        color: #FFFFFF !important;
    }
    .cost-card:hover .chevron {
        color: rgba(255,255,255,0.7) !important;
    }
    .cost-card .chevron { transition: transform 0.8s cubic-bezier(.2,.8,.2,1), color 0.6s ease; }
    .cost-card.expanded .chevron { transform: rotate(180deg); }

    /* Estilos para los desplegables internos (par√°metros y registros) */
    .parameter-item { cursor: pointer; background-color: rgba(255,255,255,0.7); border: 1px solid rgba(0,0,0,0.05); border-radius: 0.75rem; padding: 0.75rem 1.25rem; transition: background-color 0.3s, box-shadow 0.3s; color: #1c1917; }
    .parameter-item:hover { background-color: rgba(255,255,255,1); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .parameter-item .chevron-param { transition: transform 0.5s ease; }
    .parameter-item.param-expanded .chevron-param { transform: rotate(180deg); }
    .records-container { padding-top: 0.75rem; display: flex; flex-direction: column; gap: 0.5rem; }
    .record-item { background-color: rgba(255,255,255,0.9); border: 1px solid rgba(0,0,0,0.05); padding: 0.5rem 1rem; border-radius: 0.5rem; color: #1c1917; }
    .pagination-controls { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1rem; font-size: 0.875rem; color: #57534e; }
    .pagination-btn { background-color: #e7e5e4; color: #57534e; padding: 0.25rem 0.75rem; border-radius: 999px; cursor: pointer; transition: background-color 0.2s; }
    .pagination-btn:hover { background-color: #d6d3d1; }
    .pagination-btn:disabled { background-color: #f5f5f4; color: #a8a29e; cursor: not-allowed; }
  </style>
</head>
<body>
  <div class="p-4 sm:p-8">
    <header class="flex justify-between items-center mb-6">
        <a href="performance.html" class="flex items-center gap-4">
            <img src="assets/GrapeIQ.png" alt="GrapeIQ Logo" class="h-10">
            <span class="text-3xl font-light text-secondary">|</span>
            <h1 class="text-3xl font-semibold">An√°lisis Financiero</h1>
        </a>
        <button id="logout-btn" class="bg-dark text-white px-6 py-2 rounded-full font-semibold hover:opacity-90">Cerrar Sesi√≥n</button>
    </header>

    <div class="mb-6 border-b border-accent">
       <nav class="flex space-x-8" aria-label="Tabs">
            <a href="performance.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-chestnut-brown border-transparent">An√°lisis de Rendimiento</a>
            <a href="forecast.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-chestnut-brown border-transparent">Predicciones</a>
            <a href="catalog.html" id="menu-catalogo" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-chestnut-brown border-transparent">Cat√°logo y Stock</a>
            <a href="daily-log.html" id="menu-registro-diario" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-chestnut-brown border-transparent">Registro Diario</a>
            <a href="financials.html" class="px-1 py-4 border-b-2 font-semibold text-lg tab-active">Finanzas</a>
            <a href="field_log.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-chestnut-brown border-transparent">Cuaderno de Campo</a>
            <a href="traceability.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-chestnut-brown border-transparent">Trazabilidad</a>
            <a href="cellar_management.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-chestnut-brown border-transparent">Gesti√≥n de Bodega</a>
            <a href="parcels.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-chestnut-brown border-transparent">Parcelas</a>
            <a href="weather.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-chestnut-brown border-transparent">Clima</a>
            <a href="settings.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-chestnut-brown border-transparent">Configuraci√≥n</a>
        </nav>
    </div>

    <main class="space-y-12">
        <div>
            <h2 class="text-2xl font-bold mb-4">Desglose de Costes</h2>
            <div id="loading-costs" class="text-center p-8 bg-white rounded-2xl shadow-lg"><p class="text-secondary">Cargando y calculando resumen de costes...</p></div>
            <div id="costs-container" class="space-y-4"></div>
        </div>
        
        <div>
            <div id="margins-results-container" class="hidden mb-8">
                <h2 class="text-2xl font-bold mb-4">Resultados de Rentabilidad</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg text-center"><h3 class="font-semibold text-secondary mb-2">Margen Bruto</h3><p id="result-gross-margin" class="text-5xl font-bold" style="color: var(--olive-green);">-</p></div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg text-center"><h3 class="font-semibold text-secondary mb-2">Margen Neto Real</h3><p id="result-net-margin" class="text-5xl font-bold" style="color: var(--pumpkin-orange);">-</p></div>
                </div>
            </div>
            <form id="financials-form" class="space-y-8">
                <div>
                    <h2 class="text-2xl font-bold mb-4">Calcular M√°rgenes de Rentabilidad (Agregado)</h2>
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <label for="total-revenue" class="block text-lg font-semibold mb-2">1. Ingresos Totales (Ventas) del Per√≠odo (‚Ç¨)</label>
                        <input type="number" step="0.01" id="total-revenue" placeholder="Ej: 50000.00" class="w-full max-w-sm bg-light-accent p-3 rounded-lg border-accent text-lg">
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-xl font-bold mb-4">2. Coste de los Bienes Vendidos (COGS)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div><label for="cogs-raw-material" class="block mb-1 font-semibold">Materia Prima</label><input type="number" step="0.01" id="cogs-raw-material" placeholder="Coste de uva, levaduras..." class="w-full bg-light-accent p-3 rounded-lg border-accent"></div>
                        <div><label for="cogs-packaging" class="block mb-1 font-semibold">Embotellado y Empaquetado</label><input type="number" step="0.01" id="cogs-packaging" placeholder="Botellas, corchos, cajas..." class="w-full bg-light-accent p-3 rounded-lg border-accent"></div>
                        <div><label for="cogs-production" class="block mb-1 font-semibold">Elaboraci√≥n y Crianza</label><input type="number" step="0.01" id="cogs-production" placeholder="Mano de obra, barricas..." class="w-full bg-light-accent p-3 rounded-lg border-accent"></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-xl font-bold mb-4">3. Gastos Operativos del Per√≠odo</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div><label for="op-sales-marketing" class="block mb-1 font-semibold">Venta y Marketing</label><input type="number" step="0.01" id="op-sales-marketing" placeholder="Salarios, publicidad, ferias..." class="w-full bg-light-accent p-3 rounded-lg border-accent"></div>
                        <div><label for="op-admin" class="block mb-1 font-semibold">Administrativos</label><input type="number" step="0.01" id="op-admin" placeholder="Oficina, personal, software..." class="w-full bg-light-accent p-3 rounded-lg border-accent"></div>
                        <div><label for="op-financial" class="block mb-1 font-semibold">Financieros e Impuestos</label><input type="number" step="0.01" id="op-financial" placeholder="Intereses, tasas, impuestos..." class="w-full bg-light-accent p-3 rounded-lg border-accent"></div>
                    </div>
                </div>
                <div class="flex gap-4 mt-8">
                    <button type="submit" class="cta-button px-8 py-3 rounded-full font-bold text-lg hover:opacity-90">Calcular M√°rgenes</button>
                    <button type="reset" id="reset-financials-btn" class="secondary-button px-6 py-3 rounded-full font-semibold hover:opacity-90">Limpiar Campos</button>
                </div>
            </form>
        </div>
    </main>
  </div>

  <script>
    const API_BASE_URL = 'http://127.0.0.1:8000';
    const TOKEN_KEY = 'accessToken';
    const ROLE_KEY = 'userRole';

    function requireAuth() { if (!localStorage.getItem(TOKEN_KEY)) window.location.href = 'login.html'; }
    function logout() { localStorage.removeItem(TOKEN_KEY); localStorage.removeItem(ROLE_KEY); window.location.href = 'login.html'; }
    async function apiFetch(endpoint, options = {}) {
        const headers = { 'Content-Type': 'application/json' };
        const token = localStorage.getItem(TOKEN_KEY);
        if (token) headers['Authorization'] = `Bearer ${token}`;
        const resp = await fetch(`${API_BASE_URL}${endpoint}`, { ...options, headers });
        if (resp.status === 401) { logout(); throw new Error('Sesi√≥n expirada.'); }
        if (!resp.ok) { let msg = 'Error en la API'; try { const j = await resp.json(); msg = j.detail || msg; } catch {} throw new Error(msg); }
        const ct = resp.headers.get('content-type') || '';
        return ct.includes('application/json') ? resp.json() : resp.text();
    }
    function updateUIVisibility() { const role = localStorage.getItem(ROLE_KEY); if (role === 'lector') document.querySelectorAll('#menu-catalogo, #menu-registro-diario').forEach(el => el.style.display = 'none'); }

    function setupMarginCalculator() {
        const form = document.getElementById('financials-form');
        const resetBtn = document.getElementById('reset-financials-btn');
        const resultsContainer = document.getElementById('margins-results-container');
        const grossMarginEl = document.getElementById('result-gross-margin');
        const netMarginEl = document.getElementById('result-net-margin');
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const revenue = parseFloat(document.getElementById('total-revenue').value) || 0;
            if (revenue === 0) { alert("Por favor, introduce los Ingresos Totales."); return; }
            const cogs = ['cogs-raw-material', 'cogs-packaging', 'cogs-production'].reduce((a, id) => a + (parseFloat(document.getElementById(id).value) || 0), 0);
            const opEx = ['op-sales-marketing', 'op-admin', 'op-financial'].reduce((a, id) => a + (parseFloat(document.getElementById(id).value) || 0), 0);
            grossMarginEl.textContent = `${(((revenue - cogs) / revenue) * 100).toFixed(2)}%`;
            netMarginEl.textContent = `${(((revenue - cogs - opEx) / revenue) * 100).toFixed(2)}%`;
            resultsContainer.classList.remove('hidden');
            window.scrollTo({ top: resultsContainer.offsetTop - 20, behavior: 'smooth' });
        });
        resetBtn.addEventListener('click', () => { resultsContainer.classList.add('hidden'); });
    }

    function setupCostBreakdown() {
        const container = document.getElementById('costs-container');
        const loadingDiv = document.getElementById('loading-costs');

        const categoryDetails = {
            "Vi√±edo y Vendimia": { title: "Costes de Vi√±edo y Vendimia", subtitle: "Gastos en cultivo y recolecci√≥n" },
            "Vinificaci√≥n": { title: "Costes de Vinificaci√≥n", subtitle: "Desde la uva hasta el fin de la fermentaci√≥n" },
            "Crianza y Almacenamiento": { title: "Costes de Crianza", subtitle: "Maduraci√≥n del vino" },
            "Embotellado y Empaquetado": { title: "Costes de Embotellado", subtitle: "Materiales del producto final" },
            "Comerciales y de Marketing": { title: "Costes de Marketing", subtitle: "Promoci√≥n y venta" },
            "Generales y Administrativos": { title: "Costes de Administraci√≥n", subtitle: "Gastos estructurales" }
        };

        const createCostCardHTML = (category, summary) => {
            const details = categoryDetails[category] || {};
            const percentage = summary ? summary.percentage.toFixed(2) : '0.00';
            return `
                <div class="cost-card" data-category="${category}">
                    <div class="cost-card-header p-4 relative">
                        <div class="main-card-text">
                            <h3 class="text-xl font-bold text-stone-800">${details.title || category}</h3>
                            <p class="text-stone-500">${details.subtitle}</p>
                        </div>
                        <div class="absolute top-4 right-12 text-right">
                            <div class="font-bold text-lg text-stone-700">${percentage}%</div>
                            <div class="text-sm text-stone-500">del total</div>
                        </div>
                        <div class="chevron absolute top-4 right-4 text-stone-400">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </div>
                    </div>
                    <div class="parameters-container px-4 pb-4" style="display: none;"></div>
                </div>
            `;
        };

        const createParameterItemHTML = (parameter) => `
            <div class="parameter-item" data-parameter-name="${parameter.parameter_name}" data-current-page="1">
                <div class="flex justify-between items-center">
                    <span class="font-semibold">${parameter.parameter_name}</span>
                    <div class="chevron-param text-stone-500">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </div>
                </div>
                <div class="records-container" style="display: none;"></div>
            </div>
        `;
        
        async function loadAndDisplayRecords(parameterItem) {
            const paramName = parameterItem.dataset.parameterName;
            const page = parseInt(parameterItem.dataset.currentPage, 10);
            const recordsContainer = parameterItem.querySelector('.records-container');
            
            recordsContainer.innerHTML = `<div class="text-center text-sm text-stone-500 p-2">Cargando...</div>`;
            gsap.set(recordsContainer, { height: 'auto' });

            try {
                const data = await apiFetch(`/api/financials/costs-by-parameter/${encodeURIComponent(paramName)}?page=${page}&page_size=5`);
                
                let recordsHTML = `<div class="text-center text-sm text-stone-500 p-2">No hay registros para este concepto.</div>`;
                if (data.records && data.records.length > 0) {
                    recordsHTML = data.records.map(rec => `
                        <div class="record-item flex justify-between text-sm">
                            <span>${new Date(rec.cost_date).toLocaleDateString()} - ${rec.description}</span>
                            <span class="font-bold">${rec.amount.toFixed(2)} ‚Ç¨</span>
                        </div>
                    `).join('');
                }
                
                const paginationHTML = `
                    <div class="pagination-controls">
                        <button class="pagination-btn prev-btn" ${data.page <= 1 ? 'disabled' : ''}>Anterior</button>
                        <span>P√°g. ${data.page} de ${data.total_pages || 1}</span>
                        <button class="pagination-btn next-btn" ${data.page >= data.total_pages ? 'disabled' : ''}>Siguiente</button>
                    </div>
                `;

                recordsContainer.innerHTML = recordsHTML + (data.total_pages > 1 ? paginationHTML : '');
                
                recordsContainer.querySelector('.prev-btn')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    parameterItem.dataset.currentPage = page - 1;
                    loadAndDisplayRecords(parameterItem);
                });
                recordsContainer.querySelector('.next-btn')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    parameterItem.dataset.currentPage = page + 1;
                    loadAndDisplayRecords(parameterItem);
                });

            } catch (error) {
                recordsContainer.innerHTML = `<div class="text-center text-sm text-red-600 p-2">Error al cargar.</div>`;
                console.error(error);
            }
        }

        Promise.all([
            apiFetch('/api/financials/costs-summary/'),
            apiFetch('/api/financials/cost-categories/')
        ]).then(([summaryData, categoriesData]) => {
            loadingDiv.style.display = 'none';
            const summaryMap = new Map(summaryData.details.map(item => [item.category, item]));

            Object.keys(categoryDetails).forEach(category => {
                const summary = summaryMap.get(category);
                container.insertAdjacentHTML('beforeend', createCostCardHTML(category, summary));
                const card = container.lastElementChild;
                const parametersContainer = card.querySelector('.parameters-container');
                const costParameters = categoriesData[category] || [];
                
                if(costParameters.length > 0) {
                    parametersContainer.innerHTML = costParameters.map(createParameterItemHTML).join('');
                } else {
                    parametersContainer.innerHTML = `<div class="text-center text-sm text-stone-500 p-2">No hay par√°metros definidos.</div>`;
                }
                
                card.querySelector('.cost-card-header').addEventListener('click', () => {
                    const isExpanded = card.classList.toggle('expanded');
                    gsap.to(parametersContainer, { display: isExpanded ? 'block' : 'none', duration: 0.3 });
                });

                parametersContainer.querySelectorAll('.parameter-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const isExpanded = item.classList.toggle('param-expanded');
                        const recordsContainer = item.querySelector('.records-container');
                        
                        if (isExpanded && !item.dataset.loaded) {
                            loadAndDisplayRecords(item);
                            item.dataset.loaded = 'true';
                        }
                        
                        gsap.to(recordsContainer, { display: isExpanded ? 'block' : 'none', duration: 0.3 });
                    });
                });
            });

        }).catch(error => {
            loadingDiv.innerHTML = `<p class="font-semibold" style="color: var(--clay-red);">Error al cargar datos de costes: ${error.message}</p>`;
            console.error(error);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('logout-btn')?.addEventListener('click', logout);
        requireAuth();
        updateUIVisibility();
        setupCostBreakdown();
        setupMarginCalculator();
    });
  </script>
</body>
</html>