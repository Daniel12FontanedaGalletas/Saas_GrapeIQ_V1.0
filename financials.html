<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Análisis Financiero - GrapeIQ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <style>
    /* Estilos originales del usuario */
    body { font-family:'Montserrat',sans-serif; background:#F8F7F4; }
    .wine-grad{ background-image:linear-gradient(to right,#5C1A33,#8C2B4F); }
    .tab-active{ border-color:#5C1A33; color:#5C1A33; font-weight:700; }

    /* ESTILOS para el formato de acordeón */
    .cost-card {
        cursor: pointer;
        overflow: hidden;
        position: relative;
        z-index: 1;
        transition: box-shadow 0.4s ease;
        border-radius: 1rem;
    }
    .cost-card:hover {
        box-shadow: 0 15px 30px -10px rgba(0,0,0,0.2);
    }
    
    /* --- INICIO: EFECTO HOVER DE VINO --- */
    .cost-card::before, .cost-card::after {
        content: '';
        position: absolute;
        left: 0;
        top: 100%;
        width: 100%;
        height: 100%;
        background-color: #8C2B4F;
        z-index: -1;
        transition: top 0.6s cubic-bezier(0.7, 0, 0.3, 1);
    }
    .cost-card::after {
        background-color: #5C1A33;
        transition-delay: 0.05s;
    }
    .cost-card:hover::before, .cost-card:hover::after {
        top: 0;
    }
    /* --- FIN: EFECTO HOVER DE VINO --- */

    .card-content {
        position: relative;
        z-index: 2;
        transition: color 0.6s ease;
    }
    /* El texto principal de la tarjeta se vuelve blanco en hover */
    .cost-card:hover .main-card-text,
    .cost-card:hover .main-card-text h3,
    .cost-card:hover .main-card-text p,
    .cost-card:hover .main-card-text .font-bold {
        color: #FFFFFF !important;
    }
    .cost-card:hover .chevron {
        color: rgba(255,255,255,0.7);
    }
    .cost-card:hover .percentage-bar-fg {
        background-color: #FFFFFF !important;
        opacity: 0.7;
    }
    .cost-card .blocks {
        padding-top: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    .cost-card .block {
        background-color: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(0,0,0,0.05);
        border-radius: 0.75rem;
        padding: 0.75rem 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        opacity: 0;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .cost-card .block:hover {
        transform: scale(1.02);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    /* El texto de los bloques individuales NO cambia de color en hover */
    .cost-card .block .unit, .cost-card .block span {
        color: #1c1917; /* text-stone-900 */
    }
    .cost-card .chevron {
        position: absolute;
        top: 1rem;
        right: 1.5rem;
        transition: transform 0.8s cubic-bezier(.2,.8,.2,1), color 0.6s ease;
    }
    .cost-card.expanded .chevron {
        transform: rotate(180deg);
    }
    .percentage-bar-bg {
        background-color: rgba(0,0,0,0.1);
        border-radius: 999px;
        height: 6px;
        width: 100%;
        margin-top: 0.5rem;
        overflow: hidden;
    }
    .percentage-bar-fg {
        height: 100%;
        border-radius: 999px;
        transition: width 1.2s cubic-bezier(.2,.8,.2,1);
    }
  </style>
</head>
<body class="text-stone-800">
  <div class="p-4 sm:p-8">
    <header class="flex justify-between items-center mb-6">
        <div class="flex items-center gap-4">
            <a href="performance.html" class="flex items-center gap-4">
                <img src="assets/GrapeIQ.png" alt="GrapeIQ Logo" class="h-10">
                <span class="text-3xl font-light text-stone-400">|</span>
                <h1 class="text-3xl font-semibold text-stone-700">Análisis Financiero</h1>
            </a>
        </div>
        <button id="logout-btn" class="bg-stone-700 text-white px-6 py-2 rounded-full font-semibold hover:bg-stone-800">Cerrar Sesión</button>
    </header>

    <div class="mb-6 border-b border-stone-200">
        <nav class="flex space-x-8" aria-label="Tabs">
            <a href="performance.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Análisis de Rendimiento</a>
            <a href="forecast.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Predicciones</a>
            <a href="catalog.html" id="menu-catalogo" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Catálogo y Stock</a>
            <a href="daily-log.html" id="menu-registro-diario" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Registro Diario</a>
            <a href="financials.html" class="px-1 py-4 border-b-2 font-semibold text-lg tab-active">Finanzas</a>
            <a href="field_log.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Cuaderno de Campo</a>
            <a href="traceability.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Trazabilidad</a>
            <a href="cellar_management.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Gestión de Bodega</a>
            <a href="parcels.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Parcelas</a>
            <a href="weather.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Clima</a>
            <a href="settings.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-stone-500 hover:text-stone-800 border-transparent">Configuración</a>
        </nav>
    </div>

    <main class="space-y-12">
        <div>
            <h2 class="text-2xl font-bold text-stone-700 mb-4">Parámetros y Desglose de Costes</h2>
            <div id="loading-costs" class="text-center p-8 bg-white rounded-2xl shadow-lg"><p class="text-stone-500">Cargando y calculando resumen de costes...</p></div>
            <div id="costs-container" class="space-y-4">
                </div>
        </div>
        <div>
            <div id="margins-results-container" class="hidden mb-8">
                <h2 class="text-2xl font-bold text-stone-700 mb-4">Resultados de Rentabilidad</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg text-center"><h3 class="font-semibold text-stone-500 mb-2">Margen Bruto</h3><p id="result-gross-margin" class="text-5xl font-bold text-green-700">-</p></div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg text-center"><h3 class="font-semibold text-stone-500 mb-2">Margen Neto Real</h3><p id="result-net-margin" class="text-5xl font-bold text-blue-700">-</p></div>
                </div>
            </div>
            <form id="financials-form" class="space-y-8">
                <div>
                    <h2 class="text-2xl font-bold text-stone-700 mb-4">Calcular Márgenes de Rentabilidad (Agregado)</h2>
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <label for="total-revenue" class="block text-lg font-semibold mb-2">1. Ingresos Totales (Ventas) del Período (€)</label>
                        <input type="number" step="0.01" id="total-revenue" placeholder="Ej: 50000.00" class="w-full max-w-sm bg-stone-50 p-3 rounded-lg border border-stone-300 text-lg">
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-xl font-bold text-stone-800 mb-4">2. Coste de los Bienes Vendidos (COGS)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div><label for="cogs-raw-material" class="block mb-1 font-semibold">Materia Prima</label><input type="number" step="0.01" id="cogs-raw-material" placeholder="Coste de uva, levaduras..." class="w-full bg-stone-50 p-3 rounded-lg border border-stone-300"></div>
                        <div><label for="cogs-packaging" class="block mb-1 font-semibold">Embotellado y Empaquetado</label><input type="number" step="0.01" id="cogs-packaging" placeholder="Botellas, corchos, cajas..." class="w-full bg-stone-50 p-3 rounded-lg border border-stone-300"></div>
                        <div><label for="cogs-production" class="block mb-1 font-semibold">Elaboración y Crianza</label><input type="number" step="0.01" id="cogs-production" placeholder="Mano de obra, barricas..." class="w-full bg-stone-50 p-3 rounded-lg border border-stone-300"></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-xl font-bold text-stone-800 mb-4">3. Gastos Operativos del Período</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div><label for="op-sales-marketing" class="block mb-1 font-semibold">Venta y Marketing</label><input type="number" step="0.01" id="op-sales-marketing" placeholder="Salarios, publicidad, ferias..." class="w-full bg-stone-50 p-3 rounded-lg border border-stone-300"></div>
                        <div><label for="op-admin" class="block mb-1 font-semibold">Administrativos</label><input type="number" step="0.01" id="op-admin" placeholder="Oficina, personal, software..." class="w-full bg-stone-50 p-3 rounded-lg border border-stone-300"></div>
                        <div><label for="op-financial" class="block mb-1 font-semibold">Financieros e Impuestos</label><input type="number" step="0.01" id="op-financial" placeholder="Intereses, tasas, impuestos..." class="w-full bg-stone-50 p-3 rounded-lg border border-stone-300"></div>
                    </div>
                </div>
                <div class="flex gap-4 mt-8">
                    <button type="submit" class="wine-grad text-white px-8 py-3 rounded-full font-bold text-lg hover:opacity-90">Calcular Márgenes</button>
                    <button type="reset" id="reset-financials-btn" class="bg-stone-200 text-stone-700 px-6 py-3 rounded-full font-semibold hover:bg-stone-300">Limpiar Campos</button>
                </div>
            </form>
        </div>
    </main>
  </div>

  <script>
    // --- Configuración y Autenticación Estandarizada ---
    const API_BASE_URL = 'http://127.0.0.1:8000';
    const TOKEN_KEY = 'accessToken';
    const ROLE_KEY = 'userRole';

    function requireAuth() { if (!localStorage.getItem(TOKEN_KEY)) window.location.href = 'login.html'; }
    function logout() { localStorage.removeItem(TOKEN_KEY); localStorage.removeItem(ROLE_KEY); window.location.href = 'login.html'; }
    async function apiFetch(endpoint, options = {}) {
        const headers = { 'Content-Type': 'application/json' };
        const token = localStorage.getItem(TOKEN_KEY);
        if (token) headers['Authorization'] = `Bearer ${token}`;
        const resp = await fetch(`${API_BASE_URL}${endpoint}`, { ...options, headers });
        if (resp.status === 401) { logout(); throw new Error('Sesión expirada o no autorizada.'); }
        if (!resp.ok) { let msg = 'Ocurrió un error en la API'; try { const j = await resp.json(); msg = j.detail || msg; } catch {} throw new Error(msg); }
        const ct = resp.headers.get('content-type') || '';
        return ct.includes('application/json') ? resp.json() : resp.text();
    }
    function updateUIVisibility() { const role = localStorage.getItem(ROLE_KEY); if (role === 'lector') document.querySelectorAll('#menu-catalogo, #menu-registro-diario').forEach(el => el.style.display = 'none'); }

    // --- Lógica de la Página de Finanzas ---
    function setupMarginCalculator() {
        const form = document.getElementById('financials-form');
        const resetBtn = document.getElementById('reset-financials-btn');
        const resultsContainer = document.getElementById('margins-results-container');
        const grossMarginEl = document.getElementById('result-gross-margin');
        const netMarginEl = document.getElementById('result-net-margin');
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const revenue = parseFloat(document.getElementById('total-revenue').value) || 0;
            if (revenue === 0) { alert("Por favor, introduce los Ingresos Totales."); return; }
            const cogs = ['cogs-raw-material', 'cogs-packaging', 'cogs-production'].reduce((a, id) => a + (parseFloat(document.getElementById(id).value) || 0), 0);
            const opEx = ['op-sales-marketing', 'op-admin', 'op-financial'].reduce((a, id) => a + (parseFloat(document.getElementById(id).value) || 0), 0);
            grossMarginEl.textContent = `${(((revenue - cogs) / revenue) * 100).toFixed(2)}%`;
            netMarginEl.textContent = `${(((revenue - cogs - opEx) / revenue) * 100).toFixed(2)}%`;
            resultsContainer.classList.remove('hidden');
            window.scrollTo({ top: resultsContainer.offsetTop - 20, behavior: 'smooth' });
        });
        resetBtn.addEventListener('click', () => { resultsContainer.classList.add('hidden'); });
    }

    function setupCostBreakdown() {
        const container = document.getElementById('costs-container');
        const loadingDiv = document.getElementById('loading-costs');
        let openCard = null;

        const categoryDetails = {
            "Costes de Viñedo y Vendimia": { subtitle: "Gastos en cultivo y recolección" },
            "Costes de Vinificación": { subtitle: "Desde la uva hasta el fin de la fermentación" },
            "Costes de Crianza y Almacenamiento": { subtitle: "Maduración y envejecimiento del vino" },
            "Costes de Embotellado y Empaquetado": { subtitle: "Materiales y mano de obra del producto final" },
            "Costes Comerciales y de Marketing": { subtitle: "Promoción y venta del producto" },
            "Costes Generales y Administrativos": { subtitle: "Gastos estructurales de la bodega" }
        };

        const uniformColor = { color: "bg-rose-100", border: "border-rose-200" };

        const createCard = (category, costs, summary, color) => {
            const details = categoryDetails[category] || { subtitle: 'Categoría' };
            const card = document.createElement('div');
            card.className = `cost-card p-4 rounded-xl shadow-lg ${color.color} border ${color.border}`;
            const percentage = summary ? summary.percentage : 0;

            const costItemsHTML = costs.length > 0
                ? costs.map(cost => `<div class="block"><span>${cost.parameter_name}</span><span class="unit text-stone-600">${cost.value.toFixed(2)} ${cost.unit || ''}</span></div>`).join('')
                : '<div class="block"><span class="text-stone-500">No hay parámetros de coste definidos.</span></div>';

            card.innerHTML = `
                <div class="card-content">
                    <div class="main-card-text">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-xl font-bold text-stone-800">${category}</h3>
                                <p class="text-stone-500">${details.subtitle}</p>
                            </div>
                            <div class="text-right flex-shrink-0 ml-4">
                                <div class="font-bold text-lg text-stone-700">${percentage.toFixed(2)}%</div>
                                <div class="text-sm text-stone-500">del total</div>
                            </div>
                        </div>
                        <div class="percentage-bar-bg mt-2">
                            <div class="percentage-bar-fg"></div>
                        </div>
                    </div>
                    <div class="blocks">${costItemsHTML}</div>
                </div>
                <div class="chevron text-stone-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </div>
            `;
            setTimeout(() => {
                card.querySelector('.percentage-bar-fg').style.width = `${percentage}%`;
            }, 100);
            return card;
        };

        const openCardAnim = (card) => {
            if (card.classList.contains('expanded')) return;
            card.classList.add('expanded');
            const blocks = card.querySelectorAll('.block');
            gsap.timeline()
                .to(card, { height: 'auto', duration: 1.5, ease: 'power3.inOut' })
                .fromTo(blocks, { y: -20, opacity: 0 }, { y: 0, opacity: 1, duration: 1, stagger: 0.1, ease: 'power3.out' }, "-=1.0");
        };

        const closeCardAnim = (card) => {
            if (!card || !card.classList.contains('expanded')) return;
            const blocks = card.querySelectorAll('.block');
            const initialHeight = card.querySelector('.main-card-text').offsetHeight + 32; // 32px = p-4 (16px) top + bottom
            gsap.timeline()
                .to(blocks, { y: -15, opacity: 0, duration: 0.6, stagger: 0.05 })
                .to(card, { height: initialHeight, duration: 1.2, ease: 'power3.inOut' }, "-=0.4")
                .call(() => card.classList.remove('expanded'));
        };
        
        Promise.all([
            apiFetch('/api/financials/cost-categories/'),
            apiFetch('/api/financials/costs-summary/')
        ]).then(([categoriesData, summaryData]) => {
            loadingDiv.style.display = 'none';
            const allCategories = Object.keys(categoryDetails);
            const summaryMap = new Map(summaryData.details.map(item => [item.category, item]));

            allCategories.forEach((category) => {
                const costsForCategory = categoriesData[category] || [];
                const summaryForCategory = summaryMap.get(category);
                const cardElement = createCard(category, costsForCategory, summaryForCategory, uniformColor);
                container.appendChild(cardElement);

                const initialHeight = cardElement.querySelector('.main-card-text').offsetHeight + 32;
                gsap.set(cardElement, { height: initialHeight });

                cardElement.addEventListener('click', () => {
                    if (cardElement.classList.contains('expanded')) {
                        closeCardAnim(cardElement);
                        openCard = null;
                    } else {
                        if (openCard) closeCardAnim(openCard);
                        openCard = cardElement;
                        openCardAnim(cardElement);
                    }
                });
            });

            document.addEventListener('keydown', e => { if (e.key === 'Escape' && openCard) { closeCardAnim(openCard); openCard = null; } });
        }).catch(error => {
            console.error('Error al cargar datos financieros:', error);
            loadingDiv.innerHTML = `<p class="text-red-600 font-semibold">Error al cargar datos de costes: ${error.message}</p>`;
        });
    }

    // --- Ejecución al Cargar la Página ---
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('logout-btn')?.addEventListener('click', logout);
        requireAuth();
        updateUIVisibility();
        setupMarginCalculator();
        setupCostBreakdown();
    });
  </script>
</body>
</html>