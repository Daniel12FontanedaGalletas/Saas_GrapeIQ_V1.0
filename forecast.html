<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Predicciones y Escenarios - GrapeIQ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #F8F7F4; --card-bg: rgba(255, 255, 255, 0.8); --card-nested-bg: #F9FAFB;
            --text-color: #292524; --text-secondary-color: #57534e; --header-bg-color: #44403c;
            --border-color: #e5e7eb; --border-strong-color: #d6d3d1; --tab-active-color: #5C1A33;
            --cta-button-bg: linear-gradient(to right, #5C1A33, #8C2B4F); --secondary-button-bg: #e5e7eb;
            --input-bg: rgba(255, 255, 255, 0.9); --focus-ring-color: #5C1A33;
            --loader-primary-color: #5C1A33; --loader-secondary-color: #e0e0e0;
            --success-bg: #f0fdf4; --success-text: #166534; --success-border: #86efac;
        }
        body.theme-warm {
            --bg-color: #F2E2C4; --card-bg: rgba(255, 255, 255, 0.7); --card-nested-bg: rgba(92, 64, 51, 0.05);
            --text-color: #5C4033; --text-secondary-color: #6B705C; --header-bg-color: #5C4033;
            --border-color: rgba(92, 64, 51, 0.2); --border-strong-color: rgba(92, 64, 51, 0.4);
            --tab-active-color: #C98C32; --cta-button-bg: #D96C06; --secondary-button-bg: #A23E48;
            --input-bg: rgba(92, 64, 51, 0.08); --focus-ring-color: #D96C06;
            --loader-primary-color: #D96C06; --loader-secondary-color: rgba(92, 64, 51, 0.2);
            --success-bg: #fffbeb; --success-text: #b45309; --success-border: #fcd34d;
        }
        body { font-family: 'Montserrat', sans-serif; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
        .text-primary { color: var(--text-color); } .text-secondary { color: var(--text-secondary-color); } .bg-dark { background-color: var(--header-bg-color); }
        .border-accent { border-color: var(--border-color); } .border-accent-strong { border-color: var(--border-strong-color); }
        .section-card { background-color: var(--card-bg); backdrop-filter: blur(4px); } .nested-card { background-color: var(--card-nested-bg); }
        .app-input { background-color: var(--input-bg); border-color: var(--border-strong-color); } .app-input:focus { --tw-ring-color: var(--focus-ring-color) !important; border-color: var(--focus-ring-color) !important; }
        .cta-button { background: var(--cta-button-bg); color: white; } .secondary-button { background-color: var(--secondary-button-bg); color: var(--text-color); }
        .tab-active { border-color: var(--tab-active-color) !important; color: var(--tab-active-color) !important; font-weight: 700; }
        .loader { border-radius: 50%; width: 24px; height: 24px; animation: spin 1.5s linear infinite; border: 4px solid var(--loader-secondary-color); border-top-color: var(--loader-primary-color); } @keyframes spin { 0% {transform:rotate(0);} 100% {transform:rotate(360deg);} }
        .torch-container { position: absolute; right: 220px; top: -35px; display: flex; align-items: center; cursor: pointer; user-select: none; transform: scale(0.45); z-index: 10; } .torch-container input { position: absolute; opacity: 0; } .torch { display: flex; justify-content: center; height: 150px; } .head, .stick { position: absolute; width: 30px; transform-style: preserve-3d; transform: rotateX(-30deg) rotateY(45deg); } .stick { position: relative; height: 120px; } .face { position: absolute; transform-style: preserve-3d; width: 30px; height: 30px; display: grid; grid-template-columns: 50% 50%; grid-template-rows: 50% 50%; background-color: #000000; } .top { transform: rotateX(90deg) translateZ(15px); } .left { transform: rotateY(-90deg) translateZ(15px); } .right { transform: rotateY(0deg) translateZ(15px); } .top div, .left div, .right div { width: 102%; height: 102%; } .top div:nth-child(1), .left div:nth-child(3), .right div:nth-child(3) { background-color: #ffff9760; } .top div:nth-child(2), .left div:nth-child(1), .right div:nth-child(1) { background-color: #ffd80060; } .top div:nth-child(3), .left div:nth-child(4), .right div:nth-child(4) { background-color: #ffffff60; } .top div:nth-child(4), .left div:nth-child(2), .right div:nth-child(2) { background-color: #ff8f0060; } .side { position: absolute; width: 30px; height: 120px; display: grid; grid-template-columns: 50% 50%; grid-template-rows: repeat(8, 12.5%); cursor: pointer; translate: 0 12px; } .side-left { transform: rotateY(-90deg) translateZ(15px) translateY(8px); } .side-right { transform: rotateY(0deg) translateZ(15px) translateY(8px); } .side-left div, .side-right div { width: 103%; height: 103%; } .side div:nth-child(1){background-color:#443622}.side div:nth-child(2){background-color:#2e2517}.side div:nth-child(3),.side div:nth-child(5){background-color:#4b3b23}.side div:nth-child(4),.side div:nth-child(10){background-color:#251e12}.side div:nth-child(6){background-color:#292115}.side div:nth-child(7){background-color:#4b3c26}.side div:nth-child(8){background-color:#292115}.side div:nth-child(9){background-color:#4b3a21}.side div:nth-child(11),.side div:nth-child(15){background-color:#3d311d}.side div:nth-child(12){background-color:#2c2315}.side div:nth-child(13){background-color:#493a22}.side div:nth-child(14){background-color:#2b2114}.side div:nth-child(16){background-color:#271e10} .torch-container input:checked~.torch .face{filter:drop-shadow(0 0 2px #fff) drop-shadow(0 0 10px rgba(255,237,156,.7)) drop-shadow(0 0 25px rgba(255,227,101,.4))}.torch-container input:checked~.torch .top div:nth-child(1),.torch-container input:checked~.torch .left div:nth-child(3),.torch-container input:checked~.torch .right div:nth-child(3){background-color:#ffff97}.torch-container input:checked~.torch .top div:nth-child(2),.torch-container input:checked~.torch .left div:nth-child(1),.torch-container input:checked~.torch .right div:nth-child(1){background-color:#ffd800}.torch-container input:checked~.torch .top div:nth-child(3),.torch-container input:checked~.torch .left div:nth-child(4),.torch-container input:checked~.torch .right div:nth-child(4){background-color:#fff}.torch-container input:checked~.torch .top div:nth-child(4),.torch-container input:checked~.torch .left div:nth-child(2),.torch-container input:checked~.torch .right div:nth-child(2){background-color:#ff8f00}.torch-container input:checked~.torch .side div:nth-child(1){background-color:#7c623e}.torch-container input:checked~.torch .side div:nth-child(2){background-color:#4c3d26}.torch-container input:checked~.torch .side div:nth-child(3),.torch-container input:checked~.torch .side div:nth-child(5){background-color:#937344}.torch-container input:checked~.torch .side div:nth-child(4),.torch-container input:checked~.torch .side div:nth-child(10){background-color:#3c2f1c}.torch-container input:checked~.torch .side div:nth-child(6){background-color:#423522}.torch-container input:checked~.torch .side div:nth-child(7){background-color:#9f7f50}.torch-container input:checked~.torch .side div:nth-child(8){background-color:#403320}.torch-container input:checked~.torch .side div:nth-child(9){background-color:#977748}.torch-container input:checked~.torch .side div:nth-child(11),.torch-container input:checked~.torch .side div:nth-child(15){background-color:#675231}.torch-container input:checked~.torch .side div:nth-child(12){background-color:#3d301d}.torch-container input:checked~.torch .side div:nth-child(13){background-color:#987849}.torch-container input:checked~.torch .side div:nth-child(14){background-color:#3b2e1b}.torch-container input:checked~.torch .side div:nth-child(16){background-color:#372a17}

        .explanation-panel { max-height: 0; overflow: hidden; transition: all 0.5s ease-out; padding: 0 1.5rem; opacity: 0; }
        .explanation-panel.open { max-height: 500px; padding: 1.5rem; opacity: 1; }
        .switch { font-size: 17px; position: relative; display: inline-block; width: 3.5em; height: 2em; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; box-shadow: inset 2px 5px 10px rgba(0,0,0,0.3); transition: .4s; border-radius: 5px; }
        .slider:before { position: absolute; content: ""; height: 1.4em; width: 0.1em; border-radius: 0px; left: 0.3em; bottom: 0.3em; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: var(--header-bg-color); box-shadow: inset 2px 5px 10px rgb(0, 0, 0); }
        input:checked + .slider:before { transform: translateX(2.8em) rotate(360deg); }
    </style>
</head>
<body>
<div class="p-4 sm:p-8">
    <header class="flex justify-between items-center mb-6 relative">
        <a href="performance.html" class="flex items-center gap-4">
            <img src="assets/GrapeIQ.png" alt="GrapeIQ Logo" class="h-10">
            <span class="text-3xl font-light text-secondary">|</span>
            <h1 class="text-3xl font-semibold text-primary">Predicciones y Escenarios</h1>
        </a>
        <div class="flex items-center gap-4">
            <label class="torch-container"><input id="theme-toggle" type="checkbox" /><div class="torch"><div class="head"><div class="face top"><div></div><div></div><div></div><div></div></div><div class="face left"><div></div><div></div><div></div><div></div></div><div class="face right"><div></div><div></div><div></div><div></div></div></div><div class="stick"><div class="side side-left"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div><div class="side side-right"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div></div></label>
            <button id="logout-btn" class="bg-dark text-white px-6 py-2 rounded-full font-semibold hover:opacity-90">Cerrar Sesi√≥n</button>
        </div>
    </header>

    <div class="mb-6 border-b border-accent">
        <nav class="flex space-x-8 overflow-x-auto pb-2" aria-label="Tabs">
            <a href="performance.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">An√°lisis de Rendimiento</a>
            <a href="forecast.html"      class="px-1 py-4 border-b-2 font-semibold text-lg border-transparent tab-active">Predicciones y Escenarios</a>
            <a href="catalog.html"      id="menu-catalogo" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">Cat√°logo y Stock</a>
            <a href="daily-log.html"    id="menu-registro-diario" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">Registro Diario</a>
            <a href="financials.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">Finanzas</a>
            <a href="field_log.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">Cuaderno de Campo</a>
            <a href="traceability.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">Trazabilidad</a>
            <a href="cellar_management.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">Gesti√≥n de Bodega</a>
            <a href="parcels.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">Parcelas</a>
            <a href="weather.html"      class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">Clima</a>
            <a href="settings.html"     class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">Configuraci√≥n</a>
        </nav>
    </div>

    <main class="space-y-8">
        <div class="section-card rounded-2xl shadow-lg p-6">
            <h3 class="text-2xl font-bold text-primary mb-1">1. Seleccionar Predicci√≥n Base</h3>
            <p class="text-sm text-secondary mb-4">Elige qu√© quieres predecir. Esta ser√° la base para comparar escenarios.</p>
            <select id="product-select" class="app-input w-full max-w-lg px-4 py-2 border rounded-full focus:outline-none focus:ring-2">
                <option selected disabled>Cargando opciones...</option>
            </select>
        </div>

        <div class="section-card rounded-2xl shadow-lg p-6">
            <h3 class="text-2xl font-bold text-primary mb-1">2. Simular Escenarios de Negocio</h3>
            <p class="text-sm text-secondary mb-6">Responde a preguntas clave simulando su impacto en la predicci√≥n base.</p>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="nested-card border border-accent rounded-xl p-4">
                    <h4 class="font-bold">üè∑Ô∏è Promoci√≥n en Agosto</h4>
                    <p class="text-xs text-secondary mt-1 mb-3">Calcula el aumento de ventas si lanzas una oferta durante todo el mes de agosto.</p>
                    <button id="promo-august-btn" class="w-full secondary-button font-semibold py-2 rounded-lg text-sm">Simular Promoci√≥n</button>
                </div>

                <div class="nested-card border border-accent rounded-xl p-4">
                    <h4 class="font-bold">‚òÄÔ∏è Ola de Calor</h4>
                    <p class="text-xs text-secondary mt-1 mb-3">Estima c√≥mo cambiar√≠an las ventas con un aumento de la temperatura media.</p>
                    <div class="flex items-center gap-2">
                        <input id="heatwave-slider" type="range" min="0" max="5" value="3" step="1" class="w-full">
                        <span id="heatwave-value" class="font-bold text-primary text-sm">+3¬∞C</span>
                    </div>
                </div>

                <div class="nested-card border border-accent rounded-xl p-4">
                    <h4 class="font-bold">üéâ Feria Local</h4>
                    <p class="text-xs text-secondary mt-1 mb-3">A√±ade un evento futuro para ver su impacto y planificar el stock necesario.</p>
                     <form id="event-form" class="flex items-end gap-2">
                        <div class="flex-grow"><label for="event-name" class="text-xs font-semibold">Nombre</label><input type="text" id="event-name" placeholder="Feria Local" class="app-input w-full p-2 text-sm border rounded-md"></div>
                        <div class="flex-grow-0 w-36"><label for="event-date" class="text-xs font-semibold">Fecha</label><input type="date" id="event-date" class="app-input w-full p-2 text-sm border rounded-md"></div>
                        <button type="submit" class="cta-button h-10 px-4 rounded-md font-semibold text-sm">A√±adir</button>
                    </form>
                </div>
            </div>
             <div id="events-list" class="mt-4 space-y-2"></div>
        </div>
        
        <div id="scenario-results-container" class="hidden">
             <div class="p-6 rounded-2xl" style="background-color: var(--success-bg); border: 1px solid var(--success-border);">
                <h3 class="text-xl font-bold" style="color: var(--success-text);">Resultados de la Simulaci√≥n</h3>
                <div id="scenario-results-content" class="text-sm mt-2" style="color: var(--success-text);"></div>
            </div>
        </div>


        <div id="forecast-loader" class="text-center my-8 hidden"><div class="loader inline-block"></div><p class="text-sm text-secondary mt-3">üß† Entrenando modelo y calculando...</p></div>
        <p id="forecast-error" class="text-red-600 text-sm font-semibold h-5 mb-2 text-center"></p>

        <div id="charts-container" class="space-y-8" style="display: none;">
            <div class="section-card rounded-2xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-primary">Predicci√≥n de Ventas (90 d√≠as)</h3>
                    <label class="switch"><input type="checkbox" data-target="explanation-forecast"><span class="slider"></span></label>
                </div>
                <div id="explanation-forecast" class="explanation-panel nested-card rounded-lg mb-6 border-l-4" style="border-color: var(--focus-ring-color);">
                    <h4 class="font-bold text-lg mb-2">¬øC√≥mo funciona la predicci√≥n? üß†</h4>
                    <p class="text-secondary mb-3">El modelo descompone tu historial de ventas en patrones para proyectar el futuro, considerando factores como tendencia, estacionalidades (anual y semanal), festivos, eventos personalizados, temperatura y promociones.</p>
                </div>
                <div class="h-[450px]"><canvas id="forecastChart"></canvas></div>
            </div>
            <div class="section-card rounded-2xl shadow-lg p-4 h-[400px]">
                <canvas id="componentsChart"></canvas>
            </div>
        </div>
    </main>
</div>

<script>
const API_BASE_URL = 'http://127.0.0.1:8000';
const TOKEN_KEY = 'accessToken';
let forecastChart = null, componentsChart = null;
let baseForecastData = null; 
let futureEvents = [];

function requireAuth() { if (!localStorage.getItem(TOKEN_KEY)) window.location.href = 'login.html'; }
function logout() { localStorage.clear(); window.location.href = 'login.html'; }
async function apiFetch(endpoint, options = {}) {
    const headers = { 'Content-Type': 'application/json', Authorization: `Bearer ${localStorage.getItem(TOKEN_KEY)}` };
    if (options.body && typeof options.body !== 'string') options.body = JSON.stringify(options.body);
    const resp = await fetch(`${API_BASE_URL}${endpoint}`, { ...options, headers });
    if (resp.status === 401) { logout(); throw new Error('Sesi√≥n expirada.'); }
    if (!resp.ok) { const data = await resp.json().catch(() => ({ detail: `Error HTTP ${resp.status}` })); throw new Error(data.detail); }
    if (resp.status === 204) return null;
    return resp.json();
}

async function loadProducts() {
    const select = document.getElementById('product-select');
    try {
        const products = await apiFetch('/api/products/list');
        select.innerHTML = '<option selected disabled>-- Elige una opci√≥n --</option>';
        select.appendChild(Object.assign(document.createElement('option'), { value: 'total', textContent: 'üìä -- Predecir Ventas Totales --', className: 'font-bold' }));
        products.forEach(p => select.appendChild(Object.assign(document.createElement('option'), { value: p.id, textContent: p.name })));
    } catch (e) {
        select.innerHTML = `<option selected disabled>Error al cargar: ${e.message}</option>`;
    }
}

async function fetchAndRenderForecast(selectedValue, isScenario=false) {
    if (!selectedValue || selectedValue.startsWith('--')) return;
    document.getElementById('charts-container').style.display = 'none';
    document.getElementById('forecast-loader').classList.remove('hidden');
    document.getElementById('forecast-error').textContent = '';
    document.getElementById('scenario-results-container').classList.add('hidden');
    
    const endpoint = (selectedValue === 'total') ? '/api/forecast/total' : `/api/forecast/sku/${selectedValue}`;
    try {
        const data = await apiFetch(endpoint);
        baseForecastData = data; 
        renderCharts(data);
        document.getElementById('charts-container').style.display = 'block';
    } catch (e) {
        document.getElementById('forecast-error').textContent = `Error: ${e.message}`;
    } finally {
        document.getElementById('forecast-loader').classList.add('hidden');
    }
}

async function runScenario(scenarioRegressors = [], customFutureEvents = []) {
    const selectedValue = document.getElementById('product-select').value;
    if (!selectedValue || selectedValue.startsWith('--') || !baseForecastData) {
        document.getElementById('forecast-error').textContent = 'Por favor, primero selecciona una predicci√≥n base.';
        return;
    }

    document.getElementById('forecast-loader').classList.remove('hidden');
    document.getElementById('forecast-error').textContent = '';

    const scenarioRequest = {
        product_id: selectedValue,
        periods: 90,
        future_regressors: scenarioRegressors,
        future_events: customFutureEvents
    };

    try {
        const scenarioData = await apiFetch('/api/forecast/scenario', { method: 'POST', body: scenarioRequest });
        updateForecastChart(scenarioData.prediction);
        return scenarioData.prediction;
    } catch (e) {
        document.getElementById('forecast-error').textContent = `Error en escenario: ${e.message}`;
    } finally {
        document.getElementById('forecast-loader').classList.add('hidden');
    }
    return null;
}

function displayScenarioResults(title, message) {
    const container = document.getElementById('scenario-results-container');
    const content = document.getElementById('scenario-results-content');
    content.innerHTML = `<strong>${title}:</strong> ${message}`;
    container.classList.remove('hidden');
}


function renderCharts(data) {
    const theme = getChartTheme();
    renderForecastChart(data.prediction, theme);
    renderComponentsChart(data.prediction.map(p => p.date), data.components, theme);
}

function getChartTheme() {
    const styles = getComputedStyle(document.documentElement);
    return {
        forecastColor: styles.getPropertyValue('--focus-ring-color').trim(),
        textColor: styles.getPropertyValue('--text-color').trim(),
        secondaryTextColor: styles.getPropertyValue('--text-secondary-color').trim(),
        gridColor: styles.getPropertyValue('--border-color').trim(),
        confidenceBgColor: styles.getPropertyValue('--focus-ring-color').trim() + '20',
        componentColors: ['#3b82f6', '#16a34a', '#ef4444', '#9333ea']
    };
}

function renderForecastChart(predictionData, theme) {
    if (forecastChart) forecastChart.destroy();
    const labels = predictionData.map(d => d.date);
    const forecastValues = predictionData.map(d => d.forecast);
    const lowerBound = predictionData.map(d => d.forecast_lower);
    const upperBound = predictionData.map(d => d.forecast_upper);

    const ctx = document.getElementById('forecastChart').getContext('2d');
    forecastChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                { label: 'Predicci√≥n Base', data: baseForecastData ? baseForecastData.prediction.map(p => p.forecast) : forecastValues, borderColor: theme.secondaryTextColor, borderDash: [5, 5], tension: 0.2, pointRadius: 0, borderWidth: 1.5 },
                { label: 'Predicci√≥n de Demanda', data: forecastValues, borderColor: theme.forecastColor, backgroundColor: 'transparent', tension: 0.2, pointRadius: 0, borderWidth: 3 },
                { label: 'Intervalo de Confianza', data: upperBound, fill: '+1', backgroundColor: theme.confidenceBgColor, borderColor: 'transparent', pointRadius: 0 },
                { label: 'L√≠mite Inferior', data: lowerBound, fill: false, borderColor: 'transparent', pointRadius: 0 }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: theme.secondaryTextColor }, grid: { color: theme.gridColor }, title: { display: true, text: 'Unidades Vendidas', color: theme.secondaryTextColor } }, x: { ticks: { color: theme.secondaryTextColor }, grid: { color: theme.gridColor } } } }
    });
}

function updateForecastChart(scenarioPrediction) {
    if (!forecastChart) return;
    forecastChart.data.datasets[1].data = scenarioPrediction.map(p => p.forecast);
    forecastChart.data.datasets[1].label = 'Predicci√≥n de Escenario';
    forecastChart.update();
}

function renderComponentsChart(labels, components, theme) {
    if (componentsChart) componentsChart.destroy();
    const ctx = document.getElementById('componentsChart').getContext('2d');
    componentsChart = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [ { label: 'Tendencia', data: components.trend, borderColor: theme.componentColors[0], fill: false, pointRadius: 0, borderWidth: 2 }, { label: 'Estacionalidad Anual', data: components.yearly, borderColor: theme.componentColors[1], fill: false, pointRadius: 0, borderWidth: 2 }, { label: 'Estacionalidad Semanal', data: components.weekly, borderColor: theme.componentColors[2], fill: false, pointRadius: 0, borderWidth: 2 }, { label: 'Regresores (Clima, Fiestas, etc.)', data: components.regressors, borderColor: theme.componentColors[3], fill: false, pointRadius: 0, borderWidth: 2 }, ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'top', labels: { color: theme.textColor } }, title: { display: true, text: 'Componentes de la Predicci√≥n (Explicabilidad)', font: { size: 16 }, color: theme.textColor } }, scales: { y: { ticks: { color: theme.secondaryTextColor }, grid: { color: theme.gridColor }, title: { display: true, text: 'Impacto en Unidades', color: theme.secondaryTextColor } }, x: { ticks: { color: theme.secondaryTextColor }, grid: { color: theme.gridColor } } } } });
}

function renderEventsList() {
    const listEl = document.getElementById('events-list');
    listEl.innerHTML = '';
    if (futureEvents.length === 0) {
        listEl.innerHTML = '<p class="text-xs text-secondary text-center">No hay eventos a√±adidos.</p>';
        return;
    }
    futureEvents.forEach((event, index) => {
        const eventEl = document.createElement('div');
        eventEl.className = 'flex justify-between items-center text-sm nested-card p-1 px-2 rounded border border-accent';
        eventEl.innerHTML = `<span>üìÖ <strong>${event.holiday}</strong> el ${event.ds}</span><button data-index="${index}" class="text-red-500 font-bold px-1">&times;</button>`;
        listEl.appendChild(eventEl);
    });
}

document.addEventListener('DOMContentLoaded', () => {
    requireAuth();
    document.getElementById('logout-btn').addEventListener('click', logout);
    loadProducts();
    
    document.getElementById('product-select').addEventListener('change', (e) => {
        futureEvents = [];
        renderEventsList();
        fetchAndRenderForecast(e.target.value);
    });

    // --- L√≥gica de Escenarios Guiados ---

    // 1. Promoci√≥n en Agosto
    document.getElementById('promo-august-btn').addEventListener('click', async () => {
        const augustPromo = [{
            start_date: '2025-08-01', end_date: '2025-08-31',
            name: 'on_promotion', value: 1.0
        }];
        const scenarioPrediction = await runScenario(augustPromo, futureEvents);
        if (scenarioPrediction && baseForecastData) {
            const baseTotal = baseForecastData.prediction.reduce((sum, p) => sum + p.forecast, 0);
            const scenarioTotal = scenarioPrediction.reduce((sum, p) => sum + p.forecast, 0);
            const increase = scenarioTotal - baseTotal;
            const percentageIncrease = (increase / baseTotal) * 100;
            displayScenarioResults(
                "Impacto de la Promoci√≥n en Agosto",
                `Se estima un aumento de <strong>${increase.toFixed(0)} unidades</strong> vendidas (+${percentageIncrease.toFixed(1)}%).`
            );
        }
    });

    // 2. Ola de Calor
    const heatwaveSlider = document.getElementById('heatwave-slider');
    heatwaveSlider.addEventListener('input', (e) => {
        document.getElementById('heatwave-value').textContent = `+${e.target.value}¬∞C`;
    });
    heatwaveSlider.addEventListener('change', async (e) => {
        const tempIncrease = parseFloat(e.target.value);
        // Simulaci√≥n simplificada del impacto de la temperatura (mejora futura: regresor)
        if (baseForecastData) {
            const scenarioPrediction = JSON.parse(JSON.stringify(baseForecastData.prediction)); // Deep copy
            scenarioPrediction.forEach(p => {
                const multiplier = 1 + (tempIncrease * 0.035); // Asumimos un 3.5% de aumento por grado
                p.forecast = Math.max(0, p.forecast * multiplier);
            });
            updateForecastChart(scenarioPrediction);
            
            const baseTotal = baseForecastData.prediction.reduce((sum, p) => sum + p.forecast, 0);
            const scenarioTotal = scenarioPrediction.reduce((sum, p) => sum + p.forecast, 0);
            const increase = scenarioTotal - baseTotal;
            const percentageIncrease = (increase / baseTotal) * 100;

            displayScenarioResults(
                `Impacto de Ola de Calor de +${tempIncrease}¬∞C`,
                `La demanda podr√≠a aumentar un <strong>${percentageIncrease.toFixed(1)}%</strong>, resultando en <strong>${increase.toFixed(0)} unidades</strong> adicionales.`
            );
        }
    });

    // 3. Feria Local (Eventos)
    const eventForm = document.getElementById('event-form');
    eventForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const nameInput = document.getElementById('event-name');
        const dateInput = document.getElementById('event-date');
        if (nameInput.value && dateInput.value) {
            futureEvents.push({ holiday: nameInput.value, ds: dateInput.value });
            renderEventsList();
            const scenarioPrediction = await runScenario([], futureEvents);
             if (scenarioPrediction && baseForecastData) {
                const eventDate = new Date(dateInput.value);
                const baseSalesOnEventDay = baseForecastData.prediction.find(p => new Date(p.date).toDateString() === eventDate.toDateString())?.forecast || 0;
                const scenarioSalesOnEventDay = scenarioPrediction.find(p => new Date(p.date).toDateString() === eventDate.toDateString())?.forecast || 0;
                const increase = scenarioSalesOnEventDay - baseSalesOnEventDay;
                 displayScenarioResults(
                    `Impacto del Evento "${nameInput.value}"`,
                    `Se estima una venta de <strong>${scenarioSalesOnEventDay.toFixed(0)} unidades</strong> ese d√≠a, lo que supone un aumento de <strong>${increase.toFixed(0)} unidades</strong> sobre la predicci√≥n base. ¬°Prepara tu stock!`
                );
             }
            eventForm.reset();
        }
    });

    document.getElementById('events-list').addEventListener('click', async (e) => {
        if (e.target.tagName === 'BUTTON') {
            futureEvents.splice(parseInt(e.target.dataset.index, 10), 1);
            renderEventsList();
            const scenarioPrediction = await runScenario([], futureEvents);
            if(futureEvents.length === 0){
                 document.getElementById('scenario-results-container').classList.add('hidden');
            }
        }
    });

    const themeToggle = document.getElementById('theme-toggle');
    const applyTheme = (theme) => {
        document.body.classList.toggle('theme-warm', theme === 'warm');
        if (themeToggle) themeToggle.checked = (theme === 'warm');
        if (baseForecastData) renderCharts(baseForecastData);
    };
    applyTheme(localStorage.getItem('theme') || 'light');
    if (themeToggle) themeToggle.addEventListener('change', () => {
        const newTheme = themeToggle.checked ? 'warm' : 'light';
        localStorage.setItem('theme', newTheme);
        applyTheme(newTheme);
    });
    
    document.querySelectorAll('input[type="checkbox"][data-target]').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
            const targetPanel = document.getElementById(e.target.dataset.target);
            if (targetPanel) targetPanel.classList.toggle('open', e.target.checked);
        });
    });

    renderEventsList();
});
</script>
</body>
</html>