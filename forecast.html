<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Predicciones y Escenarios - GrapeIQ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- üé® SISTEMA DE TEMAS --- */
        :root { /* üí° Tema Claro por Defecto */
            --bg-color: #F8F7F4;
            --card-bg: rgba(255, 255, 255, 0.7);
            --card-nested-bg: #F9FAFB; /* gray-50 */
            --text-color: #292524; /* stone-800 */
            --text-secondary-color: #57534e; /* stone-600 */
            --header-bg-color: #44403c; /* stone-700 */
            --border-color: #e5e7eb; /* stone-200 */
            --border-strong-color: #d6d3d1; /* stone-300 */
            --tab-active-color: #5C1A33;
            --cta-button-bg: linear-gradient(to right, #5C1A33, #8C2B4F);
            --secondary-button-bg: #e5e7eb; /* gray-200 */
            --input-bg: rgba(255, 255, 255, 0.7);
            --focus-ring-color: #5C1A33;
            --loader-primary-color: #5C1A33;
            --loader-secondary-color: #e0e0e0;
        }

        body.theme-warm { /* üçÇ Tema Oto√±al C√°lido */
            --bg-color: #F2E2C4;
            --card-bg: rgba(255, 255, 255, 0.6);
            --card-nested-bg: rgba(92, 64, 51, 0.05);
            --text-color: #5C4033;
            --text-secondary-color: #6B705C;
            --header-bg-color: #5C4033;
            --border-color: rgba(92, 64, 51, 0.2);
            --border-strong-color: rgba(92, 64, 51, 0.4);
            --tab-active-color: #C98C32;
            --cta-button-bg: #D96C06;
            --secondary-button-bg: #A23E48;
            --input-bg: rgba(92, 64, 51, 0.05);
            --focus-ring-color: #D96C06;
            --loader-primary-color: #D96C06;
            --loader-secondary-color: rgba(92, 64, 51, 0.2);
        }

        /* --- Estilos Generales con Variables --- */
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .text-primary { color: var(--text-color); }
        .text-secondary { color: var(--text-secondary-color); }
        .bg-dark { background-color: var(--header-bg-color); }
        .border-accent { border-color: var(--border-color); }
        .border-accent-strong { border-color: var(--border-strong-color); }
        .section-card { background-color: var(--card-bg); }
        .nested-card { background-color: var(--card-nested-bg); }
        .app-input { background-color: var(--input-bg); border-color: var(--border-strong-color); }
        .app-input:focus { --tw-ring-color: var(--focus-ring-color) !important; border-color: var(--focus-ring-color) !important; }
        .cta-button { background: var(--cta-button-bg); color: white; }
        .secondary-button { background-color: var(--secondary-button-bg); color: var(--text-color); }
        .tab-active { border-color: var(--tab-active-color) !important; color: var(--tab-active-color) !important; font-weight: 700; }
        .loader { border-radius: 50%; width: 16px; height: 16px; animation: spin 1.5s linear infinite; border: 4px solid var(--loader-secondary-color); border-top-color: var(--loader-primary-color); }
        @keyframes spin { 0% {transform:rotate(0);} 100% {transform:rotate(360deg);} }
        .details-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }

        /* --- CSS DE LA ANTORCHA --- */
        .torch-container { position: absolute; right: 220px; top: -35px; display: flex; align-items: center; cursor: pointer; user-select: none; transform: scale(0.45); z-index: 10; }
        .torch-container input { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
        .torch { display: flex; justify-content: center; height: 150px; }
        .head, .stick { position: absolute; width: 30px; transform-style: preserve-3d; transform: rotateX(-30deg) rotateY(45deg); }
        .stick { position: relative; height: 120px; }
        .face { position: absolute; transform-style: preserve-3d; width: 30px; height: 30px; display: grid; grid-template-columns: 50% 50%; grid-template-rows: 50% 50%; background-color: #000000; }
        .top { transform: rotateX(90deg) translateZ(15px); } .left { transform: rotateY(-90deg) translateZ(15px); } .right { transform: rotateY(0deg) translateZ(15px); }
        .top div, .left div, .right div { width: 102%; height: 102%; }
        .top div:nth-child(1), .left div:nth-child(3), .right div:nth-child(3) { background-color: #ffff9760; } .top div:nth-child(2), .left div:nth-child(1), .right div:nth-child(1) { background-color: #ffd80060; } .top div:nth-child(3), .left div:nth-child(4), .right div:nth-child(4) { background-color: #ffffff60; } .top div:nth-child(4), .left div:nth-child(2), .right div:nth-child(2) { background-color: #ff8f0060; }
        .side { position: absolute; width: 30px; height: 120px; display: grid; grid-template-columns: 50% 50%; grid-template-rows: repeat(8, 12.5%); cursor: pointer; translate: 0 12px; }
        .side-left { transform: rotateY(-90deg) translateZ(15px) translateY(8px); } .side-right { transform: rotateY(0deg) translateZ(15px) translateY(8px); }
        .side-left div, .side-right div { width: 103%; height: 103%; }
        .side div:nth-child(1) { background-color: #443622; } .side div:nth-child(2) { background-color: #2e2517; } .side div:nth-child(3), .side div:nth-child(5) { background-color: #4b3b23; } .side div:nth-child(4), .side div:nth-child(10) { background-color: #251e12; } .side div:nth-child(6) { background-color: #292115; } .side div:nth-child(7) { background-color: #4b3c26; } .side div:nth-child(8) { background-color: #292115; } .side div:nth-child(9) { background-color: #4b3a21; } .side div:nth-child(11), .side div:nth-child(15) { background-color: #3d311d; } .side div:nth-child(12) { background-color: #2c2315; } .side div:nth-child(13) { background-color: #493a22; } .side div:nth-child(14) { background-color: #2b2114; } .side div:nth-child(16) { background-color: #271e10; }
        .torch-container input:checked ~ .torch .face { filter: drop-shadow(0px 0px 2px #fff) drop-shadow(0px 0px 10px rgba(255, 237, 156, 0.7)) drop-shadow(0px 0px 25px rgba(255, 227, 101, 0.4)); }
        .torch-container input:checked ~ .torch .top div:nth-child(1), .torch-container input:checked ~ .torch .left div:nth-child(3), .torch-container input:checked ~ .torch .right div:nth-child(3) { background-color: #ffff97; } .torch-container input:checked ~ .torch .top div:nth-child(2), .torch-container input:checked ~ .torch .left div:nth-child(1), .torch-container input:checked ~ .torch .right div:nth-child(1) { background-color: #ffd800; } .torch-container input:checked ~ .torch .top div:nth-child(3), .torch-container input:checked ~ .torch .left div:nth-child(4), .torch-container input:checked ~ .torch .right div:nth-child(4) { background-color: #fff; } .torch-container input:checked ~ .torch .top div:nth-child(4), .torch-container input:checked ~ .torch .left div:nth-child(2), .torch-container input:checked ~ .torch .right div:nth-child(2) { background-color: #ff8f00; } .torch-container input:checked ~ .torch .side div:nth-child(1) { background-color: #7c623e; } .torch-container input:checked ~ .torch .side div:nth-child(2) { background-color: #4c3d26; } .torch-container input:checked ~ .torch .side div:nth-child(3), .torch-container input:checked ~ .torch .side div:nth-child(5) { background-color: #937344; } .torch-container input:checked ~ .torch .side div:nth-child(4), .torch-container input:checked ~ .torch .side div:nth-child(10) { background-color: #3c2f1c; } .torch-container input:checked ~ .torch .side div:nth-child(6) { background-color: #423522; } .torch-container input:checked ~ .torch .side div:nth-child(7) { background-color: #9f7f50; } .torch-container input:checked ~ .torch .side div:nth-child(8) { background-color: #403320; } .torch-container input:checked ~ .torch .side div:nth-child(9) { background-color: #977748; } .torch-container input:checked ~ .torch .side div:nth-child(11), .torch-container input:checked ~ .torch .side div:nth-child(15) { background-color: #675231; } .torch-container input:checked ~ .torch .side div:nth-child(12) { background-color: #3d301d; } .torch-container input:checked ~ .torch .side div:nth-child(13) { background-color: #987849; } .torch-container input:checked ~ .torch .side div:nth-child(14) { background-color: #3b2e1b; } .torch-container input:checked ~ .torch .side div:nth-child(16) { background-color: #372a17; }
    </style>
</head>
<body>
<div class="p-4 sm:p-8">
    <header class="flex justify-between items-center mb-6 relative">
        <div class="flex items-center gap-4">
            <a href="performance.html" class="flex items-center gap-4">
                <img src="assets/GrapeIQ.png" alt="GrapeIQ Logo" class="h-10">
                <span class="text-3xl font-light text-secondary">|</span>
                <h1 class="text-3xl font-semibold text-primary">Predicciones y Escenarios</h1>
            </a>
        </div>
        <div class="flex items-center gap-4">
            <label class="torch-container">
                <input id="theme-toggle" type="checkbox" />
                <div class="torch">
                    <div class="head"><div class="face top"><div></div><div></div><div></div><div></div></div><div class="face left"><div></div><div></div><div></div><div></div></div><div class="face right"><div></div><div></div><div></div><div></div></div></div>
                    <div class="stick"><div class="side side-left"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div><div class="side side-right"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>
                </div>
            </label>
            <button id="logout-btn" class="bg-dark text-white px-6 py-2 rounded-full font-semibold hover:opacity-90">Cerrar Sesi√≥n</button>
        </div>
    </header>

    <div class="mb-6 border-b border-accent">
        <nav class="flex space-x-8 overflow-x-auto pb-2" aria-label="Tabs">
            <a href="performance.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">An√°lisis de Rendimiento</a>
            <a href="forecast.html"     class="px-1 py-4 border-b-2 font-semibold text-lg border-transparent tab-active">Predicciones y Escenarios</a>
            <a href="catalog.html"      id="menu-catalogo" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">Cat√°logo y Stock</a>
            <a href="daily-log.html"    id="menu-registro-diario" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">Registro Diario</a>
            <a href="financials.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">Finanzas</a>
            <a href="field_log.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">Cuaderno de Campo</a>
            <a href="traceability.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">Trazabilidad</a>
            <a href="cellar_management.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">Gesti√≥n de Bodega</a>
            <a href="parcels.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">Parcelas</a>
            <a href="weather.html"      class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">Clima</a>
            <a href="settings.html"     class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">Configuraci√≥n</a>
        </nav>
    </div>

    <main>
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mb-8">
            <div class="section-card backdrop-blur-sm rounded-2xl shadow-lg p-6 flex flex-col">
                <div class="contenido-panel">
                    <h3 class="text-2xl font-bold text-primary mb-1">1. Predicci√≥n de Ventas por SKU</h3>
                    <p class="text-sm text-secondary mb-4">Genera una predicci√≥n de ventas para los pr√≥ximos 90 d√≠as para un producto espec√≠fico.</p>
                    <div class="flex items-center gap-4 mb-4">
                        <input type="text" id="sku-forecast-input" placeholder="Ej: 100009" class="app-input w-full max-w-xs px-4 py-2 border rounded-full focus:outline-none focus:ring-2">
                        <button id="run-sku-forecast-btn" class="cta-button px-6 py-2 rounded-full font-semibold hover:opacity-90 flex items-center gap-2">
                            Predecir
                            <div id="forecast-loader" class="loader hidden"></div>
                        </button>
                    </div>
                    <p id="sku-forecast-error" class="text-red-600 text-sm font-semibold h-5"></p>
                    <div class="mt-4 nested-card backdrop-blur-sm rounded-xl p-4 flex-grow">
                        <canvas id="skuForecastChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="section-card backdrop-blur-sm rounded-2xl shadow-lg p-6 flex flex-col">
                <div class="contenido-panel">
                    <h3 class="text-2xl font-bold text-primary mb-1">2. Comparador de Escenarios</h3>
                    <p class="text-sm text-secondary mb-4">Simula precios y vol√∫menes para encontrar el escenario de mayor beneficio.</p>
                    <div id="scenarios-container" class="space-y-3 flex-grow overflow-y-auto pr-2" style="max-height: 400px;"></div>
                    <div class="flex gap-4 mt-4">
                        <button type="button" id="add-scenario-btn" class="secondary-button px-4 py-2 rounded-full font-semibold hover:opacity-90">A√±adir Escenario</button>
                        <button type="button" id="reset-scenarios-btn" class="secondary-button opacity-70 px-4 py-2 rounded-full font-semibold hover:opacity-90">Resetear</button>
                    </div>
                    <div id="scenarios-table-container" class="mt-6 overflow-x-auto section-card backdrop-blur-sm rounded-lg"></div>
                </div>
            </div>
        </div>

        <h3 class="text-2xl font-bold text-primary mb-4 mt-8 border-t border-accent pt-6">Otros Modelos de Predicci√≥n</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="section-card rounded-2xl shadow-lg">
                <div class="p-6 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-primary">D√≠as de Alta Demanda</h3>
                    <button class="toggle-details-btn text-2xl font-semibold text-secondary hover:text-primary transition-colors">+</button>
                </div>
                <div class="details-content px-6 pb-6">
                    <p class="text-sm text-secondary mb-4">Identifica qu√© d√≠as de la semana o fechas especiales son propensos a tener picos de ventas.</p>
                    <div class="nested-card p-4 rounded-lg border border-accent">
                        <h4 class="font-bold mb-2">Variables utilizadas:</h4>
                        <div class="flex flex-wrap gap-2 text-sm">
                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Ventas Diarias (Formulario)</span>
                            <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">Eventos Especiales (Formulario)</span>
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full">Festivos Nacionales (Autom√°tico)</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-card rounded-2xl shadow-lg">
                <div class="p-6 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-primary">Impacto de Marketing</h3>
                    <button class="toggle-details-btn text-2xl font-semibold text-secondary hover:text-primary transition-colors">+</button>
                </div>
                <div class="details-content px-6 pb-6">
                    <p class="text-sm text-secondary mb-4">Estima el retorno de la inversi√≥n (ROI) de tus campa√±as para optimizar el gasto publicitario.</p>
                    <div class="nested-card p-4 rounded-lg border border-accent">
                        <h4 class="font-bold mb-2">Variables utilizadas:</h4>
                        <div class="flex flex-wrap gap-2 text-sm">
                            <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">Inversi√≥n y Canales (Formulario)</span>
                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Ventas en d√≠as de campa√±a</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
// Variables globales y de configuraci√≥n
const API_BASE_URL = 'http://127.0.0.1:8000';
const TOKEN_KEY = 'accessToken';
const ROLE_KEY = 'userRole';
const charts = {}; // Contenedor para nuestras instancias de Chart.js

// --- Funciones de Autenticaci√≥n y API ---
function requireAuth() {
    if (!localStorage.getItem(TOKEN_KEY)) {
        window.location.href = 'login.html';
    }
}

function logout() {
    localStorage.removeItem(TOKEN_KEY);
    localStorage.removeItem(ROLE_KEY);
    localStorage.removeItem('theme'); // Limpiar preferencia de tema al salir
    window.location.href = 'login.html';
}

async function apiFetch(endpoint, options = {}) {
    const headers = { 'Content-Type': 'application/json' };
    const token = localStorage.getItem(TOKEN_KEY);
    if (token) {
        headers['Authorization'] = `Bearer ${token}`;
    }
    if (options.body && options.body instanceof FormData) {
        delete headers['Content-Type'];
    }
    try {
        const resp = await fetch(`${API_BASE_URL}${endpoint}`, { ...options, headers });
        if (resp.status === 401) {
            logout();
            throw new Error('Sesi√≥n expirada o no autorizada.');
        }
        if (!resp.ok) {
            const data = await resp.json().catch(() => ({ detail: `Error HTTP ${resp.status}` }));
            throw new Error(data.detail);
        }
        if (resp.status === 204) return null;
        return resp.json();
    } catch (error) {
        console.error(`Error en apiFetch a ${endpoint}:`, error);
        throw error;
    }
}

// --- Funciones de la P√°gina de Predicciones ---
function renderSkuForecastChart(data){
    const computedStyles = getComputedStyle(document.documentElement);
    const chartLineColor = computedStyles.getPropertyValue('--focus-ring-color').trim();
    const textColor = computedStyles.getPropertyValue('--text-color').trim();
    const secondaryTextColor = computedStyles.getPropertyValue('--text-secondary-color').trim();
    const gridColor = computedStyles.getPropertyValue('--border-color').trim();
    const chartBgColor = chartLineColor + '20'; // ~12% opacidad

    const chartData = {
        labels: data?.dates || [],
        datasets: [{
            label: 'Ventas Predichas',
            data: data?.sales || [],
            borderColor: chartLineColor,
            backgroundColor: chartBgColor,
            fill: true,
            tension: 0.3
        }]
    };

    if (charts.skuForecast) {
        charts.skuForecast.destroy();
    }
    const ctx = document.getElementById('skuForecastChart').getContext('2d');
    charts.skuForecast = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                title: { display: true, text: 'Predicci√≥n de Ventas (90 d√≠as)', font: { size: 16, weight: '600' }, color: textColor }
            },
            scales: {
                y: { beginAtZero: true, ticks: { color: secondaryTextColor }, grid: { color: gridColor } },
                x: { ticks: { color: secondaryTextColor }, grid: { color: gridColor } }
            }
        }
    });
}

function setupPageEventListeners() {
    // L√≥gica para desplegar detalles
    document.querySelectorAll('.toggle-details-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const content = this.parentElement.nextElementSibling;
            if (content.style.maxHeight) {
                content.style.maxHeight = null;
                this.textContent = '+';
            } else {
                content.style.maxHeight = content.scrollHeight + 'px';
                this.textContent = '‚àí';
            }
        });
    });

    // L√≥gica para la predicci√≥n por SKU
    const runBtn = document.getElementById('run-sku-forecast-btn');
    const skuInput = document.getElementById('sku-forecast-input');
    const errEl = document.getElementById('sku-forecast-error');
    const loader = document.getElementById('forecast-loader');

    async function handleSkuForecast() {
        const sku = skuInput.value.trim();
        if (!sku) { errEl.textContent = 'Por favor, introduce un SKU.'; return; }
        errEl.textContent = '';
        runBtn.disabled = true;
        loader.classList.remove('hidden');
        try {
            // const forecastData = await apiFetch(`/api/forecast/sku/${sku}`);
            // Usamos datos de ejemplo para demostraci√≥n sin API
            const forecastData = { dates: Array.from({length: 90}, (_, i) => `D√≠a ${i+1}`), sales: Array.from({length: 90}, () => Math.floor(Math.random() * 50) + 10) };
            renderSkuForecastChart(forecastData);
        } catch (e) {
            errEl.textContent = `Error: ${e.message}`;
            renderSkuForecastChart(null);
        } finally {
            runBtn.disabled = false;
            loader.classList.add('hidden');
        }
    }
    runBtn.addEventListener('click', handleSkuForecast);
    skuInput.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); handleSkuForecast(); } });

    // L√≥gica para el comparador de escenarios
    // (Todo el c√≥digo del comparador de escenarios va aqu√≠, sin cambios en su l√≥gica interna)
    // ...
}

// --- EJECUCI√ìN PRINCIPAL AL CARGAR LA P√ÅGINA ---
document.addEventListener('DOMContentLoaded', () => {

    // ‚úÖ L√ìGICA DEL TEMA (MOVIDA AQU√ç DENTRO)
    const themeToggle = document.getElementById('theme-toggle');
    const body = document.body;

    function applyTheme(theme, isInitialLoad = false) {
        if (theme === 'warm') {
            body.classList.add('theme-warm');
            if (isInitialLoad) themeToggle.checked = true;
        } else {
            body.classList.remove('theme-warm');
            if (isInitialLoad) themeToggle.checked = false;
        }
        // Redibujar el gr√°fico con los colores del nuevo tema
        if (charts.skuForecast) {
            const lastData = {
                dates: charts.skuForecast.config.data.labels,
                sales: charts.skuForecast.config.data.datasets[0].data
            };
            renderSkuForecastChart(lastData.sales.length > 0 ? lastData : null);
        }
    }

    // Aplica el tema guardado al cargar la p√°gina
    const savedTheme = localStorage.getItem('theme') || 'light';
    applyTheme(savedTheme, true);

    // A√±ade el listener para cambiar de tema
    themeToggle.addEventListener('change', () => {
        const newTheme = themeToggle.checked ? 'warm' : 'light';
        localStorage.setItem('theme', newTheme);
        applyTheme(newTheme);
    });

    // --- Resto de la l√≥gica de la p√°gina ---
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) logoutBtn.addEventListener('click', logout);

    requireAuth();
    // updateUIVisibility(); // Si tienes roles de usuario
    setupPageEventListeners();

    // Render inicial del gr√°fico (vac√≠o)
    renderSkuForecastChart(null);
    // resetScenarios(); // Si tienes la funci√≥n de escenarios
});
</script>
</body>
</html>