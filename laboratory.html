<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Laboratorio y Enología - GrapeIQ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root { /* Tema Claro (Por Defecto) */
            --bg-color: #F8F7F4; --text-color: #1c1917; --text-secondary-color: #57534e;
            --header-bg-color: #292524; --tab-active-color: #5C1A33; --border-color: #e5e7eb;
            --card-bg: #FFFFFF; --modal-input-bg: #FFFFFF; --cta-button-bg: #5C1A33; --secondary-button-bg: #e5e7eb;
        }
        body { font-family: 'Montserrat', sans-serif; background-color: var(--bg-color); color: var(--text-color); }
        .tab-active { border-color: var(--tab-active-color) !important; color: var(--tab-active-color) !important; font-weight: 700; }
        .text-secondary { color: var(--text-secondary-color); } .bg-dark { background-color: var(--header-bg-color); }
        .border-accent { border-color: var(--border-color); } .card { background-color: var(--card-bg); }
        .modal-input { background-color: var(--modal-input-bg); border-color: var(--border-color); }
        .cta-button { background-color: var(--cta-button-bg); color: white; }
        .secondary-button { background-color: var(--secondary-button-bg); }
        .modal { display: none; } .modal-active { display: flex; }
    </style>
</head>
<body>
    <div class="p-4 sm:p-8">
        <header class="flex justify-between items-center mb-6">
            <a href="performance.html" class="flex items-center gap-4">
                <img src="assets/GrapeIQ.png" alt="GrapeIQ Logo" class="h-10">
                <span class="text-3xl font-light text-secondary">|</span>
                <h1 class="text-3xl font-semibold">Laboratorio</h1>
            </a>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <p class="font-bold text-lg">24°C</p>
                    <p class="text-sm text-secondary">Humedad: 65%</p>
                </div>
                <button id="logout-btn" class="bg-dark text-white px-6 py-2 rounded-full font-semibold hover:opacity-90">Cerrar Sesión</button>
            </div>
        </header>
        <div class="mb-8 border-b border-accent">
             <nav class="flex space-x-8 overflow-x-auto pb-2">
                <a href="performance.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">Análisis de Rendimiento</a>
                <a href="forecast.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">Predicciones</a>
                <a href="catalog.html" id="menu-catalogo" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">Catálogo</a>
                <a href="daily-log.html" id="menu-registro-diario" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">Registro Diario</a>
                <a href="financials.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">Finanzas</a>
                <a href="field_log.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">Cuaderno de Campo</a>
                <a href="traceability.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">Trazabilidad</a>
                <a href="cellar_management.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">Gestión de Bodega</a>
                <a href="laboratory.html" class="px-1 py-4 border-b-2 font-semibold text-lg tab-active">Laboratorio</a>
                <a href="parcels.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">Parcelas</a>
                <a href="weather.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">Clima</a>
                <a href="settings.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-primary border-transparent">Configuración</a>
            </nav>
        </div>

        <main class="space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="md:col-span-1">
                    <div class="card p-4 rounded-2xl shadow-lg">
                        <h2 class="text-xl font-bold mb-4">Lotes Activos</h2>
                        <div id="lots-list" class="space-y-2 max-h-[80vh] overflow-y-auto">
                            <p class="text-secondary text-center">Cargando lotes...</p>
                        </div>
                    </div>
                </div>
                <div class="md:col-span-3">
                    <div id="lot-detail-view" class="hidden">
                        <div class="card p-6 rounded-2xl shadow-lg flex justify-between items-start">
                            <div>
                                <h2 class="text-3xl font-bold" id="lot-name-title"></h2>
                                <p class="text-secondary mt-1" id="lot-details"></p>
                            </div>
                            <div class="flex flex-col items-end gap-2">
                                 <button id="add-analytic-btn" class="cta-button px-4 py-2 rounded-full font-semibold text-sm">Añadir Analítica</button>
                                 <button id="add-action-btn" class="secondary-button text-black px-4 py-2 rounded-full font-semibold text-sm">Registrar Acción</button>
                            </div>
                        </div>

                        <div id="vinification-section" class="mt-8 hidden">
                            <h3 class="text-2xl font-bold mb-4">Fase de Vinificación</h3>
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div class="lg:col-span-2 card p-6 rounded-2xl shadow-lg">
                                    <h4 class="text-xl font-bold mb-4">Historial y Controles</h4>
                                    <div id="vinification-history" class="space-y-4 max-h-[60vh] overflow-y-auto pr-4"></div>
                                </div>
                                <div class="space-y-8">
                                    <div id="vinification-containers" class="card p-6 rounded-2xl shadow-lg"></div>
                                    <div class="card p-6 rounded-2xl shadow-lg">
                                         <h4 class="text-xl font-bold mb-4">Curva de Fermentación</h4>
                                         <div id="fermentation-chart" style="width: 100%; height: 300px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="aging-section" class="mt-8 hidden">
                            <h3 class="text-2xl font-bold mb-4">Fase de Crianza</h3>
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div class="lg:col-span-2 card p-6 rounded-2xl shadow-lg">
                                    <h4 class="text-xl font-bold mb-4">Barricas Asignadas</h4>
                                    <div id="aging-containers" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                                </div>
                                 <div class="card p-6 rounded-2xl shadow-lg">
                                    <h4 class="text-xl font-bold mb-4">Historial de Analíticas</h4>
                                    <div id="aging-history" class="space-y-4 max-h-[60vh] overflow-y-auto pr-4"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="no-lot-selected" class="text-center py-20">
                        <i class="fas fa-vial text-6xl text-gray-300"></i>
                        <p class="mt-4 text-xl text-secondary">Selecciona un lote para ver sus detalles.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <div id="analytic-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center z-50"></div>
    <div id="action-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center z-50"></div>
    
    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000';
        const TOKEN_KEY = 'accessToken';
        let lotsCache = [];
        let selectedLotId = null;
        let fermentationChart = null;

        function requireAuth() { if (!localStorage.getItem(TOKEN_KEY)) window.location.href = 'login.html'; }
        function logout() { localStorage.clear(); window.location.href = 'login.html'; }
        
        async function apiFetch(endpoint, options = {}) {
            const headers = { 'Content-Type': 'application/json', Authorization: `Bearer ${localStorage.getItem(TOKEN_KEY)}` };
            const resp = await fetch(`${API_BASE_URL}${endpoint}`, { ...options, headers });
            if (resp.status === 401) { logout(); throw new Error('Sesión expirada.'); }
            if (!resp.ok) { const data = await resp.json().catch(() => ({ detail: `Error HTTP ${resp.status}` })); throw new Error(data.detail); }
            return resp.status === 204 ? null : resp.json();
        }

        function renderLotsList() {
            const listEl = document.getElementById('lots-list');
            if (lotsCache.length === 0) {
                listEl.innerHTML = '<p class="text-secondary text-center p-4">No hay lotes en vinificación o crianza.</p>';
                return;
            }
            listEl.innerHTML = lotsCache.map(lot => `
                <div class="border rounded-lg p-3 cursor-pointer hover:bg-gray-100 transition-colors ${lot.id === selectedLotId ? 'bg-indigo-100 border-indigo-400' : 'border-accent'}" data-lot-id="${lot.id}">
                    <p class="font-bold">${lot.name}</p>
                    <p class="text-sm text-secondary">${lot.status}</p>
                </div>
            `).join('');
        }

        function renderFermentationChart(controls) {
            const chartDom = document.getElementById('fermentation-chart');
            if (fermentationChart) {
                fermentationChart.dispose();
            }
            fermentationChart = echarts.init(chartDom);
            const option = {
                tooltip: { trigger: 'axis' },
                legend: { data: ['Temperatura', 'Densidad'] },
                xAxis: { type: 'category', data: controls.map(c => new Date(c.control_date).toLocaleDateString()) },
                yAxis: [
                    { type: 'value', name: 'Temp (°C)', position: 'left' },
                    { type: 'value', name: 'Densidad', position: 'right', axisLabel: { formatter: '{value}' } }
                ],
                series: [
                    { name: 'Temperatura', type: 'line', data: controls.map(c => c.temperature), yAxisIndex: 0 },
                    { name: 'Densidad', type: 'line', data: controls.map(c => c.density), yAxisIndex: 1 }
                ]
            };
            fermentationChart.setOption(option);
        }

        function renderHistory(containerId, title, data, renderer) {
            const container = document.getElementById(containerId);
            if (data.length === 0) {
                container.innerHTML = `<p class="text-secondary text-center p-4">No hay ${title.toLowerCase()} registrados.</p>`;
                return;
            }
            container.innerHTML = data.map(renderer).join('');
        }
        
        async function selectLot(lotId) {
            if (!lotId) return;
            selectedLotId = lotId;
            renderLotsList();

            const lotData = lotsCache.find(l => l.id === lotId);
            if (!lotData) return;

            document.getElementById('no-lot-selected').classList.add('hidden');
            document.getElementById('lot-detail-view').classList.remove('hidden');

            document.getElementById('lot-name-title').textContent = lotData.name;
            document.getElementById('lot-details').textContent = `Variedad: ${lotData.grape_variety || 'N/A'} | Año: ${lotData.vintage_year || 'N/A'} | Estado: ${lotData.status}`;
            
            const details = await apiFetch(`/api/laboratory/lot-details/${lotId}`);

            if (lotData.status === 'En Fermentación') {
                document.getElementById('vinification-section').classList.remove('hidden');
                document.getElementById('aging-section').classList.add('hidden');
                
                renderHistory('vinification-history', 'Controles', details.fermentation_controls, item => `
                    <div class="border-b pb-2">
                        <p class="font-bold">${new Date(item.control_date).toLocaleDateString('es-ES', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</p>
                        <p><strong>Temp:</strong> ${item.temperature}°C | <strong>Densidad:</strong> ${item.density} | <strong>Azúcar Res:</strong> ${item.residual_sugar || 'N/A'} g/L</p>
                        <p class="text-sm text-secondary">${item.notes || 'Sin notas'}</p>
                    </div>`);
                
                document.getElementById('vinification-containers').innerHTML = `<h4 class="text-xl font-bold mb-4">Depósitos</h4>${lotData.containers.map(c => `<p>${c.name} (${c.current_volume} L)</p>`).join('')}`;
                
                renderFermentationChart(details.fermentation_controls);

            } else if (lotData.status === 'En Crianza') {
                document.getElementById('vinification-section').classList.add('hidden');
                document.getElementById('aging-section').classList.remove('hidden');

                document.getElementById('aging-containers').innerHTML = lotData.containers.map(c => `
                    <div class="border p-2 rounded-lg">
                        <p class="font-bold">${c.name}</p>
                        <p class="text-sm">${c.material} (${c.cooperage || 'N/A'})</p>
                    </div>`).join('');
                
                renderHistory('aging-history', 'Analíticas', details.lab_analytics, item => `
                    <div class="border-b pb-2">
                        <p class="font-bold">${new Date(item.analysis_date).toLocaleDateString()}</p>
                        <p><strong>SO₂ Libre:</strong> ${item.free_so2} | <strong>SO₂ Total:</strong> ${item.total_so2}</p>
                        <p class="text-sm text-secondary">${item.notes || 'Sin notas'}</p>
                    </div>`);
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            requireAuth();
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            try {
                lotsCache = await apiFetch('/api/laboratory/lots');
                renderLotsList();
            } catch (e) {
                document.getElementById('lots-list').innerHTML = `<p class="text-red-500 p-4">${e.message}</p>`;
            }

            document.getElementById('lots-list').addEventListener('click', (e) => {
                const lotCard = e.target.closest('[data-lot-id]');
                if (lotCard) {
                    selectLot(lotCard.dataset.lotId);
                }
            });

            const urlParams = new URLSearchParams(window.location.search);
            const lotIdFromUrl = urlParams.get('lotId');
            if (lotIdFromUrl) {
                // Esperar a que los lotes se carguen antes de seleccionar
                const checkLotsExist = setInterval(() => {
                    if(lotsCache.length > 0) {
                        clearInterval(checkLotsExist);
                        selectLot(lotIdFromUrl);
                    }
                }, 100);
            }
        });
    </script>
</body>
</html>