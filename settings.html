<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Configuración - GrapeIQ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* --- Sistema de Temas --- */
        :root { /* Tema Blanco por Defecto */
            --bg-color: #F8F7F4;
            --text-color: #1c1917;
            --text-secondary-color: #57534e;
            --header-bg-color: #292524;
            --tab-active-color: #5C1A33;
            --cta-button-bg: #5C1A33;
            --secondary-button-bg: #e5e7eb;
            --secondary-button-text: #1c1917;
            --border-color: #e5e7eb;
            --card-bg: #FFFFFF;
            --card-bg-translucent: rgba(255, 255, 255, 0.9);
            --modal-input-bg: #f9fafb;
            --body-background-image: url('assets/pexels-ahmetyuksek-33771535.jpg');
            --wine-grad: linear-gradient(to right, #5C1A33, #8C2B4F);
        }

        body.theme-warm { /* 🍂 Tema Otoñal Cálido */
            --bg-color: #F2E2C4;
            --text-color: #5C4033;
            --text-secondary-color: #8C8C88;
            --header-bg-color: #5C4033;
            --tab-active-color: #C98C32;
            --cta-button-bg: #D96C06;
            --secondary-button-bg: #A23E48;
            --secondary-button-text: #FFFFFF;
            --border-color: rgba(92, 64, 51, 0.2);
            --card-bg: rgba(255, 255, 255, 0.7);
            --card-bg-translucent: rgba(255, 255, 255, 0.7);
            --modal-input-bg: rgba(92, 64, 51, 0.05);
            --body-background-image: url('assets/otoño.jpg');
            --wine-grad: linear-gradient(to right, #D96C06, #C98C32);
        }
        
        /* --- Estilos Generales con Variables --- */
        body { 
            font-family: 'Montserrat', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .body-background {
            background-image: var(--body-background-image);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .tab-active { border-color: var(--tab-active-color) !important; color: var(--tab-active-color) !important; font-weight: 700; }
        .text-secondary { color: var(--text-secondary-color); }
        .bg-dark { background-color: var(--header-bg-color); }
        .border-accent { border-color: var(--border-color); }
        .cta-button { background-color: var(--cta-button-bg); color: white; }
        .secondary-button { background-color: var(--secondary-button-bg); color: var(--secondary-button-text); }
        .card { background: var(--card-bg); backdrop-filter: saturate(120%) blur(8px); }
        .card-translucent { background-color: var(--card-bg-translucent); backdrop-filter: blur(12px); }
        .modal-input { background-color: var(--modal-input-bg); border-color: var(--border-color); }
        .wine-grad { background-image: var(--wine-grad); }
        .modal { display: none; }
        .modal-active { display: flex; }

        /* --- CSS DE LA ANTORCHA --- */
        .torch-container { position: absolute; right: 220px; top: -35px; display: flex; align-items: center; cursor: pointer; user-select: none; transform: scale(0.45); }
        .torch-container input { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
        .torch { display: flex; justify-content: center; height: 150px; }
        .head, .stick { position: absolute; width: 30px; transform-style: preserve-3d; transform: rotateX(-30deg) rotateY(45deg); }
        .stick { position: relative; height: 120px; }
        .face { position: absolute; transform-style: preserve-3d; width: 30px; height: 30px; display: grid; grid-template-columns: 50% 50%; grid-template-rows: 50% 50%; background-color: #000; }
        .top { transform: rotateX(90deg) translateZ(15px); } .left { transform: rotateY(-90deg) translateZ(15px); } .right { transform: rotateY(0deg) translateZ(15px); }
        .top div, .left div, .right div { width: 102%; height: 102%; }
        .top div:nth-child(1), .left div:nth-child(3), .right div:nth-child(3) { background-color: #ffff9760; } .top div:nth-child(2), .left div:nth-child(1), .right div:nth-child(1) { background-color: #ffd80060; } .top div:nth-child(3), .left div:nth-child(4), .right div:nth-child(4) { background-color: #ffffff60; } .top div:nth-child(4), .left div:nth-child(2), .right div:nth-child(2) { background-color: #ff8f0060; }
        .side { position: absolute; width: 30px; height: 120px; display: grid; grid-template-columns: 50% 50%; grid-template-rows: repeat(8, 12.5%); cursor: pointer; translate: 0 12px; }
        .side-left { transform: rotateY(-90deg) translateZ(15px) translateY(8px); } .side-right { transform: rotateY(0deg) translateZ(15px) translateY(8px); }
        .side-left div, .side-right div { width: 103%; height: 103%; }
        .side div:nth-child(1) { background-color: #443622; } .side div:nth-child(2) { background-color: #2e2517; } .side div:nth-child(3), .side div:nth-child(5) { background-color: #4b3b23; } .side div:nth-child(4), .side div:nth-child(10) { background-color: #251e12; } .side div:nth-child(6) { background-color: #292115; } .side div:nth-child(7) { background-color: #4b3c26; } .side div:nth-child(8) { background-color: #292115; } .side div:nth-child(9) { background-color: #4b3a21; } .side div:nth-child(11), .side div:nth-child(15) { background-color: #3d311d; } .side div:nth-child(12) { background-color: #2c2315; } .side div:nth-child(13) { background-color: #493a22; } .side div:nth-child(14) { background-color: #2b2114; } .side div:nth-child(16) { background-color: #271e10; }
        .torch-container input:checked ~ .torch .face { filter: drop-shadow(0px 0px 2px #fff) drop-shadow(0px 0px 10px rgba(255, 237, 156, 0.7)) drop-shadow(0px 0px 25px rgba(255, 227, 101, 0.4)); }
        .torch-container input:checked ~ .torch .top div:nth-child(1), .torch-container input:checked ~ .torch .left div:nth-child(3), .torch-container input:checked ~ .torch .right div:nth-child(3) { background-color: #ffff97; } .torch-container input:checked ~ .torch .top div:nth-child(2), .torch-container input:checked ~ .torch .left div:nth-child(1), .torch-container input:checked ~ .torch .right div:nth-child(1) { background-color: #ffd800; } .torch-container input:checked ~ .torch .top div:nth-child(3), .torch-container input:checked ~ .torch .left div:nth-child(4), .torch-container input:checked ~ .torch .right div:nth-child(4) { background-color: #fff; } .torch-container input:checked ~ .torch .top div:nth-child(4), .torch-container input:checked ~ .torch .left div:nth-child(2), .torch-container input:checked ~ .torch .right div:nth-child(2) { background-color: #ff8f00; } .torch-container input:checked ~ .torch .side div:nth-child(1) { background-color: #7c623e; } .torch-container input:checked ~ .torch .side div:nth-child(2) { background-color: #4c3d26; } .torch-container input:checked ~ .torch .side div:nth-child(3), .torch-container input:checked ~ .torch .side div:nth-child(5) { background-color: #937344; } .torch-container input:checked ~ .torch .side div:nth-child(4), .torch-container input:checked ~ .torch .side div:nth-child(10) { background-color: #3c2f1c; } .torch-container input:checked ~ .torch .side div:nth-child(6) { background-color: #423522; } .torch-container input:checked ~ .torch .side div:nth-child(7) { background-color: #9f7f50; } .torch-container input:checked ~ .torch .side div:nth-child(8) { background-color: #403320; } .torch-container input:checked ~ .torch .side div:nth-child(9) { background-color: #977748; } .torch-container input:checked ~ .torch .side div:nth-child(11), .torch-container input:checked ~ .torch .side div:nth-child(15) { background-color: #675231; } .torch-container input:checked ~ .torch .side div:nth-child(12) { background-color: #3d301d; } .torch-container input:checked ~ .torch .side div:nth-child(13) { background-color: #987849; } .torch-container input:checked ~ .torch .side div:nth-child(14) { background-color: #3b2e1b; } .torch-container input:checked ~ .torch .side div:nth-child(16) { background-color: #372a17; }
    </style>
</head>
<body>
    <div class="fixed inset-0 w-full h-full z-[-1] pointer-events-none body-background"></div>

    <div class="p-4 sm:p-8">
        <div class="card-translucent rounded-2xl shadow-lg mb-8">
            <header class="flex justify-between items-center p-6 relative">
                <div class="flex items-center gap-4">
                    <a href="performance.html" class="flex items-center gap-4">
                        <img src="assets/GrapeIQ.png" alt="GrapeIQ Logo" class="h-10">
                        <span class="text-3xl font-light text-secondary">|</span>
                        <h1 class="text-3xl font-semibold">Configuración</h1>
                    </a>
                </div>
                <div class="flex items-center gap-4">
                    <label class="torch-container">
                        <input id="theme-toggle" type="checkbox" />
                        <div class="torch">
                            <div class="head">
                                <div class="face top"><div></div><div></div><div></div><div></div></div>
                                <div class="face left"><div></div><div></div><div></div><div></div></div>
                                <div class="face right"><div></div><div></div><div></div><div></div></div>
                            </div>
                            <div class="stick">
                                <div class="side side-left"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
                                <div class="side side-right"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
                            </div>
                        </div>
                    </label>
                    <button id="logout-btn" class="bg-dark text-white px-6 py-2 rounded-full font-semibold hover:opacity-90">Cerrar Sesión</button>
                </div>
            </header>

            <div class="border-t border-accent px-6">
                <nav class="flex space-x-8 overflow-x-auto" aria-label="Tabs">
                    <a href="performance.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-text-color border-transparent">Análisis de Rendimiento</a>
                    <a href="forecast.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-text-color border-transparent">Predicciones</a>
                    <a href="catalog.html" id="menu-catalogo" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-text-color border-transparent">Catálogo y Stock</a>
                    <a href="daily-log.html" id="menu-registro-diario" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-text-color border-transparent">Registro Diario</a>
                    <a href="financials.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-text-color border-transparent">Finanzas</a>
                    <a href="field_log.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-text-color border-transparent">Cuaderno de Campo</a>
                    <a href="traceability.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-text-color border-transparent">Trazabilidad</a>
                    <a href="cellar_management.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-text-color border-transparent">Gestión de Bodega</a>
                    <a href="parcels.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-text-color border-transparent">Parcelas</a>
                    <a href="weather.html" class="px-1 py-4 border-b-2 font-semibold text-lg text-secondary hover:text-text-color border-transparent">Clima</a>
                    <a href="settings.html" class="px-1 py-4 border-b-2 font-semibold text-lg tab-active">Configuración</a>
                </nav>
            </div>
        </div>
        
        <main>
            <div class="max-w-[1200px] mx-auto card-translucent rounded-3xl shadow-2xl p-10 border border-accent space-y-12">
                
                <div>
                    <h2 class="text-3xl font-extrabold mb-8 tracking-tight text-center">Configuración de Cuenta</h2>
                    <div class="flex flex-col lg:flex-row gap-10">
                        <div class="flex-1 flex flex-col gap-10">
                            <section class="card rounded-2xl shadow p-8 border border-accent flex flex-col justify-between min-h-[420px]">
                                <div>
                                    <h3 class="text-xl font-semibold mb-4">Perfil</h3>
                                    <form id="profile-form" class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-semibold mb-1 text-secondary" for="username">Nombre / Email (login)</label>
                                            <input type="text" id="username" name="username" class="w-full p-3 rounded-lg border modal-input" placeholder="tu@email.com" autocomplete="username">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold mb-1 text-secondary" for="role">Rol</label>
                                            <select id="role" name="role" class="w-full p-3 rounded-lg border modal-input">
                                                <option value="admin">Administrador</option>
                                                <option value="lector">Lector</option>
                                            </select>
                                        </div>
                                        <button type="submit" class="wine-grad text-white px-6 py-2 rounded-full font-bold hover:opacity-90 transition-opacity w-full">Guardar Cambios</button>
                                        <p id="success-message" class="mt-2 text-center text-green-600 font-semibold h-4"></p>
                                        <p id="error-message" class="mt-2 text-center text-red-600 font-semibold h-4"></p>
                                    </form>
                                </div>
                            </section>
                            <section class="card rounded-2xl shadow p-8 border border-accent flex flex-col justify-between">
                                <h3 class="text-xl font-semibold mb-4">Personalización</h3>
                                <div class="space-y-4">
                                    <div>
                                        <h4 class="font-semibold">Tema de la Aplicación</h4>
                                        <p class="text-sm text-secondary">Selecciona tu tema preferido.</p>
                                        <div class="mt-2 flex items-center gap-4">
                                            <span id="theme-status" class="font-semibold"></span>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        </div>
                        <div class="flex-1 flex flex-col gap-10">
                            <section class="flex flex-col justify-center">
                                <div class="w-full card rounded-2xl shadow-xl p-8 border border-accent">
                                    <div class="flex flex-col items-center mb-6">
                                        <div class="bg-[#8C2B4F]/10 rounded-full p-3 mb-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" style="color: var(--tab-active-color);" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c1.104 0 2-.896 2-2V7a2 2 0 10-4 0v2c0 1.104.896 2 2 2zm0 0v2m0 4h.01"/></svg>
                                        </div>
                                        <h3 class="text-xl font-semibold mb-1">Cambiar contraseña</h3>
                                        <p class="text-secondary text-sm text-center">Por seguridad, confirma tu contraseña actual.</p>
                                    </div>
                                    <form id="password-form" class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium mb-1 text-secondary" for="current-password">Contraseña actual</label>
                                            <input type="password" id="current-password" class="w-full p-3 rounded-lg border modal-input" autocomplete="current-password">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1 text-secondary" for="new-password">Nueva contraseña</label>
                                            <input type="password" id="new-password" class="w-full p-3 rounded-lg border modal-input" placeholder="Mínimo 12 caracteres" autocomplete="new-password">
                                        </div>
                                        <button type="submit" class="w-full wine-grad text-white py-3 rounded-full font-bold text-lg">Guardar nueva contraseña</button>
                                    </form>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>

                <div class="border-t border-accent pt-12">
                    <h2 class="text-3xl font-extrabold mb-8 tracking-tight text-center">Configuración de Costes</h2>
                    <div class="card rounded-2xl shadow p-8 border border-accent">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">Parámetros de Coste Maestros</h3>
                            <button id="add-parameter-btn" class="cta-button px-5 py-2 rounded-full font-semibold hover:opacity-90">Añadir Parámetro</button>
                        </div>
                        <p class="text-sm text-secondary mb-4">Define aquí los costes maestros de tu bodega para automatizar los cálculos de rentabilidad.</p>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="border-b-2 border-accent">
                                        <th class="p-3">Nombre del Parámetro</th>
                                        <th class="p-3">Valor</th>
                                        <th class="p-3">Unidad</th>
                                        <th class="p-3">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="parameters-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="mt-12">
                    <h3 class="text-xl font-semibold mb-4 text-red-700">Zona peligrosa</h3>
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div>
                            <div class="font-bold text-red-700">Eliminar cuenta</div>
                            <div class="text-red-600 text-sm mt-1">Esta acción es irreversible. Todos tus datos serán eliminados.</div>
                        </div>
                        <button id="delete-account-btn" class="bg-red-600 text-white px-6 py-2 rounded-full font-bold hover:bg-red-700 transition-colors">Eliminar Cuenta</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <div id="parameter-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md m-4">
            <h3 id="parameter-modal-title" class="text-2xl font-bold mb-6"></h3>
            <form id="parameter-modal-form" class="space-y-4">
                <input type="hidden" id="parameter-id" name="id">
                <div>
                    <label class="block text-sm">Nombre del Parámetro</label>
                    <input type="text" id="parameter_name" name="parameter_name" required class="w-full mt-1 p-2 border rounded modal-input" placeholder="Ej: coste_corcho_premium">
                </div>
                <div>
                    <label class="block text-sm">Valor</label>
                    <input type="number" step="0.01" id="value" name="value" required class="w-full mt-1 p-2 border rounded modal-input" placeholder="Ej: 0.15">
                </div>
                <div>
                    <label class="block text-sm">Unidad</label>
                    <input type="text" id="unit" name="unit" class="w-full mt-1 p-2 border rounded modal-input" placeholder="Ej: EUR/unidad, EUR/hora">
                </div>
            </form>
            <div class="flex justify-end gap-4 mt-8">
                <button type="button" id="close-parameter-modal-btn" class="secondary-button px-5 py-2 rounded-full font-semibold">Cancelar</button>
                <button type="submit" form="parameter-modal-form" class="cta-button text-white px-5 py-2 rounded-full font-semibold">Guardar</button>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000';
        const TOKEN_KEY = 'accessToken';
        const ROLE_KEY = 'userRole';

        // --- LÓGICA DEL TEMA ---
        const themeToggle = document.getElementById('theme-toggle');
        const body = document.body;
        const themeStatus = document.getElementById('theme-status');
        const bodyBackground = document.querySelector('.body-background');

        function applyTheme(theme) {
            if (theme === 'warm') {
                body.classList.add('theme-warm');
                themeToggle.checked = true;
                if(themeStatus) themeStatus.textContent = 'Tema Cálido (Otoñal)';
            } else {
                body.classList.remove('theme-warm');
                themeToggle.checked = false;
                if(themeStatus) themeStatus.textContent = 'Tema Claro (Por defecto)';
            }
        }
        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);
        themeToggle.addEventListener('change', () => {
            const newTheme = themeToggle.checked ? 'warm' : 'light';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });

        // --- AUTENTICACIÓN Y API ---
        function requireAuth() { if (!localStorage.getItem(TOKEN_KEY)) window.location.href = 'login.html'; }
        function logout() { localStorage.removeItem(TOKEN_KEY); localStorage.removeItem(ROLE_KEY); localStorage.removeItem('theme'); window.location.href = 'login.html'; }
        async function apiFetch(endpoint, options = {}) {
            if (!endpoint.endsWith('/')) { endpoint += '/'; }
            const headers = { ...options.headers };
            const token = localStorage.getItem(TOKEN_KEY);
            if (token) headers['Authorization'] = `Bearer ${token}`;
            if (options.body && !(options.body instanceof FormData)) {
                headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(options.body);
            }
            const resp = await fetch(`${API_BASE_URL}${endpoint}`, { ...options, headers });
            if (resp.status === 401) { logout(); throw new Error('Sesión expirada.'); }
            if (resp.status === 204) return null;
            if (!resp.ok) {
                const data = await resp.json().catch(() => ({ detail: 'Error en la petición.' }));
                throw new Error(data.detail);
            }
            return resp.json();
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            requireAuth();
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            // --- LÓGICA DE PERFIL DE USUARIO ---
            const profileForm = document.getElementById('profile-form');
            const usernameInput = document.getElementById('username');
            const roleInput = document.getElementById('role');
            const successMessage = document.getElementById('success-message');
            const errorMessage = document.getElementById('error-message');

            async function loadUserData() {
                try {
                    const user = await apiFetch('/api/users/me'); 
                    usernameInput.value = user.username || '';
                    roleInput.value = user.role || 'lector';
                } catch (error) {
                    errorMessage.textContent = 'Error al cargar los datos del usuario.';
                    console.error(error);
                }
            }

            profileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                // Aquí iría la lógica para guardar el perfil si fuera editable
            });
            
            // --- LÓGICA DE PARÁMETROS DE COSTE ---
            const paramModal = document.getElementById('parameter-modal');
            const paramModalTitle = document.getElementById('parameter-modal-title');
            const paramModalForm = document.getElementById('parameter-modal-form');
            const addParameterBtn = document.getElementById('add-parameter-btn');
            const closeParameterModalBtn = document.getElementById('close-parameter-modal-btn');
            const tableBody = document.getElementById('parameters-table-body');
            let parametersCache = [];

            async function loadParameters() {
                try {
                    parametersCache = await apiFetch('/api/financials/cost-parameters');
                    renderParametersTable();
                } catch (error) {
                    tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-red-500 p-4">Error al cargar parámetros: ${error.message}</td></tr>`;
                }
            }

            function renderParametersTable() {
                if (parametersCache.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-secondary p-4">No hay parámetros de coste definidos.</td></tr>`;
                    return;
                }
                tableBody.innerHTML = parametersCache.map(p => `
                    <tr class="border-b border-accent">
                        <td class="p-3 font-semibold">${p.parameter_name}</td>
                        <td class="p-3">${p.value}</td>
                        <td class="p-3">${p.unit || ''}</td>
                        <td class="p-3">
                            <button class="text-blue-600 hover:underline mr-4 edit-btn" data-id="${p.id}"><i class="fas fa-pencil-alt"></i></button>
                            <button class="text-red-600 hover:underline delete-btn" data-id="${p.id}"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>`).join('');
            }

            function openParameterModal(param = null) {
                paramModalForm.reset();
                if (param) {
                    paramModalTitle.textContent = 'Editar Parámetro de Coste';
                    document.getElementById('parameter-id').value = param.id;
                    document.getElementById('parameter_name').value = param.parameter_name;
                    document.getElementById('value').value = param.value;
                    document.getElementById('unit').value = param.unit || '';
                } else {
                    paramModalTitle.textContent = 'Añadir Nuevo Parámetro';
                    document.getElementById('parameter-id').value = '';
                }
                paramModal.classList.add('modal-active');
            }

            addParameterBtn.addEventListener('click', () => openParameterModal());
            closeParameterModalBtn.addEventListener('click', () => paramModal.classList.remove('modal-active'));

            paramModalForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('parameter-id').value;
                const body = {
                    parameter_name: document.getElementById('parameter_name').value,
                    value: parseFloat(document.getElementById('value').value),
                    unit: document.getElementById('unit').value
                };
                const endpoint = id ? `/api/financials/cost-parameters/${id}` : '/api/financials/cost-parameters';
                const method = id ? 'PUT' : 'POST';
                try {
                    await apiFetch(endpoint, { method, body });
                    paramModal.classList.remove('modal-active');
                    await loadParameters();
                } catch (error) {
                    alert(`Error al guardar: ${error.message}`);
                }
            });

            tableBody.addEventListener('click', async (e) => {
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');
                if (editBtn) {
                    const param = parametersCache.find(p => p.id === editBtn.dataset.id);
                    if (param) openParameterModal(param);
                }
                if (deleteBtn) {
                    const paramId = deleteBtn.dataset.id;
                    if (confirm('¿Estás seguro de que quieres eliminar este parámetro?')) {
                        try {
                            await apiFetch(`/api/financials/cost-parameters/${paramId}`, { method: 'DELETE' });
                            await loadParameters();
                        } catch (error) {
                            alert(`Error al eliminar: ${error.message}`);
                        }
                    }
                }
            });

            // --- INICIALIZACIÓN DE LA PÁGINA ---
            loadUserData();
            loadParameters();
        });
    </script>
</body>
</html>